!function(e,t){"use strict";const n=e.USO||{},o=n.MATERIALS||{},i=e.USO_CANVAS,a=e.USO_CALC,r=e.USO_EXPORT,l=n.DEBUG_CANVAS||{log:function(){},warn:function(...e){console.warn(...e)},error:function(...e){console.error(...e)}},s="uso_autosave";let c=[],u=0,d="",p=null,m=!1;function h(e){const t=document.createElement("div");return t.textContent=String(e||""),t.innerHTML}let g=null;function f(){const e=document.getElementById("uso-mode-info");if(!e)return;const t=i&&i.getWorkMode?i.getWorkMode():"panoramic";"simple"===t||i&&t===i.MODES.SIMPLE?e.innerHTML='\n        <div style="background: #f3e5f5; padding: 12px; border-radius: 4px; font-size: 13px; color: #6a1b9a;">\n          <strong>üì∑ –†–µ–∂–∏–º –ø—Ä–æ—Å—Ç—ã—Ö —Ñ–æ—Ç–æ (–≤–µ—Ä—Ö–Ω—è—è/–Ω–∏–∂–Ω—è—è —á–µ–ª—é—Å—Ç—å)</strong><br>\n          <span style="font-size: 12px;">\n            üëÜ 1-–π —Å–Ω–∏–º–æ–∫ (–≤–µ—Ä—Ö–Ω—è—è): –ø–æ–ª–Ω–∞—è —Ä–∞–∑–º–µ—Ç–∫–∞<br>\n            üëá 2-–π —Å–Ω–∏–º–æ–∫ (–Ω–∏–∂–Ω—è—è): –ø–æ–ª–Ω–∞—è —Ä–∞–∑–º–µ—Ç–∫–∞<br>\n            üìù –û—Å—Ç–∞–ª—å–Ω—ã–µ: —Ç–æ–ª—å–∫–æ —Ä–∏—Å–æ–≤–∞–Ω–∏–µ\n          </span>\n        </div>\n      ':e.innerHTML='\n        <div style="background: #e3f2fd; padding: 12px; border-radius: 4px; font-size: 13px; color: #1565c0;">\n          <strong>üì∏ –†–µ–∂–∏–º –ø–∞–Ω–æ—Ä–∞–º–Ω—ã—Ö —Å–Ω–∏–º–∫–æ–≤</strong><br>\n          <span style="font-size: 12px;">\n            ‚úÖ 1-–π —Å–Ω–∏–º–æ–∫: –ø–æ–ª–Ω–∞—è —Ä–∞–∑–º–µ—Ç–∫–∞ (–º–µ—Ç–∫–∏ + —Ä–∏—Å–æ–≤–∞–Ω–∏–µ)<br>\n            üìù –û—Å—Ç–∞–ª—å–Ω—ã–µ: —Ç–æ–ª—å–∫–æ —Ä–∏—Å–æ–≤–∞–Ω–∏–µ (–±–µ–∑ –º–µ—Ç–æ–∫)\n          </span>\n        </div>\n      '}function y(){const t=document.getElementById("uso-file");t?(l.log("[USO] Initializing multi-image system..."),t.addEventListener("change",async function(t){try{const a=t.target.files?.[0];if(!a)return;l.log("[USO] File selected:",a.name,"size:",a.size);if(!(["image/jpeg","image/png","image/webp","image/heic","image/heif"].includes(a.type)||/\.(jpg|jpeg|png|webp|heic|heif)$/i.test(a.name||"")))return alert("–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ JPEG, PNG, WebP, HEIC"),void(t.target.value="");if(a.size>41943040)return alert("–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (>40 –ú–ë)"),void(t.target.value="");let r=a;if(/hei[cf]/i.test(a.type)||/\.heic$/i.test(a.name||""))try{l.log("[USO] Converting HEIC...");const t=await async function(){if(e.heic2any)return e.heic2any;const t=(n.ASSETS||{}).vendor_heic2any||"https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js";return await function(e){return new Promise(function(t,n){const o=document.createElement("script");o.src=e,o.async=!0,o.onload=t,o.onerror=n,document.head.appendChild(o)})}(t),e.heic2any}();t&&(r=await t({blob:a,toType:"image/jpeg",quality:.98}),l.log("[USO] HEIC converted successfully"))}catch(e){return console.warn("[USO] HEIC convert failed:",e),alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å HEIC"),void(t.target.value="")}let s=1;try{s=await exifr.orientation(r)||1,l.log("[USO] EXIF orientation:",s)}catch(e){console.warn("[USO] EXIF read failed:",e)}const c=URL.createObjectURL(r);l.log("[USO] Created blob URL");const u=await(o=c,new Promise(function(e,t){const n=new Image;n.onload=function(){e(n)},n.onerror=function(){t(new Error("image load error"))},n.crossOrigin="anonymous",n.src=o}));l.log("[USO] Image loaded, dimensions:",u.naturalWidth,"x",u.naturalHeight);const d=function(e,t){const n=e.naturalWidth||e.width,o=e.naturalHeight||e.height,i=document.createElement("canvas"),a=i.getContext("2d");3===t?(i.width=n,i.height=o,a.translate(n,o),a.rotate(Math.PI)):6===t?(i.width=o,i.height=n,a.translate(o,0),a.rotate(Math.PI/2)):8===t?(i.width=o,i.height=n,a.translate(0,n),a.rotate(-Math.PI/2)):(i.width=n,i.height=o);return a.imageSmoothingEnabled=!0,a.imageSmoothingQuality="high",a.drawImage(e,0,0,n,o,0,0,i.width,i.height),i.toDataURL("image/png",.98)}(u,s);l.log("[USO] Created data URL, size:",Math.round(d.length/1024),"KB"),URL.revokeObjectURL(c);const p=i&&i.getWorkMode?i.getWorkMode():"panoramic";let m="–°–Ω–∏–º–æ–∫",h=null;if("simple"===p||i&&p===i.MODES.SIMPLE){const e=i&&i.getAllImages?i.getAllImages().length:0;0===e?(m="üëÜ –í–µ—Ä—Ö–Ω—è—è —á–µ–ª—é—Å—Ç—å",h="upper",l.log("[USO] SIMPLE mode: adding upper jaw image")):1===e?(m="üëá –ù–∏–∂–Ω—è—è —á–µ–ª—é—Å—Ç—å",h="lower",l.log("[USO] SIMPLE mode: adding lower jaw image")):(m="üìé –î–æ–ø. —Å–Ω–∏–º–æ–∫ "+(e-1),l.log("[USO] SIMPLE mode: adding additional image",e-1))}else{const e=i&&i.getAllImages?i.getAllImages().length:0;m=`–ü–∞–Ω–æ—Ä–∞–º–Ω—ã–π —Å–Ω–∏–º–æ–∫ ${e+1}`,l.log("[USO] PANORAMIC mode: adding image",e+1)}if(!i||!i.addImage)return console.error("[USO] CANVAS.addImage not available"),void(t.target.value="");i.addImage(d,m,h),l.log("[USO] Image added to CANVAS:",m);const g=i&&i.getAllImages?i.getAllImages():[];l.log("[USO] Total images now:",g.length),1===g.length&&i&&i.switchImage&&(i.switchImage(0),l.log("[USO] Switched to first image")),i&&i.updateImageNavigation&&(i.updateImageNavigation(),l.log("[USO] Image navigation updated")),P(),l.log("[USO] Recompute triggered"),t.target.value=""}catch(e){console.error("[USO] Image load error:",e),alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ:\n\n"+e.message),t.target.value=""}var o})):console.warn("[USO] File input not found")}async function v(){if(l.log("[USO] Initializing application..."),i){try{document.getElementById("uso-work-mode")?(l.log("[USO] Work mode selector found"),function(){const e=document.getElementById("uso-work-mode");e?(l.log("[USO] Initializing work modes..."),e.addEventListener("change",function(){const e=this.value;l.log("[USO] Work mode changed to:",e),i&&i.setWorkMode&&i.setWorkMode(e);const t=document.getElementById("uso-images-nav");t&&(t.innerHTML="");const n=document.getElementById("uso-file");n&&(n.value=""),f(),P()}),i&&i.setWorkMode&&(i.setWorkMode(i.MODES.PANORAMIC),l.log("[USO] Initial mode set to PANORAMIC"))):console.warn("[USO] Work mode selector not found")}(),f()):(console.warn("[USO] Work mode selector not found, using default PANORAMIC"),i&&i.setWorkMode&&i.setWorkMode(i.MODES.PANORAMIC))}catch(e){console.error("[USO] Failed to initialize work modes:",e)}try{y(),l.log("[USO] Multi-image system initialized")}catch(e){console.error("[USO] Failed to initialize multi-image system:",e)}if(function(){if(t("#uso-dynamic-styles").length)return;const e=n.MATERIALS&&n.MATERIALS.mc||[],o=n.MATERIALS&&n.MATERIALS.zr||[],i=n.MATERIALS&&n.MATERIALS.prosthesis||[],a=e.length||1,r=o.length||1,l=i.length||1,s=`\n      <style id="uso-dynamic-styles">\n        .uso-materials-grid.mc-grid { \n          display: grid;\n          grid-template-columns: repeat(${Math.min(a,3)}, 1fr); \n          gap: 8px;\n        }\n        .uso-materials-grid.zr-grid { \n          display: grid;\n          grid-template-columns: repeat(${Math.min(r,3)}, 1fr); \n          gap: 8px;\n        }\n        #uso-prosthesis-matrix { \n          display: grid; \n          grid-template-columns: repeat(${Math.min(l,4)}, 1fr); \n          gap: 8px; \n        }\n        @media (max-width: 768px) {\n          .uso-materials-grid.mc-grid,\n          .uso-materials-grid.zr-grid { \n            grid-template-columns: 1fr; \n          }\n          #uso-prosthesis-matrix { \n            grid-template-columns: repeat(2, 1fr); \n          }\n        }\n        @media (max-width: 480px) {\n          #uso-prosthesis-matrix { \n            grid-template-columns: 1fr; \n          }\n        }\n      </style>\n    `;t("head").append(s)}(),i.initCanvas(function(){c.length&&(P(),H())}),function(){const e=document.getElementById("uso-canvas-container"),t=document.getElementById("uso-palette-panel");if(!e||!t)return;const n=t.parentNode;let o=t.nextSibling;function i(){if(t.parentNode!==n)try{o&&o.parentNode===n?n.insertBefore(t,o):n.appendChild(t)}catch(e){n.appendChild(t)}}function a(){t.parentNode!==e&&e.appendChild(t)}function r(){const t=document.fullscreenElement||document.webkitFullscreenElement||null;return t&&t===e}function l(){r()?a():i()}document.addEventListener("fullscreenchange",l),document.addEventListener("webkitfullscreenchange",l),document.addEventListener("uso:fsToggle",function(e){!!(e&&e.detail&&e.detail.isFs)?a():i()})}(),t("#uso-add-variant").on("click",b),function(){try{const e=localStorage.getItem(s);if(!e)return;let n;try{n=JSON.parse(e)}catch(e){return console.warn("[USO] Failed to parse autosave:",e),void localStorage.removeItem(s)}if(!n||"object"!=typeof n)return console.warn("[USO] Invalid autosave state"),void localStorage.removeItem(s);if(!n.timestamp||"number"!=typeof n.timestamp)return console.warn("[USO] Invalid autosave timestamp"),void localStorage.removeItem(s);const o=Date.now()-n.timestamp;if(o>864e5)return void localStorage.removeItem(s);if(!confirm("–ù–∞–π–¥–µ–Ω–æ –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ("+Math.round(o/6e4)+" –º–∏–Ω –Ω–∞–∑–∞–¥). –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å?"))return void localStorage.removeItem(s);if(!Array.isArray(n.variants)||0===n.variants.length)return console.warn("[USO] Invalid autosave state: no variants"),void localStorage.removeItem(s);for(let e of n.variants){if(!e||"object"!=typeof e||!e.title)return console.warn("[USO] Invalid variant in autosave"),void localStorage.removeItem(s);e.notes||(e.notes={therapy:"",crowns:"",impl:""}),e.selections||(e.selections=I()),e.selectedMats||(e.selectedMats=M()),e.data||(e.data={v:2,items:[],meta:{}})}c=n.variants,u=Math.max(0,Math.min(n.activeVar||0,c.length-1)),n.patientName&&"string"==typeof n.patientName&&t("#uso-patient-name").val(n.patientName),n.patientPhone&&"string"==typeof n.patientPhone&&t("#uso-patient-phone").val(n.patientPhone),t("#uso-variants-bar").empty(),c.forEach((e,t)=>w(t,e.title)),_(u),O(),localStorage.removeItem(s)}catch(e){console.error("[USO] Restore autosave failed:",e);try{localStorage.removeItem(s)}catch(e){}}}(),b(),!n.OPT||!n.OPT.pdf_template_html||0===String(n.OPT.pdf_template_html).trim().length)try{if("function"==typeof fetch&&n.ASSETS&&n.ASSETS.pdf_template_url){const e=await fetch(n.ASSETS.pdf_template_url,{credentials:"same-origin"});e.ok&&(n.OPT.pdf_template_html=await e.text())}}catch(e){}!function(){const e=document.querySelector(".impl-opts");if(!e)return;const t=(x()||{}).selections||I(),n=o.implants||[],i=o.impl_crowns||[],a=o.impl_bridges||[];let r="";n.length&&(r+='<div class="card"><b>–ò–º–ø–ª–∞–Ω—Ç—ã</b><div>',n.forEach(e=>{const n=t.implBrand===e.admin_key?"checked":"";r+='<label style="display:block;margin:2px 0;"><input type="radio" name="uso-impl-brand" value="'+h(e.admin_key)+'" '+n+"> "+h(e.label||e.admin_key)+"</label>"}),r+="</div></div>");if(i.length){r+='<div class="card"><b>–ö–æ—Ä–æ–Ω–∫–∏ –Ω–∞ –∏–º–ø–ª–∞–Ω—Ç—ã</b><div>';const e=Array.isArray(t.implCrown)?t.implCrown:t.implCrown?[t.implCrown]:[];i.forEach(t=>{const n=e.includes(t.admin_key)?"checked":"";r+='<label style="display:block;margin:2px 0;"><input type="checkbox" name="uso-impl-crown-mat" value="'+h(t.admin_key)+'" '+n+"> "+h(t.label||t.admin_key)+"</label>"}),r+="</div></div>"}a.length&&(r+='<div class="card"><b>–ú–æ—Å—Ç –º–µ–∂–¥—É –∏–º–ø–ª–∞–Ω—Ç–∞–º–∏</b><div>',a.forEach(e=>{const n=t.implBridge===e.admin_key?"checked":"";r+='<label style="display:block;margin:2px 0;"><input type="radio" name="uso-impl-bridge" value="'+h(e.admin_key)+'" '+n+"> "+h(e.label||e.admin_key)+"</label>"}),r+="</div></div>");e.innerHTML=r}(),C(),g=n.util.throttle(P,300),t(document).on("change","input.uso-mat",function(){try{const e=this.getAttribute("data-key");if(!e)return;const t=x();if(!t)return;t.selectedMats[e]=this.checked,g()}catch(e){console.error("[USO] Material change error:",e)}}),t(document).on("change",'input[name="uso-impl-brand"]',function(){try{const e=x();if(!e)return;e.selections.implBrand=this.value,g()}catch(e){console.error("[USO] Impl brand change error:",e)}}),t(document).on("change",'input[name="uso-impl-crown-mat"]',function(){try{const e=x();if(!e)return;const n=t('input[name="uso-impl-crown-mat"]:checked').map(function(){return this.value}).get();e.selections.implCrown=n,g()}catch(e){console.error("[USO] Impl crown change error:",e)}}),t(document).on("change",'input[name="uso-impl-bridge"]',function(){try{const e=x();if(!e)return;e.selections.implBridge=this.value,g()}catch(e){console.error("[USO] Impl bridge change error:",e)}}),t(document).on("change",".pmx-chk",function(){try{const e=this.getAttribute("data-side"),t=this.getAttribute("data-color"),n=this.getAttribute("data-key");if(!e||!t||!n)return;const o=x();if(!o)return;o.selections.prosthesisMulti=o.selections.prosthesisMulti||{top:{},bottom:{}};const i=o.selections.prosthesisMulti[e],a=Array.isArray(i[t])?i[t]:[],r=a.indexOf(n);this.checked&&r<0&&a.push(n),!this.checked&&r>=0&&a.splice(r,1),i[t]=a,g()}catch(e){console.error("[USO] Prosthesis change error:",e)}}),t("#uso-note-therapy").on("input",function(){const e=x();e&&(e.notes.therapy=this.value)}),t("#uso-note-crowns").on("input",function(){const e=x();e&&(e.notes.crowns=this.value)}),t("#uso-note-implants").on("input",function(){const e=x();e&&(e.notes.impl=this.value)}),t("#uso-export-json").on("click",D),t("#uso-import-json").on("change",z),t("#uso-png").on("click",function(){if(m)return;if(!i.hasImage())return void alert("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å–Ω–∏–º–æ–∫");const e=i.canvasImage(),t=$()+".png",n=document.createElement("a");n.href=e,n.download=t,document.body.appendChild(n),n.click(),document.body.removeChild(n)}),t("#uso-pdf").on("click",function(){N(j,"#uso-pdf")}),t("#uso-txt").on("click",function(){N(T,"#uso-txt")}),t("#uso-wa").on("click",function(){N(B,"#uso-wa")}),t("#uso-tg").on("click",function(){N(F,"#uso-tg")}),t("#uso-clear-all").on("click",function(){i.hasImage()?confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –º–µ—Ç–∫–∏ –Ω–∞ —Ç–µ–∫—É—â–µ–º –≤–∞—Ä–∏–∞–Ω—Ç–µ?")&&(i.resetMarkers(),P()):alert("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å–Ω–∏–º–æ–∫")}),t("#uso-crop-start").on("click",function(){i.hasImage()?(i.startCrop(t("#uso-crop-ratio").val()||"free"),t("#uso-crop-apply, #uso-crop-cancel").prop("disabled",!1)):alert("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å–Ω–∏–º–æ–∫")}),t("#uso-crop-apply").on("click",async function(){try{await i.applyCrop(),t("#uso-crop-apply, #uso-crop-cancel").prop("disabled",!0),P()}catch(e){console.error("[USO] Crop error:",e),alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏–∏:\n\n"+e.message)}}),t("#uso-crop-cancel").on("click",function(){i.cancelCrop(),t("#uso-crop-apply, #uso-crop-cancel").prop("disabled",!0)}),t("#uso-crop-ratio").on("change",function(){i.setCropRatio(this.value||"free")}),t("#uso-preview-refresh").on("click",async function(){try{const e=await R();t("#uso-preview").html(e),d=""}catch(e){console.error("[USO] Preview refresh error:",e),alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞:\n\n"+e.message)}}),t("#uso-preview-use").on("click",function(){d=t("#uso-preview").html()||"",alert("–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ PDF/TXT.")}),t("#uso-compare-variants").on("click",W),t("#uso-patient-phone").on("input paste",function(e){const t=this;setTimeout(()=>{let e=t.value;if(e=e.replace(/[^\d+]/g,""),e.startsWith("8")&&(e="+7"+e.substring(1)),e.startsWith("7")&&!e.startsWith("+7")&&(e="+"+e),e.startsWith("+7")){const t=e.substring(2).replace(/\D/g,"");let n="+7";t.length>0&&(n+=" ("+t.substring(0,3),t.length>3?(n+=") "+t.substring(3,6),t.length>6&&(n+="-"+t.substring(6,8),t.length>8&&(n+="-"+t.substring(8,10)))):n+=")"),e=n}t.value=e},10)}),t("#uso-patient-phone").val("+7 "),t(document).on("input change","#uso-patient-name, #uso-patient-phone",H),H(),function(){p&&clearInterval(p);p=setInterval(function(){if(!c.length)return;k();const e={variants:c.map(e=>({title:e.title,notes:e.notes,selections:e.selections,selectedMats:e.selectedMats})),activeVar:u,timestamp:Date.now(),patientName:t("#uso-patient-name").val()||"",patientPhone:t("#uso-patient-phone").val()||""};try{const t=JSON.stringify(e);if(t.length>1048576)return void console.warn("[USO] Autosave data too large ("+Math.round(t.length/1024)+" KB), skipping");localStorage.setItem(s,t)}catch(e){if(console.warn("[USO] Autosave failed:",e),"QuotaExceededError"===e.name)try{localStorage.removeItem(s),console.warn("[USO] Autosave quota exceeded, cleared")}catch(e){}}},3e4)}(),l.log("[USO] Application initialized successfully")}else console.error("[USO] CANVAS not loaded")}function b(){if(!i)return void console.warn("[USO] CANVAS not initialized");let e=c.length+1,t="–í–∞—Ä–∏–∞–Ω—Ç "+e;const n=new Set(c.map(e=>e.title));for(;n.has(t);)e++,t="–í–∞—Ä–∏–∞–Ω—Ç "+e;const o={title:t,data:{v:2,items:[],meta:{}},notes:{therapy:"",crowns:"",impl:""},selections:I(),selectedMats:M()};c.push(o),w(c.length-1,o.title),_(c.length-1),O()}function w(e,n){const o=t("#uso-variants-bar"),i=t('<div class="tab" role="tab" aria-selected="'+(e===u?"true":"false")+'" data-vid="'+e+'"></div>').text(n);i.on("click",function(){_(Number(t(this).attr("data-vid")))}),o.append(i),S()}function S(){t("#uso-variants-bar .tab").removeClass("active").attr("aria-selected","false").filter('[data-vid="'+u+'"]').addClass("active").attr("aria-selected","true")}function _(e){if(e<0||e>=c.length)return;k(),u=e,S();const n=c[e];if(n&&n.data&&i&&i.load&&(3===n.data.v&&Array.isArray(n.data.images)&&n.data.images.length>0||Array.isArray(n.data.items)&&n.data.items.length>0))try{i.load(n.data)}catch(e){console.error("[USO] Failed to load variant data:",e),i&&i.resetMarkers&&i.resetMarkers()}else i&&i.resetMarkers&&i.resetMarkers();n&&n.notes&&(t("#uso-note-therapy").val(n.notes.therapy||""),t("#uso-note-crowns").val(n.notes.crowns||""),t("#uso-note-implants").val(n.notes.impl||"")),n&&n.selections&&function(e){if(!e)return;e.implBrand&&t('input[name="uso-impl-brand"]').filter(function(){return this.value===e.implBrand}).prop("checked",!0);const n=Array.isArray(e.implCrown)?e.implCrown:e.implCrown?[e.implCrown]:[];t('input[name="uso-impl-crown-mat"]').prop("checked",!1),n.forEach(e=>t('input[name="uso-impl-crown-mat"]').filter(function(){return this.value===e}).prop("checked",!0)),e.implBridge&&t('input[name="uso-impl-bridge"]').filter(function(){return this.value===e.implBridge}).prop("checked",!0);C()}(n.selections),t("#uso-results").html(""),P()}function k(){if(!c.length)return;const e=x();try{e.data=i.serialize()}catch(e){}e.notes.therapy=t("#uso-note-therapy").val()||"",e.notes.crowns=t("#uso-note-crowns").val()||"",e.notes.impl=t("#uso-note-implants").val()||""}function x(){return c[u]}function U(){return u}function O(){const e=t("#uso-compare-variants");c.length>=2?e.show():e.hide()}function I(){const e=(o.implants||[])[0]?.admin_key||"",t=(o.impl_crowns||[])[0]?.admin_key||"",n=(o.impl_bridges||[])[0]?.admin_key||"",i=A(),a=i.part[0]?.admin_key||"",r=i.full[0]?.admin_key||"";return{implBrand:e,implCrown:t?[t]:[],implBridge:n,prosthesis:{top:{yellow:a,violet:a,white:r},bottom:{yellow:a,violet:a,white:r}}}}function M(){const e={};return(o.mc||[]).forEach(t=>{e[t.admin_key]=!!t.default}),(o.zr||[]).forEach(t=>{e[t.admin_key]=!!t.default}),e}function A(){const e=o.prosthesis||[],t=e.filter(e=>{const t=(e.admin_key||"").toLowerCase(),n=(e.label||"").toLowerCase();return t.includes("part")||n.includes("—á–∞—Å—Ç")}),n=e.filter(e=>{const t=(e.admin_key||"").toLowerCase(),n=(e.label||"").toLowerCase();return t.includes("full")||n.includes("–ø–æ–ª–Ω")}),i=e.filter(e=>!t.includes(e)&&!n.includes(e));return{part:t,full:n,other:i}}function C(){const e=o.prosthesis||[],n=A(),i=n.part[0]?.admin_key||e[0]?.admin_key||"",a=n.full[0]?.admin_key||e[0]?.admin_key||"",r=new Set(n.full.map(e=>e.admin_key)),l=e.find(e=>/acri.*mesh/i.test(e.admin_key||"")||/–∞—Ä–º|—Å–µ—Ç–∫/i.test((e.label||"").toLowerCase()))?.admin_key||"acri_mesh",s=e.find(e=>/metal.*part/i.test(e.admin_key||"")||/–ø–ª–∞—Å—Ç–∏–Ω–∫|–º–µ—Ç–∞–ª/i.test((e.label||"").toLowerCase()))?.admin_key||"metal_part";function c(t){const n=I(),o=x()||{selections:n};o.selections=o.selections||n,o.selections.prosthesisMulti=o.selections.prosthesisMulti||{top:{},bottom:{}};const c=o.selections.prosthesisMulti[t]||{};function u(e,n){if(!function(e,t){return"white"===e?r.has(t)||t===l:"violet"===e?!r.has(t)||"acri_full"===t||t===s:!r.has(t)}(e,n))return'<td style="text-align:center;opacity:.35">‚Äî</td>';const o=Array.isArray(c[e])?c[e]:[];let u=null;"yellow"!==e&&"violet"!==e||(u=i),"white"===e&&(u=a);const d=!o.length&&n===u,p=o.includes(n)||d?"checked":"";return`<td style="text-align:center"><input type="checkbox" class="pmx-chk" id="${`pmx_${t}_${e}_${n}`}" data-side="${t}" data-color="${e}" data-key="${n}" ${p}></td>`}const d=e.map(e=>{const t=String(e.admin_key||"");return`<tr><td>${h(e.label||t)}</td>${u("yellow",t)}${u("white",t)}${u("violet",t)}</tr>`}).join("");return`<div style="border:1px solid #e5e5e5;border-radius:6px;padding:8px;margin-top:6px;">\n        <b>${"top"===t?"–í–µ—Ä—Ö":"–ù–∏–∑"}</b>\n        <div style="overflow:auto;margin-top:6px;">\n          <table style="border-collapse:collapse;width:100%">\n            <thead><tr><th>–ú–∞—Ç–µ—Ä–∏–∞–ª</th><th>–ñ—ë–ª—Ç–∞—è</th><th>–ë–µ–ª–∞—è</th><th>–§–∏–æ–ª–µ—Ç–æ–≤–∞—è</th></tr></thead>\n            <tbody>${d}</tbody>\n          </table>\n        </div>\n        <div class="hint">–ñ—ë–ª—Ç–∞—è ‚Äî —á–∞—Å—Ç–∏—á–Ω—ã–π; –ë–µ–ª–∞—è ‚Äî –ø–æ–ª–Ω—ã–π (–∏ ¬´–∞—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–µ—Ç–∫–æ–π¬ª); –§–∏–æ–ª–µ—Ç–æ–≤–∞—è ‚Äî —á–∞—Å—Ç–∏—á–Ω—ã–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é), –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è ¬´–ê–∫—Ä–∏ –ø–æ–ª–Ω—ã–π¬ª –∏ ¬´–Ω–∞ –ø–ª–∞—Å—Ç–∏–Ω–∫–µ –∏–∑ –º–µ—Ç–∞–ª–ª–∞¬ª. –ó–µ–ª—ë–Ω–∞—è —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>\n      </div>`}const u=`<div style="display:grid;gap:10px;">${c("top")}${c("bottom")}</div>`;t("#uso-prost-matrix").html(u)}function E(e,t){e&&(e.open=!!t)}function P(){if(!c.length)return;if(!i||"function"!=typeof i.getCountsForCalculation||"function"!=typeof i.getJawSplitsForCalculation)return void console.warn("[USO] CANVAS not ready");const e=x();if(e&&e.selections)try{const r=i.getCountsForCalculation(),s=i.getJawSplitsForCalculation();if(l.log("[USO] recompute() - cnt:",r,"jaw:",s),!r||"object"!=typeof r)return void console.warn("[USO] Invalid counts from CANVAS:",r);if(!s||"object"!=typeof s)return void console.warn("[USO] Invalid jaw splits from CANVAS:",s);if(!a||"function"!=typeof a.compute)return void console.warn("[USO] CALC not ready");const c=a.compute(r,s,e.selections,e.selectedMats);if(!c||"object"!=typeof c)return void console.warn("[USO] Invalid calculation result:",c);t("#uso-sum-therapy").text(n.util.money(c.therapy)+" ‚ÇΩ"),t("#uso-info-mc").text(c.units_mc||0),t("#uso-info-white").text(r.white_dot||0),t("#uso-info-zr").text(c.units_zr||0),t("#uso-info-impl").text(n.util.money(c.implants.implSetSum)+" ‚ÇΩ"),t("#uso-info-impl-c").text(n.util.money(c.implants.implCrownsSum)+" ‚ÇΩ"),t("#uso-info-impl-b").text(n.util.money(c.implants.implBridgeSum)+" ‚ÇΩ"),t("#uso-info-impl-a").text(n.util.money(c.implants.abutmentSum)+" ‚ÇΩ");const u=r.yellow_line&&s.yellow.topUnits?"–∂—ë–ª—Ç–∞—è":r.white_line&&s.white.topUnits?"–±–µ–ª–∞—è":r.violet_line&&s.violet.topUnits?"—Ñ–∏–æ–ª–µ—Ç–æ–≤–∞—è":r.green_line&&s.green.topUnits?"–∑–µ–ª—ë–Ω–∞—è":"‚Äî",d=r.yellow_line&&s.yellow.bottomUnits?"–∂—ë–ª—Ç–∞—è":r.white_line&&s.white.bottomUnits?"–±–µ–ª–∞—è":r.violet_line&&s.violet.bottomUnits?"—Ñ–∏–æ–ª–µ—Ç–æ–≤–∞—è":r.green_line&&s.green.bottomUnits?"–∑–µ–ª—ë–Ω–∞—è":"‚Äî";t("#uso-info-prot-top").text(u),t("#uso-info-prot-bot").text(d),function(e){let n='<div class="uso-grid4">';const i=[].concat(o.mc||[],o.zr||[]),a=x().selectedMats||{};i.forEach(t=>{const o=t.admin_key,i=e.col[o]||0,r=(Object.prototype.hasOwnProperty.call(a,o)?a[o]:t.default)?"checked":"";n+='<div class="card mat" data-key="'+h(o)+'"><label><input type="checkbox" class="uso-mat" data-key="'+h(o)+'" '+r+"> "+h(t.label)+"</label><div><b>"+(Number(i)||0).toLocaleString("ru-RU")+" ‚ÇΩ</b></div></div>"}),n+="</div>",t("#uso-results").html(n)}(c),function(e,t){const n=document.getElementById("uso-results")?.closest("details");E(n,!0);const o=document.getElementById("uso-prost-details"),i=(e.yellow_line||0)>0||(e.white_line||0)>0||(e.violet_line||0)>0||(e.green_line||0)>0;E(o,i);const a=document.querySelector(".impl-opts")?.closest("details"),r=(e.violet_exc||0)>0||(e.violet_dot||0)>0||(e.violet_x||0)>0||(e.violet_oval||0)>0;E(a,r);const l=document.getElementById("uso-preview-wrap")?.closest("details"),s=(t.units_mc||0)>0||(t.units_zr||0)>0;E(l,(t.therapy||0)>0||s||i||r)}(r,c),e._lastCalc=c,H()}catch(e){console.error("[USO] Recompute error:",e)}}function L(e,i){const a=n.util.money,r=(t("#uso-patient-name").val()||"").trim(),l=function(e){const t=String(e||"").replace(/\D/g,"");return t.length<=6?"***"+t:"***"+t.slice(-6)}(t("#uso-patient-phone").val()||""),s=i.cnt||{},c=i.prosthesis&&i.prosthesis.breakdown?i.prosthesis.breakdown:{},u=[];u.push("<p>–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, <b>"+h(r||"")+"</b>.</p><p>–û—Ä—Ç–æ–ø–µ–¥ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –∏–∑—É—á–∏–ª –í–∞—à —Å–Ω–∏–º–æ–∫. –°–Ω–∏–º–æ–∫ ‚Äî —ç—Ç–æ –∑–µ—Ä–∫–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è –∑—É–±–æ–≤ –≤ –ø–æ–ª–æ—Å—Ç–∏ —Ä—Ç–∞, –ø–æ—ç—Ç–æ–º—É —Ç–æ, —á—Ç–æ –Ω–∞ —Å–Ω–∏–º–∫–µ —Å–ª–µ–≤–∞, —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–ø—Ä–∞–≤–∞. –£—á–∏—Ç—ã–≤–∞–π—Ç–µ —ç—Ç–æ –ø—Ä–∏ –∏–∑—É—á–µ–Ω–∏–∏ –æ–ø–∏—Å–∞–Ω–∏—è.</p><p>–û–ø–∏—Å–∞–Ω–∏–µ —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–º –∏ –Ω–µ –∑–∞–º–µ–Ω—è–µ—Ç –≤–∏–∑—É–∞–ª—å–Ω—ã–π –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π –æ—Å–º–æ—Ç—Ä</p><p>–ù–∏–∂–µ –æ–ø–∏—Å–∞–Ω–æ, —á—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –≤ –≤–∞—à–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏. –ü—Ä–∏–≤–µ–¥–µ–Ω—ã —Ä–∞—Å—á—ë—Ç—ã –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç–∏–ø–æ–≤ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤.</p><p>–ï—Å–ª–∏ —Å–Ω–∏–º–æ–∫ —Å–¥–µ–ª–∞–Ω –¥–∞–≤–Ω–æ, —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑—É–±–æ–≤ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å, –ª–∏–±–æ –µ—Å—Ç—å –ø–æ–¥–≤–∏–∂–Ω–æ—Å—Ç—å –∑—É–±–æ–≤ –±–æ–ª–µ–µ 2-–π —Å—Ç–µ–ø–µ–Ω–∏ (–ø–æ —Ñ–æ—Ç–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–µ–ª—å–∑—è), –Ω–∞ –º–µ—Å—Ç–µ –≤–æ–∑–º–æ–∂–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –ø–ª–∞–Ω–∞.</p><p>–ü–ª–∞–Ω –ª–µ—á–µ–Ω–∏—è –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ø—É–±–ª–∏—á–Ω–æ–π –æ—Ñ–µ—Ä—Ç–æ–π. –û–±—ä—ë–º—ã –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å –º–æ–≥—É—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –ø–æ –∏—Ç–æ–≥–∞–º –æ—á–Ω–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Å–º–æ—Ç—Ä–∞.</p><p>–ö–æ–Ω—Ç–∞–∫—Ç—ã –ø–∞—Ü–∏–µ–Ω—Ç–∞: "+h(l)+"</p>"),function(){const e={red_dot:"t_red_dot",red_q:"t_red_q",red_oval:"t_red_oval",red_exc:"t_red_exc",green_q:"t_green_q",green_dot:"t_green_dot",green_oval:"t_green_oval",green_exc:"t_green_exc",yellow_dot:"t_fill",yellow_oval:"t_build",black_exc:"t_post"},t={red_dot:"–ö—Ä–∞—Å–Ω–∞—è —Ç–æ—á–∫–∞",red_q:"–ö—Ä–∞—Å–Ω—ã–π –≤–æ–ø—Ä–æ—Å",red_oval:"–ö—Ä–∞—Å–Ω—ã–π –æ–≤–∞–ª",red_exc:"–ö—Ä–∞—Å–Ω—ã–π –≤–æ—Å–∫–ª–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –∑–Ω–∞–∫",green_dot:"–ó–µ–ª—ë–Ω–∞—è —Ç–æ—á–∫–∞",green_q:"–ó–µ–ª—ë–Ω—ã–π –≤–æ–ø—Ä–æ—Å",green_oval:"–ó–µ–ª—ë–Ω—ã–π –æ–≤–∞–ª",green_exc:"–ó–µ–ª—ë–Ω—ã–π –≤–æ—Å–∫–ª–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –∑–Ω–∞–∫",yellow_dot:"–ñ—ë–ª—Ç–∞—è —Ç–æ—á–∫–∞",yellow_oval:"–ñ—ë–ª—Ç—ã–π –æ–≤–∞–ª",black_exc:"–ß—ë—Ä–Ω—ã–π –≤–æ—Å–∫–ª–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –∑–Ω–∞–∫"},o=[];["red_dot","red_q","red_oval","red_exc","green_q","green_dot","green_oval","green_exc","yellow_dot","yellow_oval","black_exc"].forEach(i=>{const r=Number(s[i]||0);if(!r)return;const l=t[i]||i,c=n.OPT&&n.OPT.texts&&n.OPT.texts[i]?String(n.OPT.texts[i]):"",u=e[i],d=(u&&n.PRICES[u]||0)*r,p=d>0?" ("+a(d)+" ‚ÇΩ)":"";o.push("<li><b>"+h(l)+"</b>"+(c?" ‚Äî "+h(c):"")+p+"</li>")}),o.length&&(u.push("<h3>–¢–µ—Ä–∞–ø–∏—è</h3>"),u.push("<ul>"+o.join("")+"</ul>"),u.push("<p><b>–ò—Ç–æ–≥–æ –ø–æ —Ç–µ—Ä–∞–ø–∏–∏: "+a(i.therapy)+" ‚ÇΩ</b></p>"))}(),function(){const e=[],t=(e,t)=>t&&t>e?"–æ—Ç "+a(e)+" ‚ÇΩ –¥–æ "+a(t)+" ‚ÇΩ":e?a(e)+" ‚ÇΩ":"";c.yellow&&(c.yellow.topUnits&&c.yellow.topSumMin&&e.push("–ß–∞—Å—Ç–∏—á–Ω—ã–π (–∂—ë–ª—Ç–∞—è, –≤–µ—Ä—Ö): "+t(c.yellow.topSumMin,c.yellow.topSumMax)),c.yellow.bottomUnits&&c.yellow.botSumMin&&e.push("–ß–∞—Å—Ç–∏—á–Ω—ã–π (–∂—ë–ª—Ç–∞—è, –Ω–∏–∑): "+t(c.yellow.botSumMin,c.yellow.botSumMax))),c.white&&(c.white.topUnits&&c.white.topSumMin&&e.push("–ü–æ–ª–Ω—ã–π (–±–µ–ª–∞—è, –≤–µ—Ä—Ö): "+t(c.white.topSumMin,c.white.topSumMax)),c.white.bottomUnits&&c.white.botSumMin&&e.push("–ü–æ–ª–Ω—ã–π (–±–µ–ª–∞—è, –Ω–∏–∑): "+t(c.white.botSumMin,c.white.botSumMax))),c.violet&&(c.violet.topUnits&&c.violet.topSumMin&&e.push("–ü–æ –ø–æ–∫–∞–∑–∞–Ω–∏—è–º (—Ñ–∏–æ–ª–µ—Ç–æ–≤–∞—è, –≤–µ—Ä—Ö): "+t(c.violet.topSumMin,c.violet.topSumMax)),c.violet.bottomUnits&&c.violet.botSumMin&&e.push("–ü–æ –ø–æ–∫–∞–∑–∞–Ω–∏—è–º (—Ñ–∏–æ–ª–µ—Ç–æ–≤–∞—è, –Ω–∏–∑): "+t(c.violet.botSumMin,c.violet.botSumMax))),c.green&&(c.green.topUnits&&c.green.topSumMin&&e.push("(–∑–µ–ª—ë–Ω–∞—è, –≤–µ—Ä—Ö): "+t(c.green.topSumMin,c.green.topSumMax)),c.green.bottomUnits&&c.green.botSumMin&&e.push("(–∑–µ–ª—ë–Ω–∞—è, –Ω–∏–∑): "+t(c.green.botSumMin,c.green.botSumMax)));const n=Number(i.prosthesis?.removableMin||0),o=Number(i.prosthesis?.removableMax||0);if((e.length||n||o)&&(u.push("<h3>–ü—Ä–æ—Ç–µ–∑—ã</h3>"),e.length&&u.push("<ul><li>"+e.join("</li><li>")+"</li></ul>"),n||o)){const e=o&&o>n?"–ü—Ä–æ—Ç–µ–∑—ã –≤—Å–µ–≥–æ: –æ—Ç "+a(n)+" ‚ÇΩ –¥–æ "+a(o)+" ‚ÇΩ":"–ü—Ä–æ—Ç–µ–∑—ã –≤—Å–µ–≥–æ: "+a(n||o)+" ‚ÇΩ";u.push("<p><b>"+e+"</b></p>")}}();const d=Number(i.baseCore||0),p=i.incWhite?Number(i.baseCore||0)+Number(s.white_dot||0):Number(i.baseCore||0),m=Number(i.units_zr||0),g=Number(i.prosthesis?.removableMin||0),f=Number(i.prosthesis?.removableMax||0),y=(s.white_dot||0)>0,v=Object.keys(e.selectedMats||{}).filter(t=>!!e.selectedMats[t]),b=(o.mc||[]).filter(e=>v.includes(e.admin_key)),w=(o.zr||[]).filter(e=>v.includes(e.admin_key));function S(e,t,n){const o=[],i=w.length?w:[null],r=b.length?b:[null];let l=0;return i.forEach(i=>{r.forEach(r=>{l++;const s=["–í–∞—Ä–∏–∞–Ω—Ç "+l];e&&y&&s.push("("+e+")");const c=s.join(" "),u=0===U()&&0===n&&1===l;o.push(function(e,t,n,o,i,r){if(!t&&!o)return"";let l=0;const s=[];if(t&&n>0){const e=n*Number(t.price||0);l+=e,s.push(n+" –µ–¥. √ó "+a(t.price)+" ‚ÇΩ ("+h(t.label||t.admin_key)+") = <b>"+a(e)+" ‚ÇΩ</b>")}if(o&&i>0){const e=i*Number(o.price||0);l+=e,s.push(i+" –µ–¥. √ó "+a(o.price)+" ‚ÇΩ ("+h(o.label||o.admin_key)+") = <b>"+a(e)+" ‚ÇΩ</b>")}let c="",u=0;f&&f>g?(c="–æ—Ç "+a(g)+" ‚ÇΩ –¥–æ "+a(f)+" ‚ÇΩ",u=g):g&&(c=a(g)+" ‚ÇΩ",u=g);const d=l+u,p=[];return p.push('<div class="card" style="border:1px solid #ddd;border-radius:6px;padding:8px;margin:6px 0;">'),p.push('<div style="font-weight:700">'+h(e)+"</div>"),s.length&&p.push("<div>"+s.join("<br>")+"</div>"),c&&p.push("<div>–°—ä—ë–º–Ω—ã–µ –ø—Ä–æ—Ç–µ–∑—ã: "+c+"</div>"),p.push("<div>–°—É–º–º–∞ –ø–æ –≤–∞—Ä–∏–∞–Ω—Ç—É: <b>"+a(d)+" ‚ÇΩ</b></div>"),r&&p.push('<div style="margin-top:8px;color:#2271b1;font-style:italic;">(–≠—Ç–æ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –¥–ª—è –í–∞—Å –≤–∞—Ä–∏–∞–Ω—Ç)</div>'),p.push("</div>"),p.join("")}(c,r,t,i,m,u))})}),o.filter(Boolean).join("")}return function(){const e=S("–±–µ–∑ ¬´–±–µ–ª–æ–π –º–µ—Ç–∫–∏¬ª",d,0);if(e){const t=y?"<h3>–ö–æ—Ä–æ–Ω–∫–∏ –ø–æ –æ—Ä—Ç–æ–ø–µ–¥–∏—á–µ—Å–∫–∏–º –ø–æ–∫–∞–∑–∞–Ω–∏—è–º</h3>":"<h3>–ö–æ—Ä–æ–Ω–∫–∏</h3>";u.push(t),u.push(e)}}(),function(){if(!(y&&p>d))return;const e=S("—Å —É—á—ë—Ç–æ–º ¬´–±–µ–ª–æ–π –º–µ—Ç–∫–∏¬ª",p,1);e&&(u.push("<h3>–ö–æ—Ä–æ–Ω–∫–∏ —Å —É—á—ë—Ç–æ–º —ç—Å—Ç–µ—Ç–∏–∫–∏ (¬´–±–µ–ª—ã–µ —Ç–æ—á–∫–∏¬ª)</h3>"),u.push(e))}(),function(){const e=i.implants||{},t=[];if(e.implSetSum){const n=(o.implants||[]).find(t=>t.admin_key===e.implBrand);t.push("–ò–º–ø–ª–∞–Ω—Ç—ã"+(n?" ("+h(n.label)+")":"")+": <b>"+a(e.implSetSum)+" ‚ÇΩ</b>")}if(Array.isArray(e.implCrownsBreakdown)&&e.implCrownsBreakdown.length?e.implCrownsBreakdown.forEach(e=>{const n=(o.impl_crowns||[]).find(t=>t.admin_key===e.key),i=n?n.label:e.key;e.sum&&t.push("–ö–æ—Ä–æ–Ω–∫–∏ –Ω–∞ –∏–º–ø–ª–∞–Ω—Ç—ã ("+h(i)+"): "+e.units+" √ó "+a(e.price)+" ‚ÇΩ = <b>"+a(e.sum)+" ‚ÇΩ</b>")}):e.implCrownsSum&&t.push("–ö–æ—Ä–æ–Ω–∫–∏ –Ω–∞ –∏–º–ø–ª–∞–Ω—Ç—ã: <b>"+a(e.implCrownsSum)+" ‚ÇΩ</b>"),e.implBridgeSum){const n=(o.impl_bridges||[]).find(t=>t.admin_key===e.implBridge);t.push("–ú–æ—Å—Ç –º–µ–∂–¥—É –∏–º–ø–ª–∞–Ω—Ç–∞–º–∏"+(n?" ("+h(n.label)+")":"")+": <b>"+a(e.implBridgeSum)+" ‚ÇΩ</b>")}if(e.abutmentSum){const n=o.abutment&&o.abutment.label?o.abutment.label:"–ê–±–∞—Ç–º–µ–Ω—Ç";t.push(h(n)+": <b>"+a(e.abutmentSum)+" ‚ÇΩ</b>")}t.length&&(u.push("<h3>–ò–º–ø–ª–∞–Ω—Ç–∞—Ü–∏—è</h3>"),u.push('<div class="card" style="border:1px solid #ddd;border-radius:6px;padding:8px;margin:6px 0;">'+t.join("<br>")+"</div>"))}(),u.join("")}async function R(){const e=U(),t=[];for(let e=0;e<c.length;e++)try{_(e);const n=x();if(!n){console.warn(`[USO] Variant ${e} is null`);continue}if(!n._lastCalc||"object"!=typeof n._lastCalc){console.warn(`[USO] Variant ${e} has no calculation data`);continue}const o=n._lastCalc,i=[];try{i.push(L(n,o))}catch(t){console.error(`[USO] Failed to build section for variant ${e}:`,t);continue}t.push('<div class="section">'+i.join("")+"</div>")}catch(t){console.error(`[USO] Error processing variant ${e}:`,t);continue}return _(e),0===t.length?'<div class="section"><p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–±–∞–≤—å—Ç–µ –º–µ—Ç–∫–∏ –Ω–∞ —Å–Ω–∏–º–æ–∫.</p></div>':t.join('<div style="page-break-after:always;"></div>')}async function N(e,n){if(m)return void console.warn("[USO] Export already in progress");m=!0;const o=t(n),i=o.text();try{o.prop("disabled",!0).text("–û–±—Ä–∞–±–æ—Ç–∫–∞..."),await e()}catch(e){console.error("[USO] Export error:",e)}finally{m=!1,o.prop("disabled",!1).text(i)}}async function j(){try{if(!i.hasImage())return void alert("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å–Ω–∏–º–æ–∫");if(!(t("#uso-patient-name").val()||"").trim())return alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∏–º—è –ø–∞—Ü–∏–µ–Ω—Ç–∞"),void t("#uso-patient-name").focus();k(),l.log("[USO_APP] Starting PDF export");const e=await R();l.log("[USO_APP] Built text HTML, length:",e.length);let n=[];if(i&&i.getAllImagesForExport&&"function"==typeof i.getAllImagesForExport)try{l.log("[USO_APP] Getting all images for export"),n=await i.getAllImagesForExport(),l.log("[USO_APP] Got",n.length,"images")}catch(e){console.warn("[USO_APP] Error getting images:",e),n=[]}if(l.log("[USO_APP] Calling exportPDF with",n.length,"images"),!r||!r.exportPDF||"function"!=typeof r.exportPDF)return console.error("[USO_APP] exportPDF not available"),void alert("–û—à–∏–±–∫–∞: —Ñ—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ PDF –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞");await r.exportPDF(e,$(),"default",n)}catch(e){console.error("[USO] PDF export error:",e),console.error("[USO] Error stack:",e.stack),alert("–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ PDF: "+(e.message||"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"))}}async function T(){try{if(!i.hasImage())return void alert("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å–Ω–∏–º–æ–∫");if(!(t("#uso-patient-name").val()||"").trim())return alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∏–º—è –ø–∞—Ü–∏–µ–Ω—Ç–∞"),void t("#uso-patient-name").focus();k();const e=(new Date).toLocaleDateString("ru-RU");let n="–î–∞—Ç–∞ —Ä–∞—Å—á—ë—Ç–∞: "+e+"\n\n"+function(e){const t=document.createElement("div");t.innerHTML=e,t.querySelectorAll("br").forEach(e=>e.replaceWith("\n")),t.querySelectorAll("li").forEach(e=>{const t=e.textContent.trim();e.replaceWith(document.createTextNode("- "+t+"\n"))});const n=new Set(["P","DIV","H1","H2","H3","H4","H5","H6","SECTION","ARTICLE","SUMMARY","DETAILS","FIGURE"]),o=[];return function e(t,o){t.childNodes.forEach(t=>{if(3===t.nodeType){const e=t.nodeValue.replace(/\s+\n/g,"\n").replace(/\n\s+/g,"\n");o.push(e)}else if(1===t.nodeType){const i=t.tagName;"IMG"!==i&&(e(t,o),n.has(i)&&o.push("\n"))}})}(t,o),o.join("").replace(/\n{3,}/g,"\n\n").trim()}(await R());const o=new Blob(["\ufeff"+n],{type:"text/plain;charset=utf-8"}),a=URL.createObjectURL(o),r=document.createElement("a");r.href=a,r.download=$()+".txt",document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(a)}catch(e){console.error("[USO] TXT export error:",e),alert("–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ TXT")}}async function B(){if(!i.hasImage())return void alert("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å–Ω–∏–º–æ–∫");if(!(t("#uso-patient-name").val()||"").trim())return alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∏–º—è –ø–∞—Ü–∏–µ–Ω—Ç–∞"),void t("#uso-patient-name").focus();k();const e=await R(),n=i.getAllImages?i.getAllImages():[],o=i.getWorkMode?i.getWorkMode():"panoramic",a='<div style="page-break-after:always;"></div>'+e,l=await r.buildPDFBlob(a,$(),"default",n,o)||{},s=l.blob,c=l.name||$()+".pdf";if(!s)return void alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å PDF –¥–ª—è WhatsApp.");const u=new File([s],c,{type:"application/pdf"}),d="–î–æ–±—Ä—ã–π –¥–µ–Ω—å. –û—Ä—Ç–æ–ø–µ–¥ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –∏–∑—É—á–∏–ª —Å–Ω–∏–º–æ–∫. –í—ã—Å—ã–ª–∞–µ–º PDF –¥–ª—è –æ–∑–Ω–∞–∫–æ–º–ª–µ–Ω–∏—è.";if(navigator.canShare&&navigator.canShare({files:[u]}))try{return void await navigator.share({text:d,files:[u]})}catch(e){}const p=URL.createObjectURL(s),m=document.createElement("a");m.href=p,m.download=c,document.body.appendChild(m),m.click(),document.body.removeChild(m),URL.revokeObjectURL(p),window.open("https://wa.me/?text="+encodeURIComponent(d),"_blank")}async function F(){if(!i.hasImage())return void alert("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å–Ω–∏–º–æ–∫");if(!(t("#uso-patient-name").val()||"").trim())return alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∏–º—è –ø–∞—Ü–∏–µ–Ω—Ç–∞"),void t("#uso-patient-name").focus();k();const e=await R(),n=i.getAllImages?i.getAllImages():[],o=i.getWorkMode?i.getWorkMode():"panoramic",a='<div style="page-break-after:always;"></div>'+e,l=await r.buildPDFBlob(a,$(),"default",n,o)||{},s=l.blob,c=l.name||$()+".pdf";if(!s)return void alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å PDF –¥–ª—è Telegram.");const u=new File([s],c,{type:"application/pdf"}),d="–î–æ–±—Ä—ã–π –¥–µ–Ω—å. –û—Ä—Ç–æ–ø–µ–¥ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –∏–∑—É—á–∏–ª —Å–Ω–∏–º–æ–∫. –í—ã—Å—ã–ª–∞–µ–º PDF –¥–ª—è –æ–∑–Ω–∞–∫–æ–º–ª–µ–Ω–∏—è.";if(navigator.canShare&&navigator.canShare({files:[u]}))try{return void await navigator.share({text:d,files:[u]})}catch(e){}const p=URL.createObjectURL(s),m=document.createElement("a");m.href=p,m.download=c,document.body.appendChild(m),m.click(),document.body.removeChild(m),URL.revokeObjectURL(p),window.open("https://t.me/share/url?url="+encodeURIComponent(d),"_blank")}function D(){if(!c.length)return;k();const e=JSON.stringify(c,null,2),t=new Blob([e],{type:"application/json;charset=utf-8"}),n=URL.createObjectURL(t),o=document.createElement("a");o.href=n,o.download=$()+"_markup.json",document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n)}function z(e){const n=e.target.files?.[0];if(!n)return;const o=new FileReader;o.onload=function(e){try{const n=JSON.parse(e.target.result);if(!Array.isArray(n))throw new Error("Invalid JSON structure");c=n,u=0,t("#uso-variants-bar").empty(),c.forEach((e,t)=>w(t,e.title)),_(0),O(),alert("–†–∞–∑–º–µ—Ç–∫–∞ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ")}catch(e){alert("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: "+e.message)}},o.readAsText(n),e.target.value=""}function W(){if(c.length<2)return;const e=c.map((e,t)=>{const o=e._lastCalc||{};return'<div style="margin:12px 0;padding:12px;border:1px solid #ddd;border-radius:4px;"><b>'+h(e.title)+"</b><br>–¢–µ—Ä–∞–ø–∏—è: "+n.util.money(o.therapy||0)+" ‚ÇΩ<br>–ö–æ—Ä–æ–Ω–∫–∏ MC: "+n.util.money(o.col?.mc_default||0)+" ‚ÇΩ<br>–ö–æ—Ä–æ–Ω–∫–∏ ZR: "+n.util.money(o.col?.zr_default||0)+" ‚ÇΩ<br>–ü—Ä–æ—Ç–µ–∑—ã: "+n.util.money(o.prosthesis?.removableMin||0)+" - "+n.util.money(o.prosthesis?.removableMax||0)+" ‚ÇΩ<br>–ò–º–ø–ª–∞–Ω—Ç—ã: "+n.util.money(o.implants?.implSetSum||0)+" ‚ÇΩ</div>"}).join("");alert(e)}function $(){return((t("#uso-patient-name").val()||"").trim().replace(/[^a-—èa-z0-9]/gi,"_")||"patient")+"_"+(new Date).toISOString().split("T")[0]}function H(){const e=(t("#uso-patient-name").val()||"").trim().length>0,n=i&&i.hasImage&&i.hasImage();t("#uso-pdf, #uso-txt, #uso-wa, #uso-tg, #uso-png").prop("disabled",!(e&&n))}t(document).ready(function(){l.log("[USO] Document ready, initializing..."),v()})}(window,jQuery);