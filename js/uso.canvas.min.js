!function(e,t){"use strict";e.USO||(e.USO={});const n=e.USO,o={enabled:!1,_initialized:!1,_checkInit:function(){if(!this._initialized){const t=n.ASSETS||{};this.enabled=!0===t.debug_mode||"1"===t.debug_mode,e.localStorage&&"true"===e.localStorage.getItem("uso_debug")&&(this.enabled=!0),this._initialized=!0}},log:function(...t){this._checkInit(),this.enabled&&e.console&&e.console.log&&e.console.log(...t)},warn:function(...t){e.console&&e.console.warn&&e.console.warn(...t)},error:function(...t){e.console&&e.console.error&&e.console.error(...t)}},r={PANORAMIC:"panoramic",SIMPLE:"simple"};let i=r.PANORAMIC,l=[],a=0,s=null,c={},u=!1,d=!1,f=!1,m="blue",g="point",h=null,p=null,_=[],v=!1,y=null,k=null,b=null;const w={blue:"#1565FF",ltblue:"#00E5FF",white:"#FFFFFF",violet:"#B100FF",black:"#000000",yellow:"#FFEB00",green:"#00C853",red:"#FF1744"},x={blue_x:"#1565FF",blue_dot:"#1565FF",ltblue_x:"#00E5FF",ltblue_dot:"#00E5FF",white_dot:"#FFFFFF",white_line:"#FFFFFF",violet_x:"#B100FF",violet_line:"#B100FF",violet_dot:"#B100FF",violet_exc:"#B100FF",violet_oval:"#B100FF",black_x:"#000000",black_dot:"#000000",black_exc:"#000000",yellow_line:"#FFEB00",yellow_dot:"#FFEB00",yellow_oval:"#FFD600",red_dot:"#FF1744",red_q:"#FF1744",red_oval:"#FF1744",red_exc:"#FF1744",green_dot:"#00C853",green_q:"#00C853",green_oval:"#00C853",green_exc:"#00C853",green_line:"#00E676"};function S(e,t){const n={blue:{point:"blue_dot",cross:"blue_x",line:null,oval:null,q:null,exc:null},ltblue:{point:"ltblue_dot",cross:"ltblue_x",line:null,oval:null,q:null,exc:null},white:{point:"white_dot",cross:null,line:"white_line",oval:null,q:null,exc:null},violet:{point:"violet_dot",cross:"violet_x",line:"violet_line",oval:"violet_oval",q:null,exc:"violet_exc"},black:{point:"black_dot",cross:"black_x",line:null,oval:null,q:null,exc:"black_exc"},yellow:{point:"yellow_dot",cross:null,line:"yellow_line",oval:"yellow_oval",q:null,exc:null},green:{point:"green_dot",cross:null,line:"green_line",oval:"green_oval",q:"green_q",exc:"green_exc"},red:{point:"red_dot",cross:null,line:null,oval:"red_oval",q:"red_q",exc:"red_exc"}};return(n[e]||n.blue)[t]||null}function A(){return document.fullscreenElement||document.webkitFullscreenElement||null}function M(){try{if(document.exitFullscreen)return document.exitFullscreen();if(document.webkitExitFullscreen)return document.webkitExitFullscreen(),Promise.resolve()}catch(e){return Promise.reject(e)}return Promise.resolve()}const C=/iPhone|iPad|iPod/.test(navigator.userAgent)||"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1;let U=!1,F=null;function N(){return!!A()||U}function O(){s&&me()}function I(e){try{document.dispatchEvent(new CustomEvent("uso:fsToggle",{detail:{isFs:!!e,mode:"fake"}}))}catch(e){}}function W(){U=!0,document.body.classList.add("uso-fs-active");const e=window.scrollY||document.documentElement.scrollTop;document.body.style.overflow="hidden",document.body.style.position="fixed",document.body.style.width="100%",document.body.style.height="100vh",document.body.style.top=-e+"px",t("#uso-exit-fs").css("display","inline-flex"),requestAnimationFrame(()=>O()),window.visualViewport&&(F=n.util.throttle(function(){U&&requestAnimationFrame(()=>O())},200),window.visualViewport.addEventListener("resize",F),window.visualViewport.addEventListener("scroll",F)),I(!0)}function E(){U=!1,document.body.classList.remove("uso-fs-active");const e=-parseInt(document.body.style.top||"0");document.body.style.overflow="",document.body.style.position="",document.body.style.width="",document.body.style.height="",document.body.style.top="",e&&window.scrollTo(0,e),t("#uso-exit-fs").css("display","none"),window.visualViewport&&F&&(window.visualViewport.removeEventListener("resize",F),window.visualViewport.removeEventListener("scroll",F),F=null),I(!1)}function z(){const e=document.getElementById("uso-canvas-container");if(N())return A()&&M().catch(function(){}),U&&E(),O(),void V();if(C)return W(),O(),void V();const t=function(e){try{if(e.requestFullscreen)return e.requestFullscreen();if(e.webkitRequestFullscreen)return e.webkitRequestFullscreen(),Promise.resolve()}catch(e){return Promise.reject(e)}return Promise.reject(new Error("Fullscreen API not supported"))}(e);Promise.resolve(t).then(function(){}).catch(function(){W(),O(),V()})}function V(){const e=N();t("#uso-fullscreen").text(e?"Выйти из полноэкранного":"На весь экран"),t("#uso-exit-fs").css("display",e?"inline-flex":"none")}function q(e,t,n){return Math.max(t,Math.min(n,e))}function T(){const e=function(e,t){3===(e=(e||"").replace("#","")).length&&(e=e.split("").map(e=>e+e).join(""));const n=parseInt(e,16);return"rgba("+(n>>16&255)+","+(n>>8&255)+","+(255&n)+","+(null!=t?t:.12)+")"}(w[m]||"#1565FF",.12),t=document.querySelector("#uso-calc-app .palette.unified");t&&(t.style.background=e)}function j(){return s?s.getHeight():1}function P(){const e=document.querySelectorAll(".palette .shape-btn");let t=!1,n=null;e.forEach(e=>{const o=e.getAttribute("data-shape")||"point",r="free"===o||!!S(m,o);e.disabled=!r,e.classList.toggle("disabled",!r),r&&!n&&(n=e),!r&&e.classList.contains("active")&&(t=!0)}),t&&n&&n.click()}function R(e){return Math.pow(2,Number(e||0))}let X=null;function Y(){return X?parseFloat(X.value||"0"):0}function B(){return q(.006*j()*Math.pow(2,Y()),2,12)}function D(){s&&(s.freeDrawingBrush||(s.freeDrawingBrush=new fabric.PencilBrush(s)),s.freeDrawingBrush.color=w[m]||"#1565FF",s.freeDrawingBrush.width=B())}const L={point:1.5,cross:1.5,line:1.5,oval:1.5,text:2};function H(e,t){const n=R(t),o=j();switch(e._norm||(e._norm={}),e._norm.factor=n,e._lastSizeVal=n,e.type){case"circle":!function(e,t){if(!e||"circle"!==e.type)return;if(e._norm||(e._norm={}),"number"!=typeof e._norm.rN){const t=e.radius||Math.max(4,Math.round(.011*j()*L.point));e._norm.rN=t/j()}e._norm.factor=R(t);const n=Math.max(2,e._norm.rN*j()*(e._norm.factor||1));e.set("radius",n),e._lastSizeVal=e._norm.factor||1}(e,t);break;case"group":{if("number"!=typeof e._norm.wN||"number"!=typeof e._norm.strokeN){const t=e.getScaledWidth()/(e.scaleX||1);e._norm.wN=t&&t>0?t/o:.032,e._norm.strokeN=(e._objects?.[0]?.strokeWidth||Math.round(.0055*o*L.cross))/o}const t=(e._norm.wN||0)*o*n,r=e.getScaledWidth()/(e.scaleX||1)||1;if(r>0){const n=t/r;isFinite(n)&&n>0&&(e.scaleX=e.scaleY=n)}(e._objects||[]).forEach(t=>{t.strokeUniform=!0,t.strokeWidth=Math.max(2,(e._norm.strokeN||0)*o*n)});break}case"ellipse":{if(e._manuallyScaled&&e._absoluteSize)return void e.setCoords();"number"==typeof e._norm.rxN&&"number"==typeof e._norm.ryN||(e._norm.rxN=(e.rx||Math.round(.0198*j()*L.oval))/o,e._norm.ryN=(e.ry||Math.round(.0286*j()*L.oval))/o,e._norm.strokeN=(e.strokeWidth||Math.round(.0055*j()*L.oval))/o,e._norm.cx=(e.left||0)+(e.rx||0),e._norm.cy=(e.top||0)+(e.ry||0));const t=(e._norm.rxN||0)*o*n,r=(e._norm.ryN||0)*o*n,i=e._norm.cx||(e.left||0)+(e.rx||0),l=e._norm.cy||(e.top||0)+(e.ry||0);e.rx=t,e.ry=r,e.left=i-t,e.top=l-r,e.strokeUniform=!0,e.strokeWidth=Math.max(2,(e._norm.strokeN||0)*o*n);break}case"line":"number"!=typeof e._norm.strokeN&&(e._norm.strokeN=(e.strokeWidth||Math.round(.0055*j()*L.line))/o),e.strokeUniform=!0,e.strokeWidth=Math.max(2,(e._norm.strokeN||0)*o*n);break;case"text":"number"!=typeof e._norm.fsN&&(e._norm.fsN=(e.fontSize||Math.round(.032*j()*1.4*L.text))/o),e.fontSize=Math.max(16,(e._norm.fsN||0)*o*n);break;case"path":"number"!=typeof e._norm.strokeN&&(e._norm.strokeN=(e.strokeWidth||Math.round(.0055*j()))/o),e.strokeUniform=!0,e.strokeWidth=Math.max(2,(e._norm.strokeN||0)*o*n)}}function $(e){const t=j();if(e){if("circle"===e.type){if(!e._norm)return;const n=(e._norm.rN||0)*t*(e._norm.factor||1);return void e.set("radius",Math.max(2,n))}if("group"===e.type){if(!e._norm){const n=e.getScaledWidth()/(e.scaleX||1);e._norm={wN:n/t,strokeN:(e._objects?.[0]?.strokeWidth||Math.round(.0055*t*L.cross))/t,factor:1}}const n=(e._norm.wN||0)*t*(e._norm.factor||1)/(e.getScaledWidth()/(e.scaleX||1)||1);return e.scaleX=e.scaleY=n,(e._objects||[]).forEach(n=>{n.strokeUniform=!0,n.strokeWidth=Math.max(2,(e._norm.strokeN||0)*t*(e._norm.factor||1))}),void e.setCoords()}if("ellipse"===e.type){if(e._manuallyScaled&&e._absoluteSize)return e.rx=e._absoluteSize.rx,e.ry=e._absoluteSize.ry,e.strokeWidth=e._absoluteSize.strokeWidth,void e.setCoords();e._norm||(e._norm={rxN:(e.rx||Math.round(.0198*t*L.oval))/t,ryN:(e.ry||Math.round(.0286*t*L.oval))/t,strokeN:(e.strokeWidth||Math.round(.0055*t*L.oval))/t,cx:(e.left||0)+(e.rx||0),cy:(e.top||0)+(e.ry||0),factor:1});const n=(e._norm.rxN||0)*t*(e._norm.factor||1),o=(e._norm.ryN||0)*t*(e._norm.factor||1),r=e._norm.cx||(e.left||0)+(e.rx||0),i=e._norm.cy||(e.top||0)+(e.ry||0);return e.rx=n,e.ry=o,e.left=r-n,e.top=i-o,e.strokeUniform=!0,e.strokeWidth=Math.max(2,(e._norm.strokeN||0)*t*(e._norm.factor||1)),void e.setCoords()}return"line"===e.type?(e._norm||(e._norm={strokeN:(e.strokeWidth||Math.round(.0055*t*L.line))/t,factor:1}),e.strokeUniform=!0,void(e.strokeWidth=Math.max(2,(e._norm.strokeN||0)*t*(e._norm.factor||1)))):"text"===e.type?(e._norm||(e._norm={fsN:(e.fontSize||Math.round(.032*t*1.4*L.text))/t,factor:1}),e.fontSize=Math.max(16,(e._norm.fsN||0)*t*(e._norm.factor||1)),void e.setCoords()):"path"===e.type?(e._norm||(e._norm={strokeN:(e.strokeWidth||Math.round(.0055*t))/t,factor:1}),e.strokeWidth=Math.max(2,(e._norm.strokeN||0)*t*(e._norm.factor||1)),e.strokeUniform=!0,void e.setCoords()):void 0}}function G(e){d=!!e,d?(p||J(),f||(f=!0,p.set("visible",!0)),p.set({stroke:"#d32f2f",strokeWidth:4,strokeDashArray:null,selectable:!0,evented:!0,hasControls:!1,lockMovementX:!0,hoverCursor:"ns-resize"})):p&&p.set({stroke:"rgba(0,0,0,0.35)",strokeWidth:2,strokeDashArray:[6,6],selectable:!1,evented:!1,hasControls:!1,lockMovementX:!0,hoverCursor:"default",visible:f}),te();const t=document.getElementById("img-rotate");t&&(t.classList.toggle("active",d),t.setAttribute("aria-pressed",d?"true":"false"),t.textContent="Ср. линия"+(d?" (вкл)":""))}function Z(){const e=s?s.getHeight():0;return p&&"number"==typeof p.y1?p.y1:e/2}function J(e){if(!s)return;let t=null;e&&p&&s.getHeight()&&(t=Z()/s.getHeight()),p&&(s.remove(p),p=null);const n=s.getWidth(),o=s.getHeight(),r=null!=t?q(t*o,0,o):o/2;p=new fabric.Line([0,r,n,r],{stroke:"rgba(0,0,0,0.3)",strokeWidth:2,strokeDashArray:[6,6],selectable:!1,evented:!1,hasControls:!1,lockMovementX:!0,hoverCursor:"default",excludeFromExport:!0,visible:f}),p.set("markerType","__midline__"),s.add(p),s.bringToFront(p),s.requestRenderAll()}function Q(){return u&&!d&&!y}function K(){const e=l[a];return e&&e.markers?e.markers:[]}function ee(){if(!s)return;const e=s.upperCanvasEl,t=new Map;let n=null,o=null,r=!1,i=null;function l(t){const n=e.getBoundingClientRect(),o="clientX"in t?t.clientX:0,r="clientY"in t?t.clientY:0;return{x:o-n.left,y:r-n.top}}"onpointerdown"in window&&(e.addEventListener("pointerdown",function(n){if(t.set(n.pointerId,n),e.setPointerCapture&&e.setPointerCapture(n.pointerId),!u&&!d&&!y){let c=null;try{c=s.findTarget(n)||null}catch(e){}const u=l(n);1!==t.size||c||(o=u.x,a=u.y,r=!0,i={x:o,y:a},e.style.cursor="grabbing")}var o,a},{passive:!0}),e.addEventListener("pointermove",function(a){if(!t.has(a.pointerId))return;if(t.set(a.pointerId,a),!u&&!d&&!y&&2===t.size){a.preventDefault();const r=Array.from(t.values()),i=r[0],l=r[1],c=l.clientX-i.clientX,u=l.clientY-i.clientY,d=Math.sqrt(c*c+u*u),f=e.getBoundingClientRect(),m={x:(i.clientX+l.clientX)/2,y:(i.clientY+l.clientY)/2},g=s.getZoom();if(n){let e=g*(d/n);e=Math.min(4,Math.max(.2,e));const t=new fabric.Point(m.x-f.left,m.y-f.top);s.zoomToPoint(t,e);const r=s.viewportTransform;r[4]+=m.x-(o?o.x:m.x),r[5]+=m.y-(o?o.y:m.y),s.requestRenderAll()}return n=d,void(o=m)}const c=l(a);u||d||y||!r||function(e,t){if(!r)return;const n=e-i.x,o=t-i.y,l=s.viewportTransform;l[4]+=n,l[5]+=o,i={x:e,y:t},s.requestRenderAll()}(c.x,c.y)},{passive:!1}),e.addEventListener("pointerup",function(l){t.has(l.pointerId)&&(t.delete(l.pointerId),e.releasePointerCapture&&e.releasePointerCapture(l.pointerId)),t.size<2&&(n=null,o=null),r&&(r=!1,i=null,e.style.cursor="")},{passive:!0}))}function te(){if(!s)return;s.skipTargetFind=!1,s.selection=!!u;const e=l[a],t=e&&e.canMark;o.log("[USO_CANVAS] syncMarkMode: activeImageIndex=",a,"canMark=",t);K().forEach(function(e){e.selectable=t,e.evented=t,e.hasBorders=t,e.hasControls=t&&u,e.lockMovementX=!t,e.lockMovementY=!t;const n=!t;e.lockScalingX=n,e.lockScalingY=n,e.lockRotation=n,e.borderColor="#2271b1",e.cornerColor="#2271b1",e.transparentCorners=!1,e.borderScaleFactor=1,e.borderOpacityWhenMoving=.4,e.hoverCursor=t?"move":"default",e.setCoords()}),s.isDrawingMode=u&&"free"===g&&t&&!d&&!y,D(),s.requestRenderAll()}function ne(){const e=document.getElementById("mark-toggle");e&&(e.setAttribute("aria-pressed",u?"true":"false"),e.classList.toggle("primary",u),o.log("[USO_CANVAS] updateMarkingButton: markingMode=",u))}function oe(e){return K().filter(t=>t.markerType===e).length}function re(e){const t=Z();let n=0,o=0;return K().forEach(function(r){if(r.markerType!==e)return;(r.getCenterPoint?r.getCenterPoint():{x:0,y:0}).y<t?n++:o++}),{topUnits:n>0?1:0,bottomUnits:o>0?1:0}}function ie(e){if(e<0||e>=l.length)return void console.warn("[USO_CANVAS] Invalid image index:",e);o.log("[USO_CANVAS] Switching to image:",e,"description:",l[e].description),Object.keys(c).forEach(function(e){const t=c[e];t&&t.getElement&&(t.getElement().style.display="none")}),a=e;const t=l[e];if(u=t.canMark,!c[e]){o.log("[USO_CANVAS] Creating new canvas for image:",e);const t=function(e){const t=document.createElement("canvas");t.id="uso-canvas-"+e,t.className="uso-image-canvas",t.style.cssText="display: none; position: absolute; top: 0; left: 0;";const n=document.getElementById("uso-canvas-container");return n?(n.appendChild(t),o.log("[USO_CANVAS] Canvas element created:",t.id),t):(console.error("[USO] Canvas container not found"),null)}(e);if(!t)return void console.error("[USO_CANVAS] Failed to create canvas element");const r=new fabric.Canvas(t,{selection:!0,preserveObjectStacking:!0,renderOnAddRemove:!1});c[e]=r,r.freeDrawingBrush=new fabric.PencilBrush(r),(n=r)&&(n.freeDrawingBrush||(n.freeDrawingBrush=new fabric.PencilBrush(n)),n.freeDrawingBrush.color=w[m]||"#1565FF",n.freeDrawingBrush.width=B()),o.log("[USO_CANVAS] New canvas created:",t.id)}var n;if(s=c[e],s.getElement().style.display="block",o.log("[USO_CANVAS] Switched to canvas:",e,"element:",s.getElement().id),t.bgImg)return o.log("[USO_CANVAS] Image already loaded, showing existing canvas"),s.isDrawingMode=t.canDraw&&"free"===g&&u,te(),ne(),J(),s.requestRenderAll(),le(),void o.log("[USO_CANVAS] Image switched successfully (cached)");t.imageUrl&&fabric.Image.fromURL(t.imageUrl,function(n){if(!n)return void console.error("[USO] Failed to create fabric image");n.set({selectable:!1,evented:!1}),t.bgImg=n;const r=document.getElementById("uso-canvas-container"),i=Math.max(320,r.clientWidth||320),l=r.clientHeight||0,a=l>0?l:fe(r),c="function"==typeof n.getElement?n.getElement():n._element,d=c.naturalWidth||c.width,f=c.naturalHeight||c.height,m=i/d,h=a/f;let p=Math.min(m,h);(!isFinite(p)||p<=0)&&(p=m||1);const _=Math.round(d*p),v=Math.round(f*p);t.scale=p,t.targetW=_,t.targetH=v;s.setViewportTransform([1,0,0,1,0,0]),s.setZoom(1),n.set({left:0,top:0,scaleX:p,scaleY:p,selectable:!1,evented:!1,angle:0}),s.setWidth(_),s.setHeight(v),s.add(n),s.sendToBack(n),t.markers&&Array.isArray(t.markers)&&(t.markers.forEach(e=>{s.add(e)}),o.log("[USO_CANVAS] Loaded",t.markers.length,"markers for image",e)),s.isDrawingMode=t.canDraw&&"free"===g&&u,o.log("[USO_CANVAS] Image",e,"- markingMode:",u,"drawingMode:",s.isDrawingMode),te(),ne(),J(),s.requestRenderAll(),le(),o.log("[USO_CANVAS] Image switched successfully")},{crossOrigin:"anonymous"})}function le(){const e=document.getElementById("uso-images-nav");e&&(e.innerHTML="",l.forEach((t,n)=>{const o=document.createElement("button");o.className="uso-image-btn "+(n===a?"active":""),o.type="button",o.textContent=t.description,o.onclick=()=>ie(n),e.appendChild(o)}),o.log("[USO_CANVAS] Navigation updated, images:",l.length))}function ae(){if(!s)return{v:3,images:[],activeImageIndex:0,workMode:i};const e=s.getWidth(),t=s.getHeight();o.log("[USO_CANVAS] serialize() - saving ALL images, count:",l.length);const n=l.map(function(n,r){const i=function(e,t,n){if(!e||!e.markers)return[];const o=e.bgImg;let r=t,i=n;if(o){const e="function"==typeof o.getElement?o.getElement():o._element;e&&(r=e.naturalWidth||e.width||t,i=e.naturalHeight||e.height||n)}const l=r/t;return{items:e.markers.map(function(e){const t=function(e){if("circle"===e.type)return"point";if("group"===e.type)return"cross";if("line"===e.type)return"line";if("ellipse"===e.type)return"oval";if("text"===e.type){const t=(e.text||"").trim();if("?"===t)return"q";if("!"===t)return"exc"}return"path"===e.type?"free":"point"}(e);if("point"===t){const t=e.getCenterPoint();return{v:2,t:"point",m:e.markerType,cx:t.x*l,cy:t.y*l,radius:(e.radius||4)*l,sz:e._lastSizeVal||1}}if("cross"===t){const t=e.getCenterPoint();return{v:2,t:"cross",m:e.markerType,cx:t.x*l,cy:t.y*l,width:(e.width||20)*l,height:(e.height||20)*l,strokeWidth:(e._objects&&e._objects[0]?e._objects[0].strokeWidth:2)*l,ang:e.angle||0,sz:e._lastSizeVal||1}}if("line"===t)return{v:2,t:"line",m:e.markerType,x1:e.x1*l,y1:e.y1*l,x2:e.x2*l,y2:e.y2*l,strokeWidth:(e.strokeWidth||3)*l,ang:e.angle||0,sz:e._lastSizeVal||1};if("oval"===t){const t=(e.rx||0)*(e.scaleX||1),n=(e.ry||0)*(e.scaleY||1),o=(e.left||0)+t,r=(e.top||0)+n;return{v:2,t:"oval",m:e.markerType,cx:o*l,cy:r*l,rx:t*l,ry:n*l,strokeWidth:(e.strokeWidth||2)*l,ang:e.angle||0,sz:e._lastSizeVal||1,manual:!!e._manuallyScaled}}if("q"===t||"exc"===t){const n=e.getCenterPoint();return{v:2,t:t,m:e.markerType,cx:n.x*l,cy:n.y*l,fontSize:(e.fontSize||16)*l,ang:e.angle||0,sz:e._lastSizeVal||1}}return"free"===t?{v:2,t:"free",m:"free",path:e.path,left:(e.left||0)*l,top:(e.top||0)*l,scaleX:(e.scaleX||1)*l,scaleY:(e.scaleY||1)*l,stroke:e.stroke||"#000",strokeWidth:(e.strokeWidth||3)*l,strokeUniform:!!e.strokeUniform,sz:e._lastSizeVal||1}:null}).filter(Boolean),meta:{w:r,h:i}}}(n,e,t);return o.log("[USO_CANVAS] serialize() - image",r,":",n.description,"- markers:",i.items.length),{id:n.id,imageUrl:n.imageUrl,description:n.description,jaw:n.jaw,canMark:n.canMark,canDraw:n.canDraw,type:n.type,items:i.items,meta:i.meta}});(n[a]?.meta||{}).mid=Z()/t;const r={v:3,images:n,activeImageIndex:a,workMode:i};return o.log("[USO_CANVAS] serialize() v3 - saved",l.length,"images"),r}function se(e,t,n){let o=null;if("point"===e.t){const r=(e.cx||0)*t,i=(e.cy||0)*t,l=(e.radius||4)*t;o=new fabric.Circle({left:r-l,top:i-l,radius:l,fill:x[e.m]||"#1565FF",stroke:"white_dot"===e.m?"#000":"transparent",strokeWidth:"white_dot"===e.m?1:0,originX:"left",originY:"top",selectable:!0,evented:!0}),o.set("markerType",e.m),o._norm={rN:l/n,factor:e.sz||1},o._lastSizeVal=e.sz||1}else if("cross"===e.t){const n=(e.cx||0)*t,r=(e.cy||0)*t,i=(e.width||20)*t,l=(e.height||20)*t,a=(e.strokeWidth||2)*t,s=new fabric.Line([-i/2,-l/2,i/2,l/2],{stroke:x[e.m]||"#1565FF",strokeWidth:a,strokeUniform:!0}),c=new fabric.Line([-i/2,l/2,i/2,-l/2],{stroke:x[e.m]||"#1565FF",strokeWidth:a,strokeUniform:!0});o=new fabric.Group([s,c],{left:n,top:r,originX:"center",originY:"center",selectable:!0,evented:!0}),e.ang&&o.set({angle:e.ang}),o.set("markerType",e.m),o._lastSizeVal=e.sz||1}else if("line"===e.t)o=new fabric.Line([e.x1*t,e.y1*t,e.x2*t,e.y2*t],{stroke:x[e.m]||"#1565FF",strokeWidth:(e.strokeWidth||3)*t,strokeUniform:!0,selectable:!0,evented:!0,originX:"left",originY:"top"}),e.ang&&o.set({angle:e.ang}),o.set("markerType",e.m),o._lastSizeVal=e.sz||1;else if("oval"===e.t){const n=(e.cx||0)*t,r=(e.cy||0)*t,i=(e.rx||10)*t,l=(e.ry||14)*t;o=new fabric.Ellipse({left:n-i,top:r-l,rx:i,ry:l,fill:"transparent",stroke:x[e.m]||"#1565FF",strokeWidth:(e.strokeWidth||2)*t,strokeUniform:!0,originX:"left",originY:"top",selectable:!0,evented:!0}),e.ang&&o.set({angle:e.ang}),o.set("markerType",e.m),o._lastSizeVal=e.sz||1,o._manuallyScaled=!!e.manual}else if("q"===e.t||"exc"===e.t){const n="q"===e.t?"?":"!",r=(e.cx||0)*t,i=(e.cy||0)*t,l=(e.fontSize||16)*t;o=new fabric.Text(n,{left:r,top:i,originX:"center",originY:"center",fontSize:l,fontWeight:"bold",fill:x[e.m]||"#1565FF",selectable:!0,evented:!0,textBaseline:"middle"}),e.ang&&o.set({angle:e.ang}),o.set("markerType",e.m),o._lastSizeVal=e.sz||1}else"free"===e.t&&Array.isArray(e.path)&&(o=new fabric.Path(e.path,{left:(e.left||0)*t,top:(e.top||0)*t,scaleX:(e.scaleX||1)*t,scaleY:(e.scaleY||1)*t,fill:"transparent",stroke:e.stroke||"#000",strokeWidth:(e.strokeWidth||3)*t,strokeUniform:!0,selectable:!0,evented:!0,originX:"left",originY:"top"}),o.set("markerType","free"),o._lastSizeVal=e.sz||1);return o}function ce(e){if(!e||!s)return;const t=s.getWidth(),n=s.getHeight();if(3===e.v&&Array.isArray(e.images))o.log("[USO_CANVAS] load() v3 - loading",e.images.length,"images"),e.images.forEach(function(e,r){const i=l[r];if(!i)return void console.warn("[USO_CANVAS] load() v3 - image index",r,"not found in current images");r===a&&i.markers.forEach(e=>s.remove(e)),i.markers.length=0;const c=function(e,t,n,o,r){if(!e||!e.markers||!t)return 0;const i=n&&n.w?n.w:o,l=(n&&n.h&&n.h,o/i);let a=0;return t.forEach(function(t){const n=se(t,l,r);n&&(e.markers.push(n),a++)}),a}(i,e.items||[],e.meta,t,n);o.log("[USO_CANVAS] load() v3 - image",r,":",i.description,"- loaded",c,"markers"),r===a&&i.markers.forEach(e=>s.add(e))}),s.requestRenderAll(),o.log("[USO_CANVAS] load() v3 completed - all images loaded");else if(Array.isArray(e.items)){o.log("[USO_CANVAS] load() v2 (legacy) - loading to current image");const r=e.meta&&e.meta.w?e.meta.w:t,i=e.meta&&e.meta.h?e.meta.h:n,l=t/r;o.log("[USO_CANVAS] load() v2 - canvas:",t,"x",n,"original:",r,"x",i,"scale:",l);const a=K();a.forEach(e=>s.remove(e)),a.length=0,e.items.forEach(function(e){const t=se(e,l,n);t&&(s.add(t),a.push(t))}),s.requestRenderAll(),o.log("[USO_CANVAS] load() v2 completed, loaded",a.length,"markers")}else console.warn("[USO_CANVAS] load() - unknown data format:",e)}function ue(){if(!s)return;const e=K();e.forEach(function(e){s.remove(e)}),e.length=0,h=null,s.requestRenderAll()}function de(e,t){if(!e||!s)return;const n=document.getElementById("uso-canvas-container"),o=Math.max(320,n.clientWidth||320),r=n.clientHeight||0,i=r>0?r:fe(n),l="function"==typeof e.getElement?e.getElement():e._element,a=l.naturalWidth||l.width,c=l.naturalHeight||l.height;if(!a||!c)return;const u=o/a,d=i/c;let f=Math.min(u,d);(!isFinite(f)||f<=0)&&(f=u||1);const m=Math.round(a*f),g=Math.round(c*f);if(s.setViewportTransform([1,0,0,1,0,0]),s.setZoom(1),s.clear(),e.set({left:0,top:0,scaleX:f,scaleY:f,selectable:!1,evented:!1,angle:0}),s.setWidth(m),s.setHeight(g),s.add(e),s.sendToBack(e),t){K().forEach(function(e){s.add(e)})}J(!0),D(),function(){if(!s)return;if(K().forEach($),p){const e=s.getWidth(),t=Z();p.set({x1:0,y1:t,x2:e,y2:t,left:0,top:t}),p.setCoords()}s.requestRenderAll()}(),s.requestRenderAll()}function fe(e){const t=(window.visualViewport&&window.visualViewport.height?window.visualViewport.height:window.innerHeight)-e.getBoundingClientRect().top-16;return Math.max(240,t)}function me(){if(s)try{const e=ae();if(!e||"object"!=typeof e){console.warn("[USO] Invalid snapshot, skipping resize");const e=l[a];return e&&e.bgImg&&de(e.bgImg,!1),void D()}if(!Array.isArray(e.items)){console.warn("[USO] Snapshot has no items array");const e=l[a];return e&&e.bgImg&&de(e.bgImg,!1),void D()}const t=l[a];t&&t.bgImg&&de(t.bgImg,!1),ce(e),D()}catch(e){console.error("[USO] Resize error:",e);try{const e=l[a];e&&e.bgImg&&de(e.bgImg,!1),D()}catch(e){console.error("[USO] Failed to recover from resize error:",e)}}}async function ge(e){return new Promise(function(t){try{if(e<0||e>=l.length)return console.error("[USO_CANVAS] Invalid image index for rendering:",e),void t(null);const n=l[e],r=Array.isArray(n.markers)?n.markers:[];o.log("[USO_CANVAS] Rendering image",e+1,":",n.description,"markers:",r.length),fabric.Image.fromURL(n.imageUrl,function(i){if(!i)return console.error("[USO_CANVAS] Failed to load image for rendering:",e),void t(null);try{const l="function"==typeof i.getElement?i.getElement():i._element,a=l.naturalWidth||l.width,c=l.naturalHeight||l.height;if(!a||!c)return console.error("[USO_CANVAS] Invalid image dimensions:",a,"x",c),void t(null);const u=new fabric.Canvas(null,{selection:!1,preserveObjectStacking:!0,renderOnAddRemove:!1});u.setWidth(a),u.setHeight(c),i.set({left:0,top:0,scaleX:1,scaleY:1,selectable:!1,evented:!1}),u.add(i),u.sendToBack(i);const d=s?s.getWidth():a;s&&s.getHeight();let f=d;if(!n.targetW||0===n.targetW){const h=document.getElementById("uso-canvas-container"),p=(h?Math.max(320,h.clientWidth||320):800)/a;f=Math.round(a*p)}const m=a/f;function g(e){if(e){e.selectable=!1,e.evented=!1;try{e.setCoords()}catch(e){}u.add(e)}}o.log("[USO_CANVAS] Rendering scale:",e,"natW:",a,"referenceW:",f,"k:",m.toFixed(3)),r.forEach(function(e){try{const t=e.markerType||"";function n(t){return/_line$/.test(t)?"line":/_oval$/.test(t)?"oval":/_x$/.test(t)?"cross":/_q$/.test(t)?"q":/_exc$/.test(t)?"exc":"free"===t||"path"===e.type?"free":"group"===e.type?"cross":"ellipse"===e.type?"oval":"line"===e.type?"line":"text"===e.type?"?"===e.text?"q":"!"===e.text?"exc":"text":"point"}const o=n(t);if("point"===o&&"circle"===e.type){const r=e.getCenterPoint(),i=(e.radius||4)*m,l=e.fill||x[t]||"#1565FF",a="white_dot"===t?"#000":e.stroke||"transparent",s="white_dot"===t?1:0;return void g(new fabric.Circle({left:r.x*m-i,top:r.y*m-i,radius:i,fill:l,stroke:a,strokeWidth:s,originX:"left",originY:"top",strokeUniform:!0,markerType:t}))}if("cross"===o&&"group"===e.type){const c=e.getScaledWidth()*m,u=e.getScaledHeight()*m,d=e.getCenterPoint(),f=e._objects?.[0]?.stroke||x[t]||"#1565FF",h=Math.max(2,(e._objects?.[0]?.strokeWidth||3)*m),p=new fabric.Line([-c/2,-u/2,c/2,u/2],{stroke:f,strokeWidth:h,strokeUniform:!0}),_=new fabric.Line([-c/2,u/2,c/2,-u/2],{stroke:f,strokeWidth:h,strokeUniform:!0}),v=new fabric.Group([p,_],{left:d.x*m,top:d.y*m,originX:"center",originY:"center"});return e.angle&&v.set({angle:e.angle}),v.set("markerType",t),void g(v)}if("line"===o&&"line"===e.type){const y=e.stroke||x[t]||"#1565FF",k=Math.max(2,(e.strokeWidth||3)*m),b=new fabric.Line([e.x1*m,e.y1*m,e.x2*m,e.y2*m],{stroke:y,strokeWidth:k,strokeUniform:!0,originX:"left",originY:"top"});return e.angle&&b.set({angle:e.angle}),b.set("markerType",t),void g(b)}if("oval"===o&&"ellipse"===e.type){const w=(e.rx||0)*(e.scaleX||1),S=(e.ry||0)*(e.scaleY||1),A=(e.left||0)+w,M=(e.top||0)+S,C=w*m,U=S*m,F=A*m-C,N=M*m-U,O=e.stroke||x[t]||"#1565FF",I=Math.max(2,(e.strokeWidth||2)*m),W=new fabric.Ellipse({left:F,top:N,rx:C,ry:U,fill:"transparent",stroke:O,strokeWidth:I,strokeUniform:!0,originX:"left",originY:"top"});return e.angle&&W.set({angle:e.angle}),W.set("markerType",t),void g(W)}if(("q"===o||"exc"===o)&&"text"===e.type){const E="q"===o?"?":"!",z=e.getCenterPoint(),V=Math.max(16,(e.fontSize||16)*m),q=e.fill||x[t]||"#1565FF",T=new fabric.Text(E,{left:z.x*m,top:z.y*m,originX:"center",originY:"center",fontSize:V,fontWeight:"bold",fill:q});return e.angle&&T.set({angle:e.angle}),T.set("markerType",t),void g(T)}if("free"===o&&"path"===e.type){const j=new fabric.Path(e.path,{left:(e.left||0)*m,top:(e.top||0)*m,scaleX:(e.scaleX||1)*m,scaleY:(e.scaleY||1)*m,fill:"transparent",stroke:e.stroke||"#000",strokeWidth:Math.max(2,(e.strokeWidth||3)*m),strokeUniform:!0,originX:"left",originY:"top"});return j.set("markerType","free"),void g(j)}if(e.getCenterPoint){const P=e.getCenterPoint(),R=6,X=new fabric.Circle({left:P.x*m-R,top:P.y*m-R,radius:R,fill:x[t]||"#1565FF",originX:"left",originY:"top",strokeUniform:!0});X.set("markerType",t||"blue_dot"),g(X)}}catch(Y){console.warn("[USO_CANVAS] Marker rebuild error:",Y)}}),u.requestRenderAll(),setTimeout(function(){try{const e=u.toDataURL("image/png",{quality:.98});u.dispose(),t(e)}catch(e){console.error("[USO_CANVAS] Failed to export canvas:",e),u.dispose(),t(null)}},50)}catch(_){console.error("[USO_CANVAS] Error in renderImageWithMarkersToDataUrl:",_),t(null)}},{crossOrigin:"anonymous"})}catch(e){console.error("[USO_CANVAS] Unexpected error in renderImageWithMarkersToDataUrl:",e),t(null)}})}function he(e){const t={blue_x:0,blue_dot:0,ltblue_x:0,ltblue_dot:0,white_dot:0,white_line:0,yellow_line:0,yellow_dot:0,yellow_oval:0,violet_x:0,violet_dot:0,violet_line:0,violet_exc:0,violet_oval:0,green_line:0,green_dot:0,green_q:0,green_oval:0,green_exc:0,black_x:0,black_dot:0,black_exc:0,red_dot:0,red_q:0,red_oval:0,red_exc:0};return e.markers?(e.markers.forEach(e=>{const n=e.markerType;n&&t.hasOwnProperty(n)&&t[n]++}),t):t}function pe(){if(s&&!v)try{const e=ae();_.push(e),_.length>20&&_.shift(),t("#uso-undo").prop("disabled",_.length<=1)}catch(e){}}function _e(){if(s&&!(_.length<=1)){v=!0;try{_.pop();const e=_[_.length-1];if(e){const n=l[a];n&&n.bgImg&&de(n.bgImg,!1),ce(e),s.discardActiveObject(),t("#uso-del").prop("disabled",!0)}}finally{v=!1,t("#uso-undo").prop("disabled",_.length<=1)}}}function ve(e,t,n,o,r,i){const l=x[r]||"#1565FF",a=new fabric.Line([e,t,n,o],{stroke:l,strokeWidth:i||Math.max(2,Math.round(.0055*j()*L.line)),strokeUniform:!0,selectable:!0,evented:!0,originX:"left",originY:"top",perPixelTargetFind:!0});return a.set("markerType",r),a._norm={strokeN:(a.strokeWidth||3)/(j()||1),factor:1},a}function ye(e,t,n,o){const r=j();if(r<=0)return console.warn("[USO] Invalid canvas height:",r),null;const i=x[o]||"#1565FF";try{if("point"===e){const e=Math.max(4,Math.round(.011*r*L.point)),l=new fabric.Circle({left:t-e,top:n-e,radius:e,fill:i,stroke:"white_dot"===o?"#000":"transparent",strokeWidth:"white_dot"===o?1:0,originX:"left",originY:"top",selectable:!0,evented:!0});return l.set("markerType",o),l._norm={rN:e/r,factor:1},l._lastSizeVal=1,l}if("cross"===e){const e=Math.max(12,Math.round(.032*r*L.cross)),l=Math.max(2,Math.round(.0055*r*L.cross)),a=new fabric.Line([-e/2,-e/2,e/2,e/2],{stroke:i,strokeWidth:l,strokeUniform:!0}),s=new fabric.Line([-e/2,e/2,e/2,-e/2],{stroke:i,strokeWidth:l,strokeUniform:!0}),c=new fabric.Group([a,s],{left:t,top:n,originX:"center",originY:"center",selectable:!0,evented:!0});c.set("markerType",o);const u=c.getScaledWidth()/(c.scaleX||1);return c._norm={wN:u>0?u/r:.032,strokeN:l/r,factor:1},c._lastSizeVal=1,c}if("oval"===e){const e=Math.max(10,Math.round(.0198*r*L.oval)),l=Math.max(14,Math.round(.0286*r*L.oval)),a=Math.max(2,Math.round(.0055*r*L.oval)),s=new fabric.Ellipse({left:t-e,top:n-l,rx:e,ry:l,fill:"transparent",stroke:i,strokeWidth:a,strokeUniform:!0,originX:"left",originY:"top",selectable:!0,evented:!0});return s.set("markerType",o),s._norm={rxN:e/r,ryN:l/r,strokeN:a/r,cx:t,cy:n,factor:1},s._lastSizeVal=1,s}if("q"===e||"exc"===e){const l="q"===e?"?":"!",a=Math.max(16,Math.round(.032*r*1.4*L.text)),s=new fabric.Text(l,{left:t,top:n,originX:"center",originY:"center",fontSize:a,fontWeight:"bold",fill:i,selectable:!0,evented:!0,textBaseline:"middle"});return s.set("markerType",o),s._norm={fsN:a/r,factor:1},s._lastSizeVal=1,s}return console.warn("[USO] Unknown shape:",e),null}catch(t){return console.error("[USO] Failed to create shape:",e,t),null}}function ke(){if(!s)return;const e=s.getActiveObject();if(!e)return;const n=K();if("activeSelection"===e.type&&e._objects)e._objects.forEach(function(e){s.remove(e),n=n.filter(t=>t!==e)}),s.discardActiveObject();else{s.remove(e);const t=n.indexOf(e);t>-1&&n.splice(t,1)}s.requestRenderAll(),t("#uso-del").prop("disabled",!0),pe()}function be(e){if(!s)return;const t=s.getWidth(),n=s.getHeight();e.left=q(e.left,0,Math.max(0,t-e.getScaledWidth())),e.top=q(e.top,0,Math.max(0,n-e.getScaledHeight())),e.setCoords(),s.requestRenderAll()}function we(e){const t=y&&y.ratio||"free";if("free"===t)return;const n=t.split(":"),o=parseFloat(n[0]||"0"),r=parseFloat(n[1]||"0");if(!(o>0&&r>0))return;const i=o/r,l=e.width*e.scaleX,a=l/(e.height*e.scaleY);Math.abs(a-i)<.001||(e.scaleY=l/i/e.height)}function xe(){if(!y)return;y.rect&&s&&s.remove(y.rect);const e=y._prevMarking;y=null,u=!!e,te()}e.USO_CANVAS={MODES:r,initCanvas:function(e){if("undefined"==typeof fabric)return console.error("[USO] fabric.js not loaded"),null;try{if(!document.getElementById("uso-canvas"))return console.error("[USO] Canvas element #uso-canvas not found"),null;s=new fabric.Canvas("uso-canvas",{selection:!0,preserveObjectStacking:!0,renderOnAddRemove:!1}),c[0]=s,o.log("[USO] Canvas initialized successfully"),function(){const e=document.querySelector("#uso-calc-app .panel-controls");if(!e)return;const t=document.createElement("div");t.className="size-controls";const n=document.createElement("span");n.className="mini-label",n.textContent="Размер метки";const o=document.createElement("input");o.type="range",o.min="-2.0",o.max="2.0",o.step="0.01",o.value="0.00",o.id="marker-size",o.title="Размер метки",t.appendChild(n),t.appendChild(o),e.appendChild(t),X=o,o.addEventListener("input",function(e){const t=s.getActiveObject(),n=parseFloat(e.target.value||"0");t&&(H(t,n),t.setCoords(),s.requestRenderAll(),pe()),D()})}(),s&&s.on("mouse:wheel",function(e){if(u||d||y)return;const t=e.e||window.event;let n=s.getZoom();const o="number"==typeof t.deltaY?t.deltaY:0;n*=Math.pow(.999,o),n=Math.min(4,Math.max(.2,n));const r=s.upperCanvasEl.getBoundingClientRect(),i="number"==typeof t.clientX?t.clientX-r.left:t.offsetX||0,l="number"==typeof t.clientY?t.clientY-r.top:t.offsetY||0,a=new fabric.Point(i,l);s.zoomToPoint(a,n),t.preventDefault&&t.preventDefault(),t.stopPropagation&&t.stopPropagation(),s.requestRenderAll()}),function(){if(!s)return;let e=!1,t=null;s.on("mouse:down",function(n){if(u||d||y)return;if(n&&n.target)return;const o=n.e||window.event;e=!0,t={x:o.offsetX||0,y:o.offsetY||0},s.setCursor("grabbing")}),s.on("mouse:move",function(n){if(!e)return;const o=n.e||window.event,r=(o.offsetX||0)-t.x,i=(o.offsetY||0)-t.y,l=s.viewportTransform;l[4]+=r,l[5]+=i,t={x:o.offsetX||0,y:o.offsetY||0},s.requestRenderAll()}),s.on("mouse:up",function(){e=!1,t=null,s.setCursor("default")})}(),ee(),function(){const e=document.getElementById("uso-canvas-container");if(e&&"undefined"!=typeof ResizeObserver)try{k&&(k.disconnect(),k=null),k=new ResizeObserver(()=>{s&&(clearTimeout(b),b=setTimeout(()=>{window.requestAnimationFrame(()=>{try{me()}catch(e){console.error("[USO] Resize container error:",e)}})},500))}),k.observe(e)}catch(e){console.warn("[USO] ResizeObserver error:",e)}else t(window).on("resize orientationchange",n.util.throttle(function(){if(s)try{me()}catch(e){console.error("[USO] Resize error:",e)}},500))}(),t("#uso-exit-fs").on("click",function(){A()&&M().catch(function(){}),U&&E(),O(),V()}),t("#uso-fullscreen").on("click",z);const r=function(){V(),O()};document.addEventListener("fullscreenchange",r),document.addEventListener("webkitfullscreenchange",r),function(){const e=t("#img-rotate");e.length&&(e.off("click"),e.attr({title:"Средняя линия: смещение по вертикали","aria-pressed":"false"}).text("Ср. линия"),e.on("click",function(){G(!d)}))}(),t(".palette .color-btn").on("click",function(){t(".palette .color-btn").attr("aria-pressed","false").removeClass("active"),t(this).attr("aria-pressed","true").addClass("active"),m=this.getAttribute("data-color")||"blue",s&&D(),T(),P()}),t('.palette .color-btn[data-color="blue"]').addClass("active").attr("aria-pressed","true"),T(),P(),t(".palette .shape-btn").on("click",function(){t(".palette .shape-btn").attr("aria-pressed","false").removeClass("active"),t(this).attr("aria-pressed","true").addClass("active"),g=this.getAttribute("data-shape")||"point",s&&("free"===g?(D(),s.isDrawingMode=u&&!d&&!y):s.isDrawingMode=!1)}),t("#mark-toggle").on("click",function(){d&&G(!1),u=!u,t(this).attr("aria-pressed",u?"true":"false").toggleClass("primary",u),te()}),te(),D(),t("#uso-undo").on("click",_e),t("#uso-del").on("click",function(){ke(),e&&e()}),t(document).on("keydown.uso",function(n){if("Delete"!==n.key&&"Backspace"!==n.key)return;const o=n.target;o&&(o.isContentEditable||/^(input|textarea|select)$/i.test(o.tagName))||t(o).closest("#uso-calc-app").length&&(n.preventDefault(),ke(),e&&e())});let i=0;const f=300;s.on("mouse:down",function(t){if(!Q())return;if("free"===g)return;const n=Date.now();if(n-i<f)return;i=n;const o=s.getPointer(t.e),r=g||"point";if(t&&t.target)return;if("line"===r){const e=S(m,"line");if(!e)return;if(!h){const t=Math.max(2,Math.round(.0055*j()*L.line)),n=Math.max(10,Math.round(.022*j()*L.line)),r=Math.max(10,Math.round(.0165*j()*L.line));h={mode:"line",start:{x:o.x,y:o.y},lineObj:ve(o.x,o.y,o.x+n,o.y+r,e,t)},s.add(h.lineObj),s.discardActiveObject()}return}const l=S(m,r);if(!l)return;const a=ye(r,o.x,o.y,l);if(a){s.add(a);K().push(a),H(a,Y()),s.setActiveObject(a),s.requestRenderAll(),pe(),e&&e(),te()}}),s.on("mouse:move",function(e){if(h&&"line"===h.mode){const t=s.getPointer(e.e);h.lineObj.set({x2:t.x,y2:t.y}),h.lineObj.setCoords(),s.requestRenderAll()}}),s.on("mouse:up",function(){if(h&&"line"===h.mode){K().push(h.lineObj),s.setActiveObject(h.lineObj),H(h.lineObj,Y()),h=null,s.requestRenderAll(),pe(),e&&e(),te()}}),s.on("path:created",function(e){if(!Q())return void(e.path&&s.remove(e.path));const t=e.path;t.set({fill:"transparent",strokeUniform:!0,selectable:!0,evented:!0,originX:"left",originY:"top"}),t.set("markerType","free"),t._norm={strokeN:(t.strokeWidth||Math.round(.0055*j()))/j(),factor:1},s.setActiveObject(t),H(t,Y());K().push(t),pe()});const _=function(){const e=s.getActiveObject(),n=!!e;var o,r;t("#uso-del").prop("disabled",!n),e&&e._norm&&"number"==typeof e._norm.factor&&(r=e._norm.factor,o=Math.log2(Number(r||1)),X&&(X.value=String(o||0)))};return s.on("selection:created",_),s.on("selection:updated",_),s.on("selection:cleared",function(){t("#uso-del").prop("disabled",!0)}),s.on("object:moving",function(e){const t=e.target;if(!t)return;if(t===p){const e=s.getHeight(),n=s.getWidth(),o=q(t.getCenterPoint().y,0,e);return t.set({x1:0,y1:o,x2:n,y2:o,left:0,top:o}),t.setCoords(),void s.requestRenderAll()}if(y&&t===y.rect)return void be(t);const n=s.getWidth(),o=s.getHeight(),r=t.getBoundingRect(!0);let i=0,l=0;r.left<0&&(i=0-r.left),r.top<0&&(l=0-r.top),r.left+r.width>n-0&&(i=n-0-(r.left+r.width)),r.top+r.height>o-0&&(l=o-0-(r.top+r.height)),(i||l)&&(t.left=(t.left||0)+i,t.top=(t.top||0)+l,t.setCoords())}),s.on("object:scaling",function(e){if(!y||e.target!==y.rect){const t=e.target;return void(t&&"ellipse"===t.type&&(t._manuallyScaled=!0,t._absoluteSize={rx:t.rx*t.scaleX,ry:t.ry*t.scaleY,strokeWidth:t.strokeWidth}))}we(e.target),be(e.target)}),s.on("object:modified",function(){pe()}),s.on("mouse:dblclick",function(e){if(u||d||y)return;const t=e&&e.target,n=l[a],o=n?n.bgImg:null;t&&t!==o&&t!==p&&(s.setActiveObject(t),ke())}),t("#view-reset").on("click",function(){!function(){if(!s)return;const e=l[a];e&&e.bgImg&&de(e.bgImg,!0);s.requestRenderAll()}()}),t(window).on("resize orientationchange",n.util.throttle(O,150)),J(),G(!1),s}catch(e){return console.error("[USO] Canvas initialization error:",e),null}},getCounts:function(){return{blue_x:oe("blue_x"),blue_dot:oe("blue_dot"),ltblue_x:oe("ltblue_x"),ltblue_dot:oe("ltblue_dot"),white_dot:oe("white_dot"),white_line:oe("white_line"),yellow_line:oe("yellow_line"),yellow_dot:oe("yellow_dot"),yellow_oval:oe("yellow_oval"),violet_x:oe("violet_x"),violet_dot:oe("violet_dot"),violet_line:oe("violet_line"),violet_exc:oe("violet_exc"),violet_oval:oe("violet_oval"),green_line:oe("green_line"),green_dot:oe("green_dot"),green_q:oe("green_q"),green_oval:oe("green_oval"),green_exc:oe("green_exc"),black_x:oe("black_x"),black_dot:oe("black_dot"),black_exc:oe("black_exc"),red_dot:oe("red_dot"),red_q:oe("red_q"),red_oval:oe("red_oval"),red_exc:oe("red_exc")}},getCountsForCalculation:function(){if(o.log("[USO_CANVAS] getCountsForCalculation() - mode:",i),i===r.PANORAMIC){const e=l[0];if(!e)return{};const t=he(e);return o.log("[USO_CANVAS] PANORAMIC mode - using first image only:",t),t}if(i===r.SIMPLE){const e=l[0],t=l[1],n=e?he(e):{},r=t?he(t):{},i={};return new Set([...Object.keys(n),...Object.keys(r)]).forEach(e=>{i[e]=(n[e]||0)+(r[e]||0)}),o.log("[USO_CANVAS] SIMPLE mode - upper:",n,"lower:",r,"combined:",i),i}return{}},getJawSplitsForCalculation:function(){if(o.log("[USO_CANVAS] getJawSplitsForCalculation() - mode:",i),i===r.PANORAMIC){const e=l[0];if(!e)return{yellow:{topUnits:0,bottomUnits:0},white:{topUnits:0,bottomUnits:0},violet:{topUnits:0,bottomUnits:0},green:{topUnits:0,bottomUnits:0}};const t=function(e){const t=Z(),n={yellow:{topUnits:0,bottomUnits:0},white:{topUnits:0,bottomUnits:0},violet:{topUnits:0,bottomUnits:0},green:{topUnits:0,bottomUnits:0}};if(!e.markers)return n;const o={yellow_line:"yellow",white_line:"white",violet_line:"violet",green_line:"green"};return e.markers.forEach(e=>{const r=o[e.markerType];if(!r)return;(e.getCenterPoint?e.getCenterPoint():{x:0,y:0}).y<t?n[r].topUnits=1:n[r].bottomUnits=1}),n}(e);return o.log("[USO_CANVAS] PANORAMIC mode - jaw splits:",t),t}if(i===r.SIMPLE){const e=l[0],t=l[1],n={yellow:{topUnits:0,bottomUnits:0},white:{topUnits:0,bottomUnits:0},violet:{topUnits:0,bottomUnits:0},green:{topUnits:0,bottomUnits:0}};if(e&&e.markers){["yellow_line","white_line","violet_line","green_line"].forEach(t=>{const o=t.replace("_line","");e.markers.some(e=>e.markerType===t)&&(n[o].topUnits=1)})}if(t&&t.markers){["yellow_line","white_line","violet_line","green_line"].forEach(e=>{const o=e.replace("_line","");t.markers.some(t=>t.markerType===e)&&(n[o].bottomUnits=1)})}return o.log("[USO_CANVAS] SIMPLE mode - jaw splits:",n),n}return{yellow:{topUnits:0,bottomUnits:0},white:{topUnits:0,bottomUnits:0},violet:{topUnits:0,bottomUnits:0},green:{topUnits:0,bottomUnits:0}}},getJawSplits:function(){return{yellow:re("yellow_line"),white:re("white_line"),violet:re("violet_line"),green:re("green_line")}},serialize:ae,load:ce,resetMarkers:ue,canvasImage:function(){if(!s)return"";const e=p?!1!==p.visible:null;p&&p.set("visible",!1);const t=s.toDataURL("image/png");return p&&p.set("visible",e),t},hasImage:function(){return a>=0&&a<l.length&&!!l[a].bgImg},addMarker:function(e,t,n){if(!s||!e)return null;let o=null;const r=function(e){return e?/_line$/.test(e)?"line":/_oval$/.test(e)?"oval":/_x$/.test(e)?"cross":/_q$/.test(e)?"q":/_exc$/.test(e)?"exc":"free"===e?"free":"point":"point"}(String(e));if("line"===r){const r=Math.max(2,Math.round(.0055*j()*L.line));o=ve(t,n,t+Math.max(10,Math.round(.022*j()*L.line)),n+Math.max(10,Math.round(.0165*j()*L.line)),e,r)}else{if("free"===r)return null;o=ye(r,t,n,e)}if(o){s.add(o);K().push(o),H(o,Y()),s.setActiveObject(o),s.requestRenderAll(),pe&&pe()}return o},startCrop:function(e){if(!s)return;const t=l[a];if(!t||!t.bgImg)return;y&&xe();const n=u;u=!1,te();const o=s.getWidth(),r=s.getHeight(),i=Math.round(.8*o),c=Math.round(.8*r),d=new fabric.Rect({left:Math.round((o-i)/2),top:Math.round((r-c)/2),width:i,height:c,fill:"rgba(0,0,0,0.06)",stroke:"#1976d2",strokeWidth:2,hasBorders:!0,hasControls:!0,cornerColor:"#1976d2",transparentCorners:!1,lockRotation:!0,selectable:!0,evented:!0,objectCaching:!1});d.setControlsVisibility({mtr:!1}),s.add(d),s.bringToFront(d),s.setActiveObject(d),y={rect:d,ratio:e||"free",_prevMarking:n},s.requestRenderAll()},applyCrop:async function(){if(!y||!s)return;const e=l[a];if(!e||!e.bgImg)return;const t=y.rect,n="function"==typeof e.bgImg.getElement?e.bgImg.getElement():e.bgImg._element,o=n.naturalWidth||n.width,r=n.naturalHeight||n.height,i=Math.max(0,Math.round((t.left-(e.bgImg.left||0))/(e.bgImg.scaleX||1))),c=Math.max(0,Math.round((t.top-(e.bgImg.top||0))/(e.bgImg.scaleY||1))),d=Math.max(1,Math.round(t.getScaledWidth()/(e.bgImg.scaleX||1))),f=Math.max(1,Math.round(t.getScaledHeight()/(e.bgImg.scaleY||1))),m=q(i,0,o-1),g=q(c,0,r-1),h=q(d,1,o-m),p=q(f,1,r-g),_=document.createElement("canvas");_.width=h,_.height=p;const v=_.getContext("2d");v.imageSmoothingEnabled=!0,v.imageSmoothingQuality="high",v.drawImage(n,m,g,h,p,0,0,h,p);const k=_.toDataURL("image/png",.98);return new Promise(function(n){fabric.Image.fromURL(k,function(o){if(!o)return console.error("[USO] Failed to create cropped image"),void n();o.set({selectable:!1,evented:!1}),e.bgImg=o,ue(),de(o,!1),s.remove(t),y=null,u=!1,te(),pe();const r=document.getElementById("uso-canvas-container");r&&(r.style.resize="both",r.style.overflow="auto",r.style.minWidth=r.style.minWidth||"320px",r.style.minHeight=r.style.minHeight||"240px"),n()},{crossOrigin:"anonymous"})})},cancelCrop:xe,setCropRatio:function(e){y&&(y.ratio=e||"free",y.rect&&(we(y.rect),be(y.rect)))},setWorkMode:function(e){Object.values(r).includes(e)||(console.warn("[USO] Invalid work mode:",e,"Using PANORAMIC"),e=r.PANORAMIC),i=e,l=[],a=0,c={},o.log("[USO_CANVAS] Work mode set to:",e)},getWorkMode:function(){return i},addImage:function(e,t="Снимок",n=null){const a=function(e="panoramic"){return{id:Date.now()+Math.random(),imageUrl:null,type:e,description:"Снимок",markers:[],bgImg:null,canDraw:!0,canMark:!1,serialized:null,jaw:null,scale:1,targetW:0,targetH:0}}(i);return a.imageUrl=e,a.description=t,a.jaw=n,i===r.PANORAMIC?(a.canMark=l.length<3,a.canDraw=!0,a.description=`Панорамный снимок ${l.length+1}`,l.length>0&&(a.description+=1===l.length?" (2-й)":2===l.length?" (3-й)":" (доп.)")):i===r.SIMPLE&&(0===l.length?(a.canMark=!0,a.canDraw=!0,a.jaw="upper",a.description="👆 Верхняя челюсть"):1===l.length?(a.canMark=!0,a.canDraw=!0,a.jaw="lower",a.description="👇 Нижняя челюсть"):2===l.length?(a.canMark=!0,a.canDraw=!0,a.jaw=null,a.description="📎 Доп. снимок 1"):(a.canMark=!1,a.canDraw=!0,a.jaw=null,a.description="📎 Доп. снимок "+(l.length-1))),l.push(a),o.log("[USO_CANVAS] Image added:",a.description,"canMark:",a.canMark,"Total:",l.length),a},switchImage:ie,updateImageNavigation:le,getCurrentImage:function(){return l[a]||null},getAllImages:function(){return l.map((e,t)=>({index:t+1,description:e.description,jaw:e.jaw,imageUrl:e.imageUrl,serialized:e.serialized,workMode:i,canMark:e.canMark}))},renderImageWithMarkersToDataUrl:ge,getAllImagesForExport:async function(){o.log("[USO_CANVAS] getAllImagesForExport() called, total images:",l.length);const e=[];try{for(let t=0;t<l.length;t++){o.log("[USO_CANVAS] Processing image",t+1,"of",l.length);const n=await ge(t);e.push({index:t+1,description:l[t].description,jaw:l[t].jaw,imageUrl:n||l[t].imageUrl,serialized:l[t].serialized,workMode:i,canMark:l[t].canMark}),o.log("[USO_CANVAS] Image",t+1,"processed, has markers:",!!n)}}catch(e){console.error("[USO_CANVAS] Error during export processing:",e)}return o.log("[USO_CANVAS] getAllImagesForExport() completed, returned",e.length,"images"),e}},n.DEBUG_CANVAS=o,o.log("[USO_CANVAS] Module loaded. MODES:",r)}(window,jQuery);