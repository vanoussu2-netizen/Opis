!function(e,t){"use strict";e.USO||(e.USO={});const n=e.USO,o=n.ASSETS||{},i=n.OPT||{},a=n.CLINIC||{},r=n.DEBUG_CANVAS||{log:function(){},warn:function(...e){console.warn(...e)},error:function(...e){console.error(...e)}};async function l(){let t=e.jspdf&&e.jspdf.jsPDF||e.jsPDF||null;if(t)return t;try{return await s(o.vendor_jspdf||"https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"),t=e.jspdf&&e.jspdf.jsPDF||e.jsPDF||null,t||null}catch(e){return null}}async function d(){if("function"==typeof html2canvas||e.html2canvas&&"function"==typeof e.html2canvas)return"function"==typeof html2canvas?html2canvas:e.html2canvas;try{return await s(o.vendor_html2canvas||"https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"),"function"==typeof html2canvas?html2canvas:e.html2canvas}catch(e){return null}}function s(e){return new Promise(function(t,n){const o=document.createElement("script");o.src=e,o.async=!0,o.onload=t,o.onerror=n,document.head.appendChild(o)})}function c(e){return new Promise(function(t,n){const o=new Image;o.crossOrigin="anonymous",o.onload=function(){r.log("[USO_EXPORT] Image loaded"),t(o)},o.onerror=function(){console.error("[USO_EXPORT] Error loading image"),n(new Error("Failed to load image"))},o.src=e})}function g(e,t=.995){const n=e.getContext("2d"),{width:o,height:i}=e,a=.05*Math.min(o,i),l=Math.max(1,o-2*a),d=Math.max(1,i-2*a),s=n.getImageData(Math.floor(a),Math.floor(a),Math.floor(l),Math.floor(d)).data;let c=0,g=0;for(let e=0;e<s.length;e+=40){const t=s[e],n=s[e+1],o=s[e+2];t>250&&n>250&&o>250&&c++,g++}const m=c/g;return r&&r.log&&r.log("[BLANK_CHECK]","White:",(100*m).toFixed(1)+"%","Threshold:",100*t+"%","IsBlank:",m>t),m>t}function m(e,t){const n=e.getContext("2d"),o=e.width,i=e.height;n.fillStyle="#ffffff",n.fillRect(0,0,o,i),n.fillStyle="#666666",n.textAlign="center",n.textBaseline="middle";const a=Math.max(24,Math.floor(.03*i));n.font=`bold ${a}px Arial, sans-serif`,n.fillText("–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è",o/2,.4*i);const l=Math.max(16,Math.floor(.02*i));n.font=`${l}px Arial, sans-serif`,n.fillStyle="#999999",n.fillText("–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–∏–º–µ—á–∞–Ω–∏–π",o/2,.48*i),n.fillText("–∏–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –≤—Ä–∞—á–∞",o/2,.52*i),n.strokeStyle="#e0e0e0",n.lineWidth=1;const d=.6*i,s=.05*i,c=.6*o,g=(o-c)/2;for(let e=0;e<5;e++){const t=d+e*s;n.beginPath(),n.moveTo(g,t),n.lineTo(g+c,t),n.stroke()}r.log("[USO_EXPORT] Added placeholder text to blank page",t)}function u(e,t,n){const o=e.getContext("2d"),i=Math.min(t+n,e.height),a=Math.max(t+80,i-350),r=Math.min(e.height-1,i+350);let l=i,d=1/0;for(let t=a;t<=r;t++){const n=Math.min(5,e.height-t),i=o.getImageData(0,Math.max(0,t-Math.floor(n/2)),e.width,n).data;let a=0;for(let t=0;t<e.width;t+=3){const e=4*t,n=i[e],o=i[e+1],r=i[e+2];if((n<240||o<240||r<240)&&(a++,a>10))break}if(a<d&&(d=a,l=t,0===a))break}return l}async function h(e,r){const l=t("#uso-patient-name").val()||"",d=t("#uso-patient-phone").val()||"",s=n.util?n.util.maskPhone(d):"***",c=(new Date).toLocaleDateString("ru-RU"),g=o.logo_url||"",m=n.util?n.util.escapeHTML:function(e){const t=document.createElement("div");return t.textContent=String(e||""),t.innerHTML};let u="default"===r&&i.pdf_template_html||"";try{const e="alt"===r?o.pdf_template2_url:o.pdf_template_url;if((!u||u.length<=10)&&e&&"function"==typeof fetch){const t=await fetch(e,{credentials:"same-origin"});t.ok&&(u=await t.text())}}catch(e){}const h=[];h.push("@page { size: A4; margin: 0; }"),h.push("\n      *,*::before,*::after{box-sizing:border-box}\n      body{ \n        -webkit-print-color-adjust: exact; \n        print-color-adjust: exact;\n        font-family: Arial, Helvetica, sans-serif;\n      }\n      img{ display:block; max-width:100%; width:100%; height:auto; }\n      .section{ page-break-inside: avoid; margin: 10px 0 14px; }\n      .card{ page-break-inside: avoid; }\n      h1,h2,h3,h4{ page-break-after: avoid; margin: 12px 0 6px; }\n      p{ margin: 6px 0; }\n      ul{ margin: 6px 0 8px 18px; padding:0; }\n    ");const p="\n"+h.join("\n")+"\n";u=-1!==u.indexOf("</style>")?u.replace("</style>",p+"\n</style>"):-1!==u.indexOf("</head>")?u.replace("</head>","<style>"+p+"</style></head>"):"<style>"+p+"</style>"+u;let f=u||'<div style="padding:40px; font-family:Arial, Helvetica, sans-serif;">'+(e||"")+"</div>";return f=f.replace(/–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–∞—è –±–æ–ª—å–Ω–∏—Ü–∞\s+You-Ai[^<]*/gi,""),f=f.split("{{patient_name}}").join(m(l)),f=f.split("{{patient_phone}}").join(m(s)),f=f.split("{{patient_phone_masked}}").join(m(s)),f=f.split("{{calc_date}}").join(m(c)),f=f.split("{{license}}").join(m(a.license||"")),f=f.split("{{addr_heihe}}").join(m(a.addr_heihe||"")),f=f.split("{{addr_suif}}").join(m(a.addr_suif||"")),f=f.split("{{phone1}}").join(m(a.phone1||"")),f=f.split("{{phone2}}").join(m(a.phone2||"")),f=f.split("{{email}}").join(m(a.email||"")),f=f.split("{{site}}").join(m(a.site||"")),f=f.split("{{disclaimer}}").join(m(a.disclaimer||"")),f=f.split("{{variants_content}}").join(e||""),f=f.split("{{logo_url}}").join(m(g||"")),f=f.split("{{advertiser}}").join(m(a.advertiser||"")),f=f.split("{{ogrn}}").join(m(a.ogrn||"")),f}function g(e,t){if(t=t||.98,!e)return!0;const n=e.getContext("2d"),o=e.width,i=e.height;if(0===o||0===i)return!0;try{const e=n.getImageData(0,0,o,i).data,a=255*t,r=e.length/4,l=Math.min(1e4,r),d=Math.floor(r/l);for(let t=0;t<r;t+=d){const n=4*t,o=e[n],i=e[n+1],r=e[n+2];if(e[n+3]>10&&(o<a||i<a||r<a))return!1}return!0}catch(e){return r.error("[USO_EXPORT] Error checking canvas blank:",e),!1}}function u(e,t,n){if(!e)return t+n;const o=e.height;let i=Math.min(t+n,o);return i>=o-10?o:i}async function p(e,t,n,o=[]){r.log("[USO_EXPORT] buildPDFBlob started with",o.length,"images");const i=await l(),a=await d();if(!i||!a)throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ PDF");const s=await h(e,n),c=document.createElement("div");c.style.width="794px",c.innerHTML=s;const p=document.createElement("div");p.style.position="fixed",p.style.left="-10000px",p.style.top="0",p.style.width="794px",p.style.background="#fff",p.appendChild(c),document.body.appendChild(p),r.log("[USO_EXPORT] Rendering HTML to canvas...");const f=function(e,t){if(t=t||.98,!e)return e;const n=e.getContext("2d"),o=e.width,i=e.height;if(0===i||0===o)return e;try{const a=n.getImageData(0,0,o,i).data;let l=i-1;const d=255*t;r.log("[USO_EXPORT] Trimming canvas, original height:",i);for(let e=i-1;e>=0;e--){let t=!1;for(let n=0;n<o;n+=5){const i=4*(e*o+n),r=a[i],l=a[i+1],s=a[i+2];if(a[i+3]>10&&(r<d||l<d||s<d)){t=!0;break}}if(t){l=e;break}}const s=Math.min(i,l+50);if(s>=i-20)return r.log("[USO_EXPORT] No significant trimming needed"),e;r.log("[USO_EXPORT] Trimmed canvas from",i,"to",s,"px");const c=document.createElement("canvas");c.width=o,c.height=s;const g=c.getContext("2d");return g.fillStyle="#ffffff",g.fillRect(0,0,o,s),g.drawImage(e,0,0,o,s,0,0,o,s),c}catch(t){return r.error("[USO_EXPORT] Error trimming canvas:",t),e}}(await a(c,{scale:2,useCORS:!0,allowTaint:!0,backgroundColor:"#fff",logging:!1,imageTimeout:0}),.995);r.log("[USO_EXPORT] Canvas created:",f.width,"x",f.height);const O=new i("p","pt","a4"),P=O.internal.pageSize.getWidth(),x=O.internal.pageSize.getHeight(),w=P,b=w/f.width,y=Math.floor(x/b);let v=0,T=0,E=0;for(r.log("[USO_EXPORT] Splitting canvas into pages...");v<f.height&&E++<999;){const e=f.height-v;if(e<150){const t=document.createElement("canvas");t.width=f.width,t.height=e;const n=t.getContext("2d");n.fillStyle="#fff",n.fillRect(0,0,t.width,t.height),n.drawImage(f,0,v,f.width,e,0,0,t.width,t.height);const o=g(t,.995);o&&(r.log("[USO_EXPORT] Found blank tail at y="+v+", height="+e+" - adding placeholder text"),m(t,T+1));const i=t.toDataURL("image/jpeg",.95);T>0&&O.addPage(),O.addImage(i,"JPEG",0,0,w,e*b,void 0,"FAST"),T++,r.log("[USO_EXPORT] Added tail page",T,"blank:",o);break}const t=u(f,v,y);let n=Math.max(1,Math.min(t-v,f.height-v));n<150&&v+n<f.height&&(n=Math.min(150,f.height-v));const o=document.createElement("canvas");o.width=f.width,o.height=n;const i=o.getContext("2d");i.fillStyle="#fff",i.fillRect(0,0,o.width,o.height),i.drawImage(f,0,v,f.width,n,0,0,o.width,o.height),g(o,.995)&&(r.log("[USO_EXPORT] Found blank page at y="+v+", height="+n+" - adding placeholder text"),m(o,T+1));const a=o.toDataURL("image/jpeg",.95);T>0&&O.addPage(),O.addImage(a,"JPEG",0,0,w,n*b,void 0,"FAST"),v=t+1,T++,r.log("[USO_EXPORT] Added page",T,"at y="+(v-n)+", height="+n)}document.body.removeChild(p),0===T&&r.warn("[USO_EXPORT] Warning: No pages were added to PDF!");const U=O.output("blob"),S=(t||"otchet")+".pdf";return r.log("[USO_EXPORT] PDF created, pages:",T,"size:",Math.round(U.size/1024),"KB"),{blob:U,name:S,pageIndex:T}}async function f(e,t=[]){r.log("[USO_EXPORT] buildPDFFromImages started with",t.length,"images");const n=await l();if(!n)throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å jsPDF");const o=new n("p","pt","a4"),i=o.internal.pageSize.getWidth(),a=o.internal.pageSize.getHeight();if(r.log("[USO_EXPORT] PDF page size:",i,"x",a),!t||0===t.length){console.warn("[USO_EXPORT] No images to add to PDF");return{blob:o.output("blob"),name:(e||"otchet")+".pdf"}}const d=20,s=i-40,g=a-40-50;let m=!1;for(let e=0;e<t.length;e++){const n=t[e];if(n&&n.imageUrl)try{r.log("[USO_EXPORT] Adding image",e+1,"to PDF");const t=await c(n.imageUrl);if(!t||!t.width||!t.height){console.warn("[USO_EXPORT] Image",e+1,"failed to load or has invalid dimensions - skipping");continue}const a=t.width/t.height;let l=s,u=l/a;u>g&&(u=g,l=u*a);const h=d+(s-l)/2;let p=d;m&&(o.addPage(),r.log("[USO_EXPORT] Added new page for image",e+1)),m=!0;const f=document.createElement("canvas");f.width=i,f.height=40;const O=f.getContext("2d");O.fillStyle="#fff",O.fillRect(0,0,f.width,f.height),O.fillStyle="#2271b1",O.font="bold 14px Arial";const P=n.usedInCalculations||!1,x=P?" üìä":"";O.fillText("–°–Ω–∏–º–æ–∫ "+(e+1)+x,d,25),P&&(O.fillStyle="#666",O.font="10px Arial",O.fillText("(–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –¥–ª—è —Ä–∞—Å—á—ë—Ç–æ–≤)",d,38));const w=f.toDataURL("image/jpeg",.95);o.addImage(w,"JPEG",0,p,i,40),p+=50,o.addImage(n.imageUrl,"PNG",h,p,l,u),r.log("[USO_EXPORT] Image",e+1,"added successfully")}catch(t){console.error("[USO_EXPORT] Error adding image",e+1,":",t);continue}else console.warn("[USO_EXPORT] Image",e+1,"has no imageUrl - skipping")}const u=o.output("blob"),h=(e||"otchet")+".pdf";return r.log("[USO_EXPORT] PDF created from images, size:",Math.round(u.size/1024),"KB"),{blob:u,name:h}}async function O(t,n){r.log("[USO_EXPORT] mergePDFs started");const o=await async function(){if(e.PDFDocument)return r.log("[USO_EXPORT] PDFDocument already loaded"),e.PDFDocument;if(e.pdflibModule&&e.pdflibModule.PDFDocument)return r.log("[USO_EXPORT] PDFDocument found in pdflibModule"),e.PDFDocument=e.pdflibModule.PDFDocument,e.PDFDocument;try{const t="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js";if(r.log("[USO_EXPORT] Loading pdf-lib from CDN:",t),await s(t),e.PDFDocument)return r.log("[USO_EXPORT] PDFDocument loaded successfully"),e.PDFDocument;if(e.pdflibModule&&e.pdflibModule.PDFDocument)return r.log("[USO_EXPORT] PDFDocument found in pdflibModule"),e.PDFDocument=e.pdflibModule.PDFDocument,e.PDFDocument;for(let t in e)if(e[t]&&e[t].PDFDocument)return r.log("[USO_EXPORT] PDFDocument found in window."+t),e.PDFDocument=e[t].PDFDocument,e.PDFDocument;throw new Error("PDFDocument not found in any namespace")}catch(e){return console.error("[USO_EXPORT] Failed to load pdf-lib:",e),null}}();if(!o)throw new Error("pdf-lib not loaded");try{const e=await o.load(await t.arrayBuffer()),i=await o.load(await n.arrayBuffer());r.log("[USO_EXPORT] Text PDF pages:",e.getPageCount()),r.log("[USO_EXPORT] Images PDF pages:",i.getPageCount());(await e.copyPages(i,i.getPageIndices())).forEach(t=>e.addPage(t)),r.log("[USO_EXPORT] Merged PDF pages:",e.getPageCount());const a=await e.save(),l=new Blob([a],{type:"application/pdf"});return r.log("[USO_EXPORT] Merged PDF size:",Math.round(l.size/1024),"KB"),l}catch(e){throw console.error("[USO_EXPORT] mergePDFs error:",e),e}}function P(e){const o=(t("#uso-patient-name").val()||"").trim(),i=(t("#uso-patient-phone").val()||"").trim(),r=n.util?n.util.maskPhone(i):"***";return`\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n‚ïë                      –ü–õ–ê–ù –õ–ï–ß–ï–ù–ò–Ø                             ‚ïë\n‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n\n–î–∞—Ç–∞:                ${(new Date).toLocaleDateString("ru-RU")}\n–ü–∞—Ü–∏–µ–Ω—Ç:             ${o}\n–¢–µ–ª–µ—Ñ–æ–Ω:             ${r}\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n${(n.util?n.util.htmlToText:function(e){const t=document.createElement("div");return t.textContent=e,t.textContent})(e)}\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n–ö–û–ù–¢–ê–ö–¢–´ –ö–õ–ò–ù–ò–ö–ò\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n–ö–ª–∏–Ω–∏–∫–∞:             ${a.advertiser||"–£–°–û"}\n–õ–∏—Ü–µ–Ω–∑–∏—è:            ${a.license||"-"}\n–ê–¥—Ä–µ—Å (–•—ç–π—Ö—ç):       ${a.addr_heihe||"-"}\n–ê–¥—Ä–µ—Å (–°—É–π—Ñ—ç–Ω—å—Ö—ç):   ${a.addr_suif||"-"}\n–¢–µ–ª–µ—Ñ–æ–Ω 1:           ${a.phone1||"-"}\n–¢–µ–ª–µ—Ñ–æ–Ω 2:           ${a.phone2||"-"}\nE-mail:              ${a.email||"-"}\n–°–∞–π—Ç:                ${a.site||"-"}\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n${a.disclaimer||"–ò–º–µ—é—Ç—Å—è –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–∏—è, –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞."}\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n    `.trim()}function x(e,t){if(!e||0===e.size)return void console.error("[USO_EXPORT] Invalid blob for file:",t);r.log("[USO_EXPORT] downloadBlobFile:",t,"size:",Math.round(e.size/1024),"KB");const n=URL.createObjectURL(e),o=document.createElement("a");o.href=n,o.download=t,o.style.display="none",document.body.appendChild(o),setTimeout(()=>{o.click(),r.log("[USO_EXPORT] File clicked:",t),setTimeout(()=>{document.body.removeChild(o),URL.revokeObjectURL(n),r.log("[USO_EXPORT] Cleanup done for:",t)},500)},100)}function w(e){return new Promise(function(t){fetch(e).then(e=>e.blob()).then(e=>t(e)).catch(e=>{console.error("[USO_EXPORT] Error converting data URL to blob:",e),t(null)})})}async function b(t){r.log("[USO_EXPORT] renderImageWithMarkersToDataUrl:",t);const n=e.USO_CANVAS;if(!n||"function"!=typeof n.renderImageWithMarkersToDataUrl)return console.error("[USO_EXPORT] CANVAS.renderImageWithMarkersToDataUrl not available"),null;try{const e=await n.renderImageWithMarkersToDataUrl(t);return r.log("[USO_EXPORT] Got image with markers, size:",Math.round(e.length/1024),"KB"),e}catch(e){return console.error("[USO_EXPORT] Error rendering image with markers:",e),null}}async function y(e,t=4e3){r.log("[USO_EXPORT] splitPngIntoPages started");const n=await d();if(!n)return console.error("[USO_EXPORT] html2canvas not available"),[];const o=document.createElement("div");o.style.width="1200px",o.style.padding="40px",o.style.fontFamily="Arial, Helvetica, sans-serif",o.style.backgroundColor="#fff",o.innerHTML=e;const i=document.createElement("div");i.style.position="fixed",i.style.left="-10000px",i.style.top="0",i.style.width="1200px",i.style.background="#fff",i.appendChild(o),document.body.appendChild(i);try{const e=await n(o,{scale:2,useCORS:!0,allowTaint:!0,backgroundColor:"#fff",logging:!1,imageTimeout:0});r.log("[USO_EXPORT] Canvas created:",e.width,"x",e.height);const a=[];let l=0,d=1;for(;l<e.height;){const n=Math.min(t,e.height-l),o=document.createElement("canvas");o.width=e.width,o.height=n;const i=o.getContext("2d");i.fillStyle="#fff",i.fillRect(0,0,o.width,o.height),i.drawImage(e,0,l,e.width,n,0,0,o.width,n);const s=o.toDataURL("image/jpeg",.85);a.push({pageNum:d,dataUrl:s}),r.log("[USO_EXPORT] Page",d,"created"),l+=n,d++}return document.body.removeChild(i),a}catch(e){return console.error("[USO_EXPORT] Error splitting PNG:",e),document.body.removeChild(i),[]}}async function v(e){const n=(t("#uso-patient-name").val()||"").trim(),i=(t("#uso-patient-phone").val()||"").trim(),r=(new Date).toLocaleDateString("ru-RU"),l=function(e){const t=String(e||"").replace(/\D/g,"");return t.length<=6?"***"+t:"***"+t.slice(-6)}(i),d=o.logo_url||"";return`\n      <style>\n        * { box-sizing: border-box; }\n        body { \n          font-family: Arial, Helvetica, sans-serif;\n          -webkit-print-color-adjust: exact;\n          print-color-adjust: exact;\n          margin: 0;\n          padding: 0;\n        }\n        .header {\n          border-bottom: 3px solid #2271b1;\n          padding-bottom: 20px;\n          margin-bottom: 30px;\n        }\n        .header-logo {\n          max-width: 150px;\n          height: auto;\n          margin-bottom: 15px;\n        }\n        .header-title {\n          font-size: 28px;\n          font-weight: bold;\n          color: #2271b1;\n          margin: 0 0 10px 0;\n        }\n        .header-info {\n          display: grid;\n          grid-template-columns: 1fr 1fr;\n          gap: 20px;\n          font-size: 14px;\n          color: #333;\n        }\n        .header-info-item {\n          display: flex;\n          gap: 10px;\n        }\n        .header-info-label {\n          font-weight: bold;\n          min-width: 100px;\n        }\n        .content {\n          margin-bottom: 40px;\n        }\n        .section {\n          page-break-inside: avoid;\n          margin-bottom: 20px;\n        }\n        .footer {\n          border-top: 2px solid #ddd;\n          padding-top: 20px;\n          margin-top: 40px;\n          font-size: 12px;\n          color: #666;\n        }\n        .footer-section {\n          margin-bottom: 15px;\n        }\n        .footer-title {\n          font-weight: bold;\n          margin-bottom: 5px;\n        }\n        h1, h2, h3, h4 { \n          page-break-after: avoid;\n          margin: 20px 0 10px 0;\n          color: #2271b1;\n        }\n        p { margin: 8px 0; }\n        ul { margin: 8px 0 8px 20px; padding: 0; }\n        li { margin: 5px 0; }\n      </style>\n\n      <div class="header">\n        ${d?`<img src="${d}" class="header-logo" alt="Logo">`:""}\n        <div class="header-title">–ü–õ–ê–ù –õ–ï–ß–ï–ù–ò–Ø</div>\n        <div class="header-info">\n          <div class="header-info-item">\n            <span class="header-info-label">–î–∞—Ç–∞:</span>\n            <span>${r}</span>\n          </div>\n          <div class="header-info-item">\n            <span class="header-info-label">–ü–∞—Ü–∏–µ–Ω—Ç:</span>\n            <span>${n}</span>\n          </div>\n          <div class="header-info-item">\n            <span class="header-info-label">–¢–µ–ª–µ—Ñ–æ–Ω:</span>\n            <span>${l}</span>\n          </div>\n          <div class="header-info-item">\n            <span class="header-info-label">–ö–ª–∏–Ω–∏–∫–∞:</span>\n            <span>${a.advertiser||"–£–°–û"}</span>\n          </div>\n        </div>\n      </div>\n\n      <div class="content">\n        ${e}\n      </div>\n\n      <div class="footer">\n        <div class="footer-section">\n          <div class="footer-title">–ö–û–ù–¢–ê–ö–¢–´</div>\n          ${a.addr_heihe?`<div>–ê–¥—Ä–µ—Å (–•—ç–π—Ö—ç): ${a.addr_heihe}</div>`:""}\n          ${a.addr_suif?`<div>–ê–¥—Ä–µ—Å (–°—É–π—Ñ—ç–Ω—å—Ö—ç): ${a.addr_suif}</div>`:""}\n          ${a.phone1?`<div>–¢–µ–ª–µ—Ñ–æ–Ω: ${a.phone1}</div>`:""}\n          ${a.email?`<div>E-mail: ${a.email}</div>`:""}\n        </div>\n        <div class="footer-section">\n          <div>${a.disclaimer||"–ò–º–µ—é—Ç—Å—è –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–∏—è, –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞."}</div>\n        </div>\n      </div>\n    `}function T(e,t){return new Promise(function(n){const o=document.createElement("div");o.id="uso-download-confirm-modal",o.innerHTML=`\n        <div style="position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:100000;display:flex;align-items:center;justify-content:center;">\n          <div style="background:#fff;padding:24px;border-radius:8px;min-width:350px;text-align:center;">\n            <div style="font-size:18px;margin-bottom:12px;font-weight:bold;">üì• –°–Ω–∏–º–æ–∫ ${e}/${t}</div>\n            <div style="font-size:14px;color:#666;margin-bottom:20px;">\n              –°–Ω–∏–º–æ–∫ ${e} —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω.<br>\n              ${e<t?`–ù–∞–∂–º–∏—Ç–µ "–î–∞–ª–µ–µ" –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Å–Ω–∏–º–∫–∞ ${e+1}`:"–í—Å–µ —Å–Ω–∏–º–∫–∏ —Å–∫–∞—á–∞–Ω—ã!"}\n            </div>\n            <div style="display:flex;gap:10px;justify-content:center;">\n              ${e<t?'\n                <button id="uso-download-next" style="padding:10px 20px;background:#2271b1;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:14px;">\n                  –î–∞–ª–µ–µ ‚Üí\n                </button>\n              ':'\n                <button id="uso-download-done" style="padding:10px 20px;background:#4caf50;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:14px;">\n                  –ì–æ—Ç–æ–≤–æ ‚úì\n                </button>\n              '}\n            </div>\n          </div>\n        </div>\n      `,document.body.appendChild(o);const i=document.getElementById("uso-download-next"),a=document.getElementById("uso-download-done");i&&i.addEventListener("click",function(){document.body.removeChild(o),n()}),a&&a.addEventListener("click",function(){document.body.removeChild(o),n()})})}e.USO_EXPORT={exportPDF:async function(e,t,n,o=[]){r.log("[USO_EXPORT] exportPDF called");const i=document.createElement("div");i.id="uso-pdf-loader",i.innerHTML='\n      <div style="position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:99999;display:flex;align-items:center;justify-content:center;">\n        <div style="background:#fff;padding:24px;border-radius:8px;min-width:300px;">\n          <div style="font-size:16px;margin-bottom:12px;text-align:center;">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF...</div>\n          <div style="width:100%;height:4px;background:#e5e5e5;border-radius:2px;overflow:hidden;">\n            <div id="uso-pdf-progress" style="width:0%;height:100%;background:#2271b1;transition:width 0.3s;"></div>\n          </div>\n          <div id="uso-pdf-status" style="font-size:12px;color:#666;margin-top:8px;text-align:center;">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...</div>\n        </div>\n      </div>\n    ',document.body.appendChild(i);const a=document.getElementById("uso-pdf-progress"),l=document.getElementById("uso-pdf-status");try{a.style.width="10%",l.textContent="–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞...";const i=await p(e,t,n,[]);if(r.log("[USO_EXPORT] Text PDF created"),a.style.width="50%",l.textContent="–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–Ω–∏–º–∫–æ–≤...",await new Promise(e=>setTimeout(e,200)),o&&o.length>0){a.style.width="70%",l.textContent="–°–±–æ—Ä–∫–∞ —Å–Ω–∏–º–∫–æ–≤ –≤ PDF...";const e=await f(t,o);r.log("[USO_EXPORT] Images PDF created"),a.style.width="85%",l.textContent="–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤...",await new Promise(e=>setTimeout(e,200));const n=await O(i.blob,e.blob);r.log("[USO_EXPORT] PDFs merged"),a.style.width="100%",l.textContent="–ì–æ—Ç–æ–≤–æ!",await new Promise(e=>setTimeout(e,300));const d=URL.createObjectURL(n),s=document.createElement("a");s.href=d,s.download=t+".pdf",document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(d),r.log("[USO_EXPORT] PDF exported successfully")}else{a.style.width="100%",l.textContent="–ì–æ—Ç–æ–≤–æ!",await new Promise(e=>setTimeout(e,300));const e=i.blob,t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download=i.name,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(t),r.log("[USO_EXPORT] Text-only PDF exported successfully")}}catch(e){console.error("[USO] PDF export error:",e),console.error("[USO] Error stack:",e.stack);let t="–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞";e.message&&(t=e.message),t.includes("jspdf")||t.includes("jsPDF")?t="–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É jsPDF. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.":t.includes("html2canvas")?t="–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É html2canvas. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.":t.includes("pdf-lib")&&(t="–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É pdf-lib –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ vendor/pdf-lib.min.js"),alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ PDF:\n\n"+t)}finally{setTimeout(()=>{i&&i.parentNode&&document.body.removeChild(i)},500)}},buildPDFHtml:h,buildPDFBlob:p,buildPDFFromImages:f,mergePDFs:O,exportAsFiles:async function(t,n,o=[]){r.log("[USO_EXPORT] exportAsFiles called with",o.length,"images");const i=document.createElement("div");i.id="uso-export-loader",i.innerHTML='\n      <div style="position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:99999;display:flex;align-items:center;justify-content:center;">\n        <div style="background:#fff;padding:24px;border-radius:8px;min-width:350px;">\n          <div style="font-size:16px;margin-bottom:12px;text-align:center;">–≠–∫—Å–ø–æ—Ä—Ç —Ñ–∞–π–ª–æ–≤...</div>\n          <div style="width:100%;height:6px;background:#e5e5e5;border-radius:3px;overflow:hidden;margin-bottom:8px;">\n            <div id="uso-export-progress" style="width:0%;height:100%;background:#2271b1;transition:width 0.3s;"></div>\n          </div>\n          <div id="uso-export-status" style="font-size:12px;color:#666;text-align:center;">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...</div>\n          <div id="uso-export-percent" style="font-size:14px;font-weight:bold;color:#2271b1;text-align:center;margin-top:8px;">0%</div>\n        </div>\n      </div>\n    ',document.body.appendChild(i);const a=document.getElementById("uso-export-progress"),l=document.getElementById("uso-export-status"),d=document.getElementById("uso-export-percent");function s(e,t){a.style.width=e+"%",d.textContent=Math.round(e)+"%",l.textContent=t,r.log("[USO_EXPORT] Progress:",Math.round(e)+"%","-",t)}try{s(0,"–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞..."),await new Promise(e=>setTimeout(e,100));!function(e,t){if(!e)return void console.error("[USO_EXPORT] Empty content for file:",t);r.log("[USO_EXPORT] downloadTextFile:",t,"size:",Math.round(e.length/1024),"KB");const n=new Blob(["\ufeff"+e],{type:"text/plain;charset=utf-8"}),o=URL.createObjectURL(n),i=document.createElement("a");i.href=o,i.download=t,i.style.display="none",document.body.appendChild(i),setTimeout(()=>{i.click(),r.log("[USO_EXPORT] File clicked:",t),setTimeout(()=>{document.body.removeChild(i),URL.revokeObjectURL(o),r.log("[USO_EXPORT] Cleanup done for:",t)},500)},100)}(P(t),n+".txt"),r.log("[USO_EXPORT] TXT exported"),await new Promise(e=>setTimeout(e,1e3)),s(5,"–°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ PNG..."),await new Promise(e=>setTimeout(e,200));const i=await v(t),a=await y(i,4e3);r.log("[USO_EXPORT] Summary pages created:",a.length);let l=5;const d=30/(a.length||1);for(let e=0;e<a.length;e++){const t=a[e],o=a.length>1?`${n}_summary_${t.pageNum}.png`:`${n}_summary.png`;r.log("[USO_EXPORT] Converting summary page",t.pageNum,"to blob...");const i=await w(t.dataUrl);i&&i.size>0?(x(i,o),r.log("[USO_EXPORT] Summary PNG page",t.pageNum,"exported, size:",Math.round(i.size/1024),"KB")):console.warn("[USO_EXPORT] Summary page",t.pageNum,"blob is empty or null"),l+=d,s(l,`–≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á–µ—Ç–∞ (${t.pageNum}/${a.length})...`),await new Promise(e=>setTimeout(e,1200))}let c=35;if(o&&o.length>0){s(35,"–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–Ω–∏–º–∫–æ–≤..."),await new Promise(e=>setTimeout(e,200)),r.log("[USO_EXPORT] Starting image export, total:",o.length);const t=e.USO_CANVAS;for(let e=0;e<o.length;e++)try{r.log("[USO_EXPORT] Processing image",e+1,"of",o.length);let i=null;if(t&&"function"==typeof t.renderImageWithMarkersToDataUrl?(r.log("[USO_EXPORT] Rendering image",e+1,"with markers..."),i=await t.renderImageWithMarkersToDataUrl(e)):(console.warn("[USO_EXPORT] CANVAS.renderImageWithMarkersToDataUrl not available, using original image"),i=o[e].imageUrl),!i){console.warn("[USO_EXPORT] Image",e+1,"has no imageUrl"),c+=65/o.length,s(c,`–≠–∫—Å–ø–æ—Ä—Ç —Å–Ω–∏–º–∫–æ–≤ (${e+1}/${o.length})...`);continue}r.log("[USO_EXPORT] Converting image",e+1,"to blob...");const a=await w(i);if(a&&a.size>0){const t=`${n}_snimok_${e+1}.png`;r.log("[USO_EXPORT] Downloading snimok",e+1,":",t,"size:",Math.round(a.size/1024),"KB"),x(a,t),r.log("[USO_EXPORT] Snimok",e+1,"download initiated")}else console.warn("[USO_EXPORT] Blob is null or empty for image",e+1);c+=65/o.length,s(c,`–≠–∫—Å–ø–æ—Ä—Ç —Å–Ω–∏–º–∫–æ–≤ (${e+1}/${o.length})...`),e<o.length-1?(r.log("[USO_EXPORT] Showing confirmation modal for image",e+1),await T(e+1,o.length)):(r.log("[USO_EXPORT] Last image, waiting..."),await new Promise(e=>setTimeout(e,1500)))}catch(t){console.error("[USO_EXPORT] Error exporting image",e+1,":",t),c+=65/o.length,s(c,`–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ —Å–Ω–∏–º–∫–∞ ${e+1}`)}}else r.log("[USO_EXPORT] No images to export"),s(100,"–°–Ω–∏–º–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç");s(100,"–ì–æ—Ç–æ–≤–æ!"),r.log("[USO_EXPORT] All files exported successfully"),await new Promise(e=>setTimeout(e,500))}catch(e){console.error("[USO_EXPORT] Export error:",e),console.error("[USO_EXPORT] Error stack:",e.stack);let t="–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞";e.message&&(t=e.message),t.includes("html2canvas")?t="–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.":t.includes("canvas")?t="–û—à–∏–±–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É–ø—Ä–æ—Å—Ç–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ—Ç—á—ë—Ç–∞.":(t.includes("memory")||t.includes("heap"))&&(t="–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–∞–º—è—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–∫—Ä—ã—Ç—å –¥—Ä—É–≥–∏–µ –≤–∫–ª–∞–¥–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞."),alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ:\n\n"+t)}finally{setTimeout(()=>{i&&i.parentNode&&document.body.removeChild(i)},500)}},buildSummaryHtml:v,splitPngIntoPages:y,buildTextReport:P,getAllImagesWithMarkers:async function(){r.log("[USO_EXPORT] getAllImagesWithMarkers started");const t=e.USO_CANVAS;if(!t||"function"!=typeof t.getAllImagesForExport)return console.error("[USO_EXPORT] CANVAS.getAllImagesForExport not available"),t&&"function"==typeof t.getAllImages?(r.warn("[USO_EXPORT] Falling back to old getAllImages method"),await async function(){r.log("[USO_EXPORT] Using legacy getAllImagesWithMarkers");const t=e.USO_CANVAS;if(!t||"function"!=typeof t.getAllImages)return[];try{const e=t.getAllImages();r.log("[USO_EXPORT] Got",e.length,"images");const n=[],o=t.getCurrentImageIndex?t.getCurrentImageIndex():0;for(let o=0;o<e.length;o++)try{r.log("[USO_EXPORT] Processing image",o+1,"of",e.length),t.switchImage&&(await t.switchImage(o),await new Promise(e=>setTimeout(e,150)));const i=await b(o);i?(n.push({index:o,imageUrl:i,description:e[o].description||`–°–Ω–∏–º–æ–∫ ${o+1}`}),r.log("[USO_EXPORT] Image",o+1,"processed successfully")):console.warn("[USO_EXPORT] Failed to render image",o+1,"with markers")}catch(e){console.error("[USO_EXPORT] Error processing image",o+1,":",e);continue}return t.switchImage&&(await t.switchImage(o),await new Promise(e=>setTimeout(e,100))),r.log("[USO_EXPORT] Legacy method completed, got",n.length,"images"),n}catch(e){return console.error("[USO_EXPORT] Legacy getAllImagesWithMarkers error:",e),[]}}()):[];try{const e=await t.getAllImagesForExport();return r.log("[USO_EXPORT] getAllImagesForExport returned",e.length,"images"),e.map((e,t)=>({index:t,imageUrl:e.imageUrl,description:e.description||`–°–Ω–∏–º–æ–∫ ${t+1}`}))}catch(e){return console.error("[USO_EXPORT] getAllImagesWithMarkers error:",e),[]}},renderImageWithMarkersToDataUrl:b},r.log("[USO_EXPORT] Module loaded")}(window,jQuery);