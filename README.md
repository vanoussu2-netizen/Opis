# USO Teeth Calculator

Плагин WordPress для расчета стоимости стоматологических услуг с визуальной разметкой снимков.

## Описание

USO Teeth Calculator — это профессиональный инструмент для стоматологических клиник, который позволяет:
- Размечать снимки зубов (панорамные и отдельные челюсти)
- Рассчитывать стоимость различных типов работ (коронки, импланты, терапия, протезы)
- Создавать несколько вариантов плана лечения
- Экспортировать отчеты в PDF, TXT, PNG
- Сохранять и восстанавливать разметку через JSON

## Возможности

### Режимы работы
1. **PANORAMIC** — для панорамных снимков (один основной + дополнительные)
2. **SIMPLE** — для раздельных челюстей (верхняя + нижняя + дополнительные)

### Типы меток
- **Синие** (blue_x, blue_dot) — металлокерамика
- **Голубые** (ltblue_x, ltblue_dot) — безметалловая керамика
- **Фиолетовые** (violet_exc, violet_dot, violet_x, violet_oval) — импланты
- **Желтые** (yellow_dot, yellow_line, yellow_oval) — съемные протезы
- **Белые** (white_dot, white_line, white_oval) — бюгельные протезы
- **Зеленые** (green_dot, green_line, green_oval) — микропротезы
- **Черные** (black_x, black_dot, black_exc) — текущее состояние/удаление

### Экспорт
- **PDF** — полный отчет с расчетами и снимками
- **TXT** — текстовый отчет для быстрого просмотра
- **PNG** — снимки с разметкой и сводка
- **JSON** — сохранение разметки для повторного редактирования

## Установка

1. Загрузите папку `uso-teeth-calculator` в `/wp-content/plugins/`
2. Активируйте плагин в админ-панели WordPress
3. Создайте страницу с шорткодом `[uso_calculator]`

## Структура файлов

```
uso-teeth-calculator/
├── uso-teeth-calculator.php     # Главный файл плагина
├── templates/
│   ├── pdf-template2.html       # Шаблон для PDF экспорта
│   └── full.html                # Основной интерфейс
├── js/
│   ├── uso.canvas.js            # Canvas и управление метками
│   ├── uso.app.js               # Логика приложения и UI
│   ├── uso.calc.js              # Расчет стоимости услуг
│   └── uso.export.js            # Экспорт в PDF/TXT/PNG
├── css/
│   └── uso.style.css            # Стили интерфейса
└── vendor/
    └── exifer.umd.min.js        # Обработка EXIF для правильной ориентации фото
```

## Использование

### Базовый workflow

1. **Выбор режима**
   - Панорамный снимок → режим PANORAMIC
   - Отдельные челюсти → режим SIMPLE

2. **Загрузка снимков**
   - Нажмите "Добавить снимок" или перетащите файлы
   - Поддержка: JPG, PNG, HEIC
   - Автоматическое исправление ориентации по EXIF

3. **Разметка**
   - Выберите тип метки в панели инструментов
   - Кликните/рисуйте на снимке
   - Используйте колесико мыши для масштабирования меток

4. **Расчет**
   - Выберите материалы в правой панели
   - Система автоматически рассчитает стоимость
   - Создавайте варианты плана лечения

5. **Экспорт**
   - PDF — для печати и отправки пациенту
   - JSON — для сохранения и продолжения работы

### Горячие клавиши

- `Ctrl + Z` — отмена последнего действия
- `Ctrl + Shift + Z` — повтор отмененного действия
- `Delete` — удалить выделенную метку
- `Колесико мыши` — изменить размер выделенной метки
- `Ctrl + Колесико` — масштабирование canvas

### Debug режим

Для включения логирования в консоль:

```javascript
// В консоли браузера:
localStorage.setItem('uso_debug', 'true');
// Перезагрузите страницу
```

Или через PHP (добавьте в uso-teeth-calculator.php):

```php
'debug_mode' => true  // В массив USO_ASSETS
```

## API для разработчиков

### Canvas API

```javascript
const CANVAS = window.USO_CANVAS;

// Инициализация
CANVAS.initCanvas(onChangeCallback);

// Работа с изображениями
CANVAS.addImage(imageUrl, description, jaw);
CANVAS.switchImage(index);
CANVAS.getAllImages();

// Сериализация
const data = CANVAS.serialize(); // Сохранить метки
CANVAS.load(data);               // Загрузить метки

// Метки
CANVAS.getCounts();              // Количество меток по типам
CANVAS.resetMarkers();           // Очистить все метки
```

### Calc API

```javascript
const CALC = window.USO_CALC;

const result = CALC.compute(
  counts,          // Количество меток
  jawSplits,       // Распределение по челюстям
  selections,      // Выбранные материалы
  selectedMats     // Выбранные коронки на имплантах
);
```

### Export API

```javascript
const EXPORT = window.USO_EXPORT;

// PDF экспорт
await EXPORT.exportPDF(html, filename, reportType, images);

// Текстовый экспорт
const text = EXPORT.buildTextReport(html);
```

## Формат данных

### Сериализация v3 (текущая)

```json
{
  "v": 3,
  "workMode": "panoramic",
  "activeImageIndex": 0,
  "images": [
    {
      "id": 1234567890.123,
      "imageUrl": "data:image/png;base64,...",
      "description": "Панорамный снимок 1",
      "jaw": null,
      "canMark": true,
      "canDraw": true,
      "type": "panoramic",
      "items": [
        {
          "v": 2,
          "t": "point",
          "m": "blue_dot",
          "cx": 123.45,
          "cy": 234.56,
          "radius": 4,
          "sz": 1
        }
      ],
      "meta": {
        "w": 1920,
        "h": 1080
      }
    }
  ]
}
```

### Обратная совместимость

Плагин поддерживает загрузку старого формата v2:

```json
{
  "v": 2,
  "items": [...],
  "meta": { "w": 1920, "h": 1080, "mid": 0.5 }
}
```

## Технические детали

### Зависимости

**Обязательные:**
- WordPress 5.0+
- jQuery (включено в WordPress)

**Загружаются из CDN (с локальными fallback):**
- Fabric.js 5.3.0 — работа с canvas
- jsPDF 2.5.1 — генерация PDF
- html2canvas 1.4.1 — рендеринг HTML в canvas
- pdf-lib 1.17.1 — объединение PDF
- heic2any 0.0.4 — конвертация HEIC в PNG
- exifer (локально) — чтение EXIF для ориентации

### Производительность

- **Автосохранение** — каждые 30 секунд в localStorage
- **История отмены** — до 50 действий
- **Масштабирование** — аппаратное ускорение canvas
- **Ленивая загрузка** — библиотеки подгружаются по требованию

### Безопасность

- Sanitization всех пользовательских данных
- CORS для загрузки изображений
- Nonce для AJAX-запросов (если используются)
- Escape HTML перед выводом

## Решение проблем

### PDF не генерируется

1. Проверьте консоль браузера на ошибки
2. Убедитесь что CDN доступен
3. Попробуйте экспорт в TXT/PNG
4. Включите debug режим

### Метки теряются при переключении снимков

Проблема исправлена в версии с v:3 сериализацией. Обновите плагин.

### Неправильная ориентация фото

Убедитесь что:
- Файл `vendor/exifer.umd.min.js` существует
- В консоли нет ошибок загрузки EXIF библиотеки

### Долгая загрузка

1. Сжимайте изображения перед загрузкой (рекомендуется < 2MB)
2. Используйте современный браузер (Chrome, Firefox, Edge)
3. Очистите кэш браузера

## Changelog

### Версия текущая (2025)

**Исправлено:**
- Критическая ошибка потери меток в многоснимочном режиме
- Путь к pdf-template2.html после реорганизации
- Имя файла EXIF библиотеки
- Отсутствующая функция uso_update_option_noautoload

**Улучшено:**
- Новый формат сериализации v:3 с поддержкой множественных изображений
- Debug-система для контролируемого логирования
- Обратная совместимость со старым форматом v:2
- Удалены дубликаты файлов (сэкономлено 11 MB)

## Поддержка

При возникновении проблем:
1. Включите debug режим: `localStorage.setItem('uso_debug', 'true')`
2. Откройте консоль браузера (F12)
3. Воспроизведите проблему
4. Скопируйте логи из консоли

## Лицензия

Proprietary — для использования в стоматологических клиниках.

## Авторы

Разработка и поддержка: USO Development Team
