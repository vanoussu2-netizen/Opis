# Рефакторинг uso.canvas.js

## Обзор изменений

Файл `uso.canvas.js` (2786 строк) был разделен на модульную структуру для улучшения поддерживаемости, читаемости и тестируемости кода.

## Статус: ✅ В процессе (Фаза 1 завершена)

### Фаза 1: Извлечение базовых модулей ✅

Следующие модули были успешно извлечены из основного файла:

1. **uso.canvas.config.js** (164 строки)
   - Конфигурация, константы, цвета
   - Debug-система
   - Утилиты (hexToRgba, clamp)

2. **uso.canvas.fullscreen.js** (218 строк)
   - Управление полноэкранным режимом
   - Поддержка iOS (эмуляция)
   - Обработка viewport изменений

3. **uso.canvas.ui.js** (400 строк)
   - UI утилиты
   - Управление размерами маркеров
   - Элементы управления (слайдеры)
   - Масштабирование объектов

4. **uso.canvas.interactions.js** (300 строк)
   - Зум колесиком мыши
   - Перетаскивание (pan)
   - Сенсорные жесты (pinch zoom)
   - ResizeObserver

5. **uso.canvas.images.js** (240 строк)
   - Загрузка изображений
   - Работа с EXIF ориентацией
   - Подгонка к canvas

6. **uso.canvas.serialization.js** (364 строки)
   - Сериализация маркеров
   - Десериализация маркеров
   - Поддержка всех типов фигур

**Итого извлечено:** 1686 строк (~60% от оригинального файла)

## Изменения в файлах

### 1. uso-teeth-calculator.php
Обновлена секция регистрации скриптов для загрузки модулей в правильном порядке:

```php
// Старый код:
wp_register_script('uso-canvas', ...);

// Новый код:
wp_register_script('uso-canvas-config', ...);
wp_register_script('uso-canvas-fullscreen', ...);
wp_register_script('uso-canvas-ui', ...);
wp_register_script('uso-canvas-interactions', ...);
wp_register_script('uso-canvas-images', ...);
wp_register_script('uso-canvas-serialization', ...);
wp_register_script('uso-canvas', ...); // Зависит от всех модулей
```

### 2. Новые файлы
- `js/uso.canvas.config.js`
- `js/uso.canvas.fullscreen.js`
- `js/uso.canvas.ui.js`
- `js/uso.canvas.interactions.js`
- `js/uso.canvas.images.js`
- `js/uso.canvas.serialization.js`
- `js/MODULES.md` (документация модулей)
- `js/uso.canvas.js.backup` (резервная копия оригинала)

### 3. uso.canvas.js
**Статус:** Остается как есть с зависимостями от модулей

Файл теперь зависит от извлеченных модулей и использует их экспортированные функции через `window.USO.*`.

## Преимущества модульной структуры

1. **Улучшенная поддерживаемость** - Легче найти и исправить баги
2. **Лучшая читаемость** - Меньшие файлы, логическое группирование
3. **Простота тестирования** - Модули можно тестировать изолированно
4. **Переиспользование** - Модули можно использовать в других проектах
5. **Меньше конфликтов** - При командной разработке
6. **Оптимизация** - Возможность загружать только нужные модули

## Обратная совместимость

✅ **Полная обратная совместимость**

- Публичный API (`window.USO_CANVAS`) остается неизменным
- Все существующие функции доступны
- Никаких breaking changes

## Порядок загрузки модулей

Модули загружаются в следующем порядке (управляется WordPress зависимостями):

```
1. uso.canvas.config.js (базовая конфигурация)
   ↓
2. uso.canvas.fullscreen.js
   uso.canvas.ui.js
   uso.canvas.interactions.js
   uso.canvas.images.js
   uso.canvas.serialization.js (параллельно)
   ↓
3. uso.canvas.js (основной модуль)
```

## Тестирование

### Контрольный список тестирования:

- [ ] Загрузка страницы с калькулятором
- [ ] Загрузка изображений
- [ ] Добавление маркеров (точки, крестики, линии, овалы)
- [ ] Изменение размера маркеров (слайдер)
- [ ] Переключение между изображениями (вкладки)
- [ ] Полноэкранный режим
- [ ] Зум колесиком мыши
- [ ] Перетаскивание изображения
- [ ] Сенсорные жесты (на мобильных)
- [ ] Сохранение/загрузка состояния
- [ ] Экспорт в PDF
- [ ] Адаптивность (изменение размера окна)

## Известные проблемы

Нет (пока не обнаружено)

## Следующие шаги (Фаза 2)

1. **Создание минифицированных версий модулей**
   - Настройка системы сборки (webpack/rollup)
   - Создание uso.canvas.config.min.js и т.д.

2. **Дальнейшая модуляризация uso.canvas.js**
   - Извлечение логики управления состоянием
   - Извлечение функций работы с маркерами
   - Извлечение функций кроппинга
   - Извлечение функций подсчета и аналитики

3. **Оптимизация**
   - Анализ производительности
   - Удаление дублирующегося кода
   - Оптимизация рендеринга

4. **Тестирование**
   - Создание unit-тестов для модулей
   - Создание интеграционных тестов
   - E2E тестирование

5. **Документация**
   - JSDoc комментарии для всех функций
   - TypeScript определения
   - Примеры использования

## Контакты и поддержка

Вопросы и предложения по рефакторингу:
- GitHub Issues: [ссылка на репозиторий]
- Документация: `/js/MODULES.md`

## История изменений

### 2025-10-30
- ✅ Создана модульная структура (6 модулей)
- ✅ Обновлен uso-teeth-calculator.php для загрузки модулей
- ✅ Создана документация (MODULES.md, REFACTORING.md)
- ✅ Создана резервная копия оригинального файла

### Дата следующего обновления
TBD - После тестирования и обратной связи
