!function(t){"use strict";t.USO||(t.USO={});const o=t.USO,n=o.MATERIALS||{},i=o.PRICES||{},e=o.DEBUG_CANVAS||{log:function(){},warn:function(...t){console.warn(...t)},error:function(...t){console.error(...t)}};function m(t,o){return(t||[]).find(t=>t.admin_key===o)}function s(t,o){const i=m(n[t],o);return i?Number(i.price||0):0}t.USO_CALC={compute:function(t,o,l,r){t&&"object"==typeof t||(console.warn("[USO_CALC] Invalid cnt:",t),t={}),o&&"object"==typeof o||(console.warn("[USO_CALC] Invalid jawSplits:",o),o={yellow:{topUnits:0,bottomUnits:0},white:{topUnits:0,bottomUnits:0},violet:{topUnits:0,bottomUnits:0},green:{topUnits:0,bottomUnits:0}}),l&&"object"==typeof l||(console.warn("[USO_CALC] Invalid selections:",l),l={}),r&&"object"==typeof r||(console.warn("[USO_CALC] Invalid selectedMats:",r),r={}),e.log("[USO_CALC] compute() called with:",{cntKeys:Object.keys(t),jawSplitsKeys:Object.keys(o),selectionsKeys:Object.keys(l),selectedMatsKeys:Object.keys(r)});const a=(t.blue_x||0)+(t.blue_dot||0)+(t.black_x||0)+(t.black_dot||0),p=(t.white_dot||0)>0,c=a+(p&&t.white_dot||0),u=(t.ltblue_x||0)+(t.ltblue_dot||0);e.log("[USO_CALC] Crowns calculation:",{baseCore:a,incWhite:p,units_mc:c,units_zr:u});const b={};(n.mc||[]).forEach(t=>{b[t.admin_key]=c*Number(t.price||0)}),(n.zr||[]).forEach(t=>{b[t.admin_key]=u*Number(t.price||0)});let U=0;[["red_dot","t_red_dot"],["red_q","t_red_q"],["red_oval","t_red_oval"],["green_q","t_green_q"],["green_dot","t_green_dot"],["yellow_dot","t_fill"],["yellow_oval","t_build"],["black_exc","t_post"]].forEach(([o,n])=>{const m=t[o]||0,s=i[n]||0;U+=m*s,m>0&&e.log("[USO_CALC] Therapy:",o,"count:",m,"price:",s,"sum:",m*s)}),e.log("[USO_CALC] Total therapy:",U);const _=o.yellow||{topUnits:0,bottomUnits:0},S=o.white||{topUnits:0,bottomUnits:0},C=o.violet||{topUnits:0,bottomUnits:0},d=o.green||{topUnits:0,bottomUnits:0};e.log("[USO_CALC] Jaw splits:",{yl:_,wl:S,vl:C,gl:d});const w=l?.prosthesisMulti||{top:{},bottom:{}},x=l?.prosthesis||{top:{},bottom:{}};function y(t,o){const n=Array.isArray(w[t]?.[o])?w[t][o]:[];if(n.length)return n;const i=x[t]?.[o];return i?[i]:[]}function h(t,o){if(!t||!o.length)return{min:0,max:0};const i=o.map(t=>{const o=m(n.prosthesis,t);return o?Number(o.price||0):0}).filter(t=>t>0).map(o=>o*t);return i.length?{min:Math.min(...i),max:Math.max(...i)}:{min:0,max:0}}const g=h(_.topUnits,y("top","yellow")),M=h(_.bottomUnits,y("bottom","yellow")),f=h(S.topUnits,y("top","white")),v=h(S.bottomUnits,y("bottom","white")),A=h(C.topUnits,y("top","violet")),O=h(C.bottomUnits,y("bottom","violet")),L=Number(n.prosthesis_micro&&n.prosthesis_micro.price||0),k={min:d.topUnits?L:0,max:d.topUnits?L:0},j={min:d.bottomUnits?L:0,max:d.bottomUnits?L:0},B=g.min+M.min+f.min+v.min+A.min+O.min+k.min+j.min,E=g.max+M.max+f.max+v.max+A.max+O.max+k.max+j.max;e.log("[USO_CALC] Prosthesis calculation:",{removableMin:B,removableMax:E});const I=t.violet_exc||0,N=t.violet_dot||0,q=t.violet_x||0,K=t.violet_oval||0,z=I*s("implants",l.implBrand),T=Array.isArray(l.implCrown)?l.implCrown:l.implCrown?[l.implCrown]:[];let P=0;const R=[];T.forEach(t=>{const o=s("impl_crowns",t),n=N*o;R.push({key:t,price:o,units:N,sum:n}),P+=n});const W=q*s("impl_bridges",l.implBridge),D=K*Number(n.abutment&&n.abutment.price||0);e.log("[USO_CALC] Implants calculation:",{implCount:I,implCrownsCount:N,implBridgeCount:q,abutmentCount:K,implSetSum:z,implCrownsSum:P,implBridgeSum:W,abutmentSum:D});const F={cnt:t,baseCore:a,incWhite:p,units_mc:c,units_zr:u,therapy:U,col:b,prosthesis:{removableMin:B,removableMax:E,breakdown:{yellow:{topUnits:_.topUnits,bottomUnits:_.bottomUnits,topSumMin:g.min,botSumMin:M.min,topSumMax:g.max,botSumMax:M.max},white:{topUnits:S.topUnits,bottomUnits:S.bottomUnits,topSumMin:f.min,botSumMin:v.min,topSumMax:f.max,botSumMax:v.max},violet:{topUnits:C.topUnits,bottomUnits:C.bottomUnits,topSumMin:A.min,botSumMin:O.min,topSumMax:A.max,botSumMax:O.max},green:{topUnits:d.topUnits,bottomUnits:d.bottomUnits,topSumMin:k.min,botSumMin:j.min,topSumMax:k.max,botSumMax:j.max}}},implants:{implSetSum:z,implCrownsSum:P,implBridgeSum:W,abutmentSum:D,implCrownsBreakdown:R,implBrand:l.implBrand,implCrown:T,implBridge:l.implBridge}};return e.log("[USO_CALC] Final result:",F),F}}}(window,jQuery);