!function(e,t){"use strict";e.USO||(e.USO={});const n=e.USO,o=n.ASSETS||{},i=n.OPT||{},a=n.CLINIC||{},r=n.DEBUG_CANVAS||{log:function(){},warn:function(...e){console.warn(...e)},error:function(...e){console.error(...e)}};async function l(){let t=e.jspdf&&e.jspdf.jsPDF||e.jsPDF||null;if(t)return t;try{return await s(o.vendor_jspdf||"https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"),t=e.jspdf&&e.jspdf.jsPDF||e.jsPDF||null,t||null}catch(e){return null}}async function d(){if("function"==typeof html2canvas||e.html2canvas&&"function"==typeof e.html2canvas)return"function"==typeof html2canvas?html2canvas:e.html2canvas;try{return await s(o.vendor_html2canvas||"https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"),"function"==typeof html2canvas?html2canvas:e.html2canvas}catch(e){return null}}function s(e){return new Promise(function(t,n){const o=document.createElement("script");o.src=e,o.async=!0,o.onload=t,o.onerror=n,document.head.appendChild(o)})}function c(e){return new Promise(function(t,n){const o=new Image;o.crossOrigin="anonymous",o.onload=function(){r.log("[USO_EXPORT] Image loaded"),t(o)},o.onerror=function(){console.error("[USO_EXPORT] Error loading image"),n(new Error("Failed to load image"))},o.src=e})}function g(e,t=.995){const n=e.getContext("2d"),{width:o,height:i}=e,a=.05*Math.min(o,i),l=Math.max(1,o-2*a),d=Math.max(1,i-2*a),s=n.getImageData(Math.floor(a),Math.floor(a),Math.floor(l),Math.floor(d)).data;let c=0;const g=l*d;for(let e=0;e<s.length;e+=4){const t=s[e],n=s[e+1],o=s[e+2];t>250&&n>250&&o>250&&c++}const m=c/g;return r&&r.log&&r.log("[BLANK_CHECK]","White:",(100*m).toFixed(1)+"%","Threshold:",100*t+"%","IsBlank:",m>t),m>t}function m(e,t){const n=e.getContext("2d"),o=e.width,i=e.height;n.fillStyle="#ffffff",n.fillRect(0,0,o,i),n.fillStyle="#666666",n.textAlign="center",n.textBaseline="middle";const a=Math.max(24,Math.floor(.03*i));n.font=`bold ${a}px Arial, sans-serif`,n.fillText("Дополнительная информация",o/2,.4*i);const l=Math.max(16,Math.floor(.02*i));n.font=`${l}px Arial, sans-serif`,n.fillStyle="#999999",n.fillText("Эта страница оставлена для дополнительных примечаний",o/2,.48*i),n.fillText("или комментариев врача",o/2,.52*i),n.strokeStyle="#e0e0e0",n.lineWidth=1;const d=.6*i,s=.05*i,c=.6*o,g=(o-c)/2;for(let e=0;e<5;e++){const t=d+e*s;n.beginPath(),n.moveTo(g,t),n.lineTo(g+c,t),n.stroke()}r.log("[USO_EXPORT] Added placeholder text to blank page",t)}function u(e,t,n){const o=e.getContext("2d"),i=Math.min(t+n,e.height),a=Math.max(t+80,i-350),r=Math.min(e.height-1,i+350);let l=i,d=1/0;for(let t=a;t<=r;t++){const n=Math.min(5,e.height-t),i=o.getImageData(0,Math.max(0,t-Math.floor(n/2)),e.width,n).data;let a=0;for(let t=0;t<e.width;t+=3){const e=4*t,n=i[e],o=i[e+1],r=i[e+2];if((n<240||o<240||r<240)&&(a++,a>10))break}if(a<d&&(d=a,l=t,0===a))break}return l}async function h(e,n){const r=t("#uso-patient-name").val()||"",l=t("#uso-patient-phone").val()||"",d=(new Date).toLocaleDateString("ru-RU"),s=function(e){const t=String(e||"").replace(/\D/g,"");return t.length<=6?"***"+t:"***"+t.slice(-6)}(l),c=o.logo_url||"",g=function(e){const t=document.createElement("div");return t.textContent=String(e||""),t.innerHTML};let m="default"===n&&i.pdf_template_html||"";try{const e="alt"===n?o.pdf_template2_url:o.pdf_template_url;if((!m||m.length<=10)&&e&&"function"==typeof fetch){const t=await fetch(e,{credentials:"same-origin"});t.ok&&(m=await t.text())}}catch(e){}const u=[];u.push("@page { size: A4; margin: 0; }"),u.push("\n      *,*::before,*::after{box-sizing:border-box}\n      body{ \n        -webkit-print-color-adjust: exact; \n        print-color-adjust: exact;\n        font-family: Arial, Helvetica, sans-serif;\n      }\n      img{ display:block; max-width:100%; width:100%; height:auto; }\n      .section{ page-break-inside: avoid; margin: 10px 0 14px; }\n      .card{ page-break-inside: avoid; }\n      h1,h2,h3,h4{ page-break-after: avoid; margin: 12px 0 6px; }\n      p{ margin: 6px 0; }\n      ul{ margin: 6px 0 8px 18px; padding:0; }\n    ");const h="\n"+u.join("\n")+"\n";m=-1!==m.indexOf("</style>")?m.replace("</style>",h+"\n</style>"):-1!==m.indexOf("</head>")?m.replace("</head>","<style>"+h+"</style></head>"):"<style>"+h+"</style>"+m;let p=m||'<div style="padding:40px; font-family:Arial, Helvetica, sans-serif;">'+(e||"")+"</div>";return p=p.replace(/Государственная больница\s+You-Ai[^<]*/gi,""),p=p.split("{{patient_name}}").join(g(r)),p=p.split("{{patient_phone}}").join(g(s)),p=p.split("{{patient_phone_masked}}").join(g(s)),p=p.split("{{calc_date}}").join(g(d)),p=p.split("{{license}}").join(a.license||""),p=p.split("{{addr_heihe}}").join(a.addr_heihe||""),p=p.split("{{addr_suif}}").join(a.addr_suif||""),p=p.split("{{phone1}}").join(a.phone1||""),p=p.split("{{phone2}}").join(a.phone2||""),p=p.split("{{email}}").join(a.email||""),p=p.split("{{site}}").join(a.site||""),p=p.split("{{disclaimer}}").join(a.disclaimer||""),p=p.split("{{variants_content}}").join(e||""),p=p.split("{{logo_url}}").join(c||""),p=p.split("{{advertiser}}").join(a.advertiser||""),p=p.split("{{ogrn}}").join(a.ogrn||""),p}async function p(e,t,n,o=[]){r.log("[USO_EXPORT] buildPDFBlob started with",o.length,"images");const i=await l(),a=await d();if(!i||!a)throw new Error("Не удалось загрузить библиотеки PDF");const s=await h(e,n),c=document.createElement("div");c.style.width="794px",c.innerHTML=s;const p=document.createElement("div");p.style.position="fixed",p.style.left="-10000px",p.style.top="0",p.style.width="794px",p.style.background="#fff",p.appendChild(c),document.body.appendChild(p),r.log("[USO_EXPORT] Rendering HTML to canvas...");const f=function(e,t=.995){const n=e.width,o=e.height,i=e.getContext("2d"),a=Math.min(8,o);let r=o-1;for(let e=o-1;e>=0;e-=a){const o=Math.min(a,e+1),l=i.getImageData(0,e-o+1,n,o).data;let d=0;const s=n*o;for(let e=0;e<l.length;e+=4){const t=l[e],n=l[e+1],o=l[e+2];t>250&&n>250&&o>250&&d++}if(d/s<t){r=e;break}}const l=Math.max(1,r+1);if(l<o){const t=document.createElement("canvas");return t.width=n,t.height=l,t.getContext("2d").drawImage(e,0,0),t}return e}(await a(c,{scale:2,useCORS:!0,allowTaint:!0,backgroundColor:"#fff",logging:!1,imageTimeout:0}),.995);r.log("[USO_EXPORT] Canvas created:",f.width,"x",f.height);const O=new i("p","pt","a4"),P=O.internal.pageSize.getWidth(),x=O.internal.pageSize.getHeight(),b=P,w=b/f.width,y=Math.floor(x/w);let v=0,T=0,E=0;for(r.log("[USO_EXPORT] Splitting canvas into pages...");v<f.height&&E++<999;){const e=f.height-v;if(e<150){const t=document.createElement("canvas");t.width=f.width,t.height=e;const n=t.getContext("2d");n.fillStyle="#fff",n.fillRect(0,0,t.width,t.height),n.drawImage(f,0,v,f.width,e,0,0,t.width,t.height);const o=g(t,.995);o&&(r.log("[USO_EXPORT] Found blank tail at y="+v+", height="+e+" - adding placeholder text"),m(t,T+1));const i=t.toDataURL("image/jpeg",.95);T>0&&O.addPage(),O.addImage(i,"JPEG",0,0,b,e*w,void 0,"FAST"),T++,r.log("[USO_EXPORT] Added tail page",T,"blank:",o);break}const t=u(f,v,y);let n=Math.max(1,Math.min(t-v,f.height-v));n<150&&v+n<f.height&&(n=Math.min(150,f.height-v));const o=document.createElement("canvas");o.width=f.width,o.height=n;const i=o.getContext("2d");i.fillStyle="#fff",i.fillRect(0,0,o.width,o.height),i.drawImage(f,0,v,f.width,n,0,0,o.width,o.height),g(o,.995)&&(r.log("[USO_EXPORT] Found blank page at y="+v+", height="+n+" - adding placeholder text"),m(o,T+1));const a=o.toDataURL("image/jpeg",.95);T>0&&O.addPage(),O.addImage(a,"JPEG",0,0,b,n*w,void 0,"FAST"),v=t+1,T++,r.log("[USO_EXPORT] Added page",T,"at y="+(v-n)+", height="+n)}document.body.removeChild(p),0===T&&r.warn("[USO_EXPORT] Warning: No pages were added to PDF!");const S=O.output("blob"),U=(t||"otchet")+".pdf";return r.log("[USO_EXPORT] PDF created, pages:",T,"size:",Math.round(S.size/1024),"KB"),{blob:S,name:U,pageIndex:T}}async function f(e,t=[]){r.log("[USO_EXPORT] buildPDFFromImages started with",t.length,"images");const n=await l();if(!n)throw new Error("Не удалось загрузить jsPDF");const o=new n("p","pt","a4"),i=o.internal.pageSize.getWidth(),a=o.internal.pageSize.getHeight();if(r.log("[USO_EXPORT] PDF page size:",i,"x",a),!t||0===t.length){console.warn("[USO_EXPORT] No images to add to PDF");return{blob:o.output("blob"),name:(e||"otchet")+".pdf"}}const d=20,s=i-40,g=a-40-50;for(let e=0;e<t.length;e++){const n=t[e];if(n&&n.imageUrl)try{r.log("[USO_EXPORT] Adding image",e+1,"to PDF"),e>0&&o.addPage();const t=await c(n.imageUrl),a=t.width/t.height;let l=s,m=l/a;m>g&&(m=g,l=m*a);const u=d+(s-l)/2;let h=d;const p=document.createElement("canvas");p.width=i,p.height=40;const f=p.getContext("2d");f.fillStyle="#fff",f.fillRect(0,0,p.width,p.height),f.fillStyle="#2271b1",f.font="bold 14px Arial";const O=e+1===1?" ✓":"";f.fillText("Снимок "+(e+1)+O,d,25),e+1===1&&(f.fillStyle="#666",f.font="10px Arial",f.fillText("(использован для расчётов)",d,38));const P=p.toDataURL("image/jpeg",.95);o.addImage(P,"JPEG",0,h,i,40),h+=50,o.addImage(n.imageUrl,"PNG",u,h,l,m),r.log("[USO_EXPORT] Image",e+1,"added successfully")}catch(t){console.error("[USO_EXPORT] Error adding image",e+1,":",t)}else console.warn("[USO_EXPORT] Image",e+1,"has no imageUrl")}const m=o.output("blob"),u=(e||"otchet")+".pdf";return r.log("[USO_EXPORT] PDF created from images, size:",Math.round(m.size/1024),"KB"),{blob:m,name:u}}async function O(t,n){r.log("[USO_EXPORT] mergePDFs started");const o=await async function(){if(e.PDFDocument)return r.log("[USO_EXPORT] PDFDocument already loaded"),e.PDFDocument;if(e.pdflibModule&&e.pdflibModule.PDFDocument)return r.log("[USO_EXPORT] PDFDocument found in pdflibModule"),e.PDFDocument=e.pdflibModule.PDFDocument,e.PDFDocument;try{const t="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js";if(r.log("[USO_EXPORT] Loading pdf-lib from CDN:",t),await s(t),e.PDFDocument)return r.log("[USO_EXPORT] PDFDocument loaded successfully"),e.PDFDocument;if(e.pdflibModule&&e.pdflibModule.PDFDocument)return r.log("[USO_EXPORT] PDFDocument found in pdflibModule"),e.PDFDocument=e.pdflibModule.PDFDocument,e.PDFDocument;for(let t in e)if(e[t]&&e[t].PDFDocument)return r.log("[USO_EXPORT] PDFDocument found in window."+t),e.PDFDocument=e[t].PDFDocument,e.PDFDocument;throw new Error("PDFDocument not found in any namespace")}catch(e){return console.error("[USO_EXPORT] Failed to load pdf-lib:",e),null}}();if(!o)throw new Error("pdf-lib not loaded");try{const e=await o.load(await t.arrayBuffer()),i=await o.load(await n.arrayBuffer());r.log("[USO_EXPORT] Text PDF pages:",e.getPageCount()),r.log("[USO_EXPORT] Images PDF pages:",i.getPageCount());(await e.copyPages(i,i.getPageIndices())).forEach(t=>e.addPage(t)),r.log("[USO_EXPORT] Merged PDF pages:",e.getPageCount());const a=await e.save(),l=new Blob([a],{type:"application/pdf"});return r.log("[USO_EXPORT] Merged PDF size:",Math.round(l.size/1024),"KB"),l}catch(e){throw console.error("[USO_EXPORT] mergePDFs error:",e),e}}function P(e){const t=document.createElement("div");t.innerHTML=e,t.querySelectorAll("br").forEach(e=>e.replaceWith("\n")),t.querySelectorAll("li").forEach(e=>{const t=e.textContent.trim();e.replaceWith(document.createTextNode("• "+t+"\n"))}),t.querySelectorAll("img, script, style").forEach(e=>e.remove());let n=t.innerText||t.textContent||"";return n=n.replace(/\n\s+\n/g,"\n\n"),n=n.replace(/[ \t]+/g," "),n=n.trim(),n}function x(e){const n=(t("#uso-patient-name").val()||"").trim(),o=(t("#uso-patient-phone").val()||"").trim();return`\n╔════════════════════════════════════════════════════════════════╗\n║                      ПЛАН ЛЕЧЕНИЯ                             ║\n╚════════════════════════════════════════════════════════════════╝\n\nДата:                ${(new Date).toLocaleDateString("ru-RU")}\nПациент:             ${n}\nТелефон:             ${function(e){const t=String(e||"").replace(/\D/g,"");return t.length<=6?"***"+t:"***"+t.slice(-6)}(o)}\n\n════════════════════════════════════════════════════════════════\n\n${P(e)}\n\n════════════════════════════════════════════════════════════════\n\nКОНТАКТЫ КЛИНИКИ\n────────────────────────────────────────────────────────────────\nКлиника:             ${a.advertiser||"УСО"}\nЛицензия:            ${a.license||"-"}\nАдрес (Хэйхэ):       ${a.addr_heihe||"-"}\nАдрес (Суйфэньхэ):   ${a.addr_suif||"-"}\nТелефон 1:           ${a.phone1||"-"}\nТелефон 2:           ${a.phone2||"-"}\nE-mail:              ${a.email||"-"}\nСайт:                ${a.site||"-"}\n\n════════════════════════════════════════════════════════════════\n\n${a.disclaimer||"Имеются противопоказания, необходима консультация специалиста."}\n\n════════════════════════════════════════════════════════════════\n    `.trim()}function b(e,t){if(!e||0===e.size)return void console.error("[USO_EXPORT] Invalid blob for file:",t);r.log("[USO_EXPORT] downloadBlobFile:",t,"size:",Math.round(e.size/1024),"KB");const n=URL.createObjectURL(e),o=document.createElement("a");o.href=n,o.download=t,o.style.display="none",document.body.appendChild(o),setTimeout(()=>{o.click(),r.log("[USO_EXPORT] File clicked:",t),setTimeout(()=>{document.body.removeChild(o),URL.revokeObjectURL(n),r.log("[USO_EXPORT] Cleanup done for:",t)},500)},100)}function w(e){return new Promise(function(t){fetch(e).then(e=>e.blob()).then(e=>t(e)).catch(e=>{console.error("[USO_EXPORT] Error converting data URL to blob:",e),t(null)})})}async function y(t){r.log("[USO_EXPORT] renderImageWithMarkersToDataUrl:",t);const n=e.USO_CANVAS;if(!n||"function"!=typeof n.renderImageWithMarkersToDataUrl)return console.error("[USO_EXPORT] CANVAS.renderImageWithMarkersToDataUrl not available"),null;try{const e=await n.renderImageWithMarkersToDataUrl(t);return r.log("[USO_EXPORT] Got image with markers, size:",Math.round(e.length/1024),"KB"),e}catch(e){return console.error("[USO_EXPORT] Error rendering image with markers:",e),null}}async function v(e,t=4e3){r.log("[USO_EXPORT] splitPngIntoPages started");const n=await d();if(!n)return console.error("[USO_EXPORT] html2canvas not available"),[];const o=document.createElement("div");o.style.width="1200px",o.style.padding="40px",o.style.fontFamily="Arial, Helvetica, sans-serif",o.style.backgroundColor="#fff",o.innerHTML=e;const i=document.createElement("div");i.style.position="fixed",i.style.left="-10000px",i.style.top="0",i.style.width="1200px",i.style.background="#fff",i.appendChild(o),document.body.appendChild(i);try{const e=await n(o,{scale:2,useCORS:!0,allowTaint:!0,backgroundColor:"#fff",logging:!1,imageTimeout:0});r.log("[USO_EXPORT] Canvas created:",e.width,"x",e.height);const a=[];let l=0,d=1;for(;l<e.height;){const n=Math.min(t,e.height-l),o=document.createElement("canvas");o.width=e.width,o.height=n;const i=o.getContext("2d");i.fillStyle="#fff",i.fillRect(0,0,o.width,o.height),i.drawImage(e,0,l,e.width,n,0,0,o.width,n);const s=o.toDataURL("image/jpeg",.85);a.push({pageNum:d,dataUrl:s}),r.log("[USO_EXPORT] Page",d,"created"),l+=n,d++}return document.body.removeChild(i),a}catch(e){return console.error("[USO_EXPORT] Error splitting PNG:",e),document.body.removeChild(i),[]}}async function T(e){const n=(t("#uso-patient-name").val()||"").trim(),i=(t("#uso-patient-phone").val()||"").trim(),r=(new Date).toLocaleDateString("ru-RU"),l=function(e){const t=String(e||"").replace(/\D/g,"");return t.length<=6?"***"+t:"***"+t.slice(-6)}(i),d=o.logo_url||"";return`\n      <style>\n        * { box-sizing: border-box; }\n        body { \n          font-family: Arial, Helvetica, sans-serif;\n          -webkit-print-color-adjust: exact;\n          print-color-adjust: exact;\n          margin: 0;\n          padding: 0;\n        }\n        .header {\n          border-bottom: 3px solid #2271b1;\n          padding-bottom: 20px;\n          margin-bottom: 30px;\n        }\n        .header-logo {\n          max-width: 150px;\n          height: auto;\n          margin-bottom: 15px;\n        }\n        .header-title {\n          font-size: 28px;\n          font-weight: bold;\n          color: #2271b1;\n          margin: 0 0 10px 0;\n        }\n        .header-info {\n          display: grid;\n          grid-template-columns: 1fr 1fr;\n          gap: 20px;\n          font-size: 14px;\n          color: #333;\n        }\n        .header-info-item {\n          display: flex;\n          gap: 10px;\n        }\n        .header-info-label {\n          font-weight: bold;\n          min-width: 100px;\n        }\n        .content {\n          margin-bottom: 40px;\n        }\n        .section {\n          page-break-inside: avoid;\n          margin-bottom: 20px;\n        }\n        .footer {\n          border-top: 2px solid #ddd;\n          padding-top: 20px;\n          margin-top: 40px;\n          font-size: 12px;\n          color: #666;\n        }\n        .footer-section {\n          margin-bottom: 15px;\n        }\n        .footer-title {\n          font-weight: bold;\n          margin-bottom: 5px;\n        }\n        h1, h2, h3, h4 { \n          page-break-after: avoid;\n          margin: 20px 0 10px 0;\n          color: #2271b1;\n        }\n        p { margin: 8px 0; }\n        ul { margin: 8px 0 8px 20px; padding: 0; }\n        li { margin: 5px 0; }\n      </style>\n\n      <div class="header">\n        ${d?`<img src="${d}" class="header-logo" alt="Logo">`:""}\n        <div class="header-title">ПЛАН ЛЕЧЕНИЯ</div>\n        <div class="header-info">\n          <div class="header-info-item">\n            <span class="header-info-label">Дата:</span>\n            <span>${r}</span>\n          </div>\n          <div class="header-info-item">\n            <span class="header-info-label">Пациент:</span>\n            <span>${n}</span>\n          </div>\n          <div class="header-info-item">\n            <span class="header-info-label">Телефон:</span>\n            <span>${l}</span>\n          </div>\n          <div class="header-info-item">\n            <span class="header-info-label">Клиника:</span>\n            <span>${a.advertiser||"УСО"}</span>\n          </div>\n        </div>\n      </div>\n\n      <div class="content">\n        ${e}\n      </div>\n\n      <div class="footer">\n        <div class="footer-section">\n          <div class="footer-title">КОНТАКТЫ</div>\n          ${a.addr_heihe?`<div>Адрес (Хэйхэ): ${a.addr_heihe}</div>`:""}\n          ${a.addr_suif?`<div>Адрес (Суйфэньхэ): ${a.addr_suif}</div>`:""}\n          ${a.phone1?`<div>Телефон: ${a.phone1}</div>`:""}\n          ${a.email?`<div>E-mail: ${a.email}</div>`:""}\n        </div>\n        <div class="footer-section">\n          <div>${a.disclaimer||"Имеются противопоказания, необходима консультация специалиста."}</div>\n        </div>\n      </div>\n    `}function E(e,t){return new Promise(function(n){const o=document.createElement("div");o.id="uso-download-confirm-modal",o.innerHTML=`\n        <div style="position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:100000;display:flex;align-items:center;justify-content:center;">\n          <div style="background:#fff;padding:24px;border-radius:8px;min-width:350px;text-align:center;">\n            <div style="font-size:18px;margin-bottom:12px;font-weight:bold;">📥 Снимок ${e}/${t}</div>\n            <div style="font-size:14px;color:#666;margin-bottom:20px;">\n              Снимок ${e} успешно скачан.<br>\n              ${e<t?`Нажмите "Далее" для скачивания снимка ${e+1}`:"Все снимки скачаны!"}\n            </div>\n            <div style="display:flex;gap:10px;justify-content:center;">\n              ${e<t?'\n                <button id="uso-download-next" style="padding:10px 20px;background:#2271b1;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:14px;">\n                  Далее →\n                </button>\n              ':'\n                <button id="uso-download-done" style="padding:10px 20px;background:#4caf50;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:14px;">\n                  Готово ✓\n                </button>\n              '}\n            </div>\n          </div>\n        </div>\n      `,document.body.appendChild(o);const i=document.getElementById("uso-download-next"),a=document.getElementById("uso-download-done");i&&i.addEventListener("click",function(){document.body.removeChild(o),n()}),a&&a.addEventListener("click",function(){document.body.removeChild(o),n()})})}e.USO_EXPORT={exportPDF:async function(e,t,n,o=[]){r.log("[USO_EXPORT] exportPDF called");const i=document.createElement("div");i.id="uso-pdf-loader",i.innerHTML='\n      <div style="position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:99999;display:flex;align-items:center;justify-content:center;">\n        <div style="background:#fff;padding:24px;border-radius:8px;min-width:300px;">\n          <div style="font-size:16px;margin-bottom:12px;text-align:center;">Генерация PDF...</div>\n          <div style="width:100%;height:4px;background:#e5e5e5;border-radius:2px;overflow:hidden;">\n            <div id="uso-pdf-progress" style="width:0%;height:100%;background:#2271b1;transition:width 0.3s;"></div>\n          </div>\n          <div id="uso-pdf-status" style="font-size:12px;color:#666;margin-top:8px;text-align:center;">Подготовка...</div>\n        </div>\n      </div>\n    ',document.body.appendChild(i);const a=document.getElementById("uso-pdf-progress"),l=document.getElementById("uso-pdf-status");try{a.style.width="10%",l.textContent="Подготовка текста...";const i=await p(e,t,n,[]);if(r.log("[USO_EXPORT] Text PDF created"),a.style.width="50%",l.textContent="Подготовка снимков...",await new Promise(e=>setTimeout(e,200)),o&&o.length>0){a.style.width="70%",l.textContent="Сборка снимков в PDF...";const e=await f(t,o);r.log("[USO_EXPORT] Images PDF created"),a.style.width="85%",l.textContent="Объединение документов...",await new Promise(e=>setTimeout(e,200));const n=await O(i.blob,e.blob);r.log("[USO_EXPORT] PDFs merged"),a.style.width="100%",l.textContent="Готово!",await new Promise(e=>setTimeout(e,300));const d=URL.createObjectURL(n),s=document.createElement("a");s.href=d,s.download=t+".pdf",document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(d),r.log("[USO_EXPORT] PDF exported successfully")}else{a.style.width="100%",l.textContent="Готово!",await new Promise(e=>setTimeout(e,300));const e=i.blob,t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download=i.name,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(t),r.log("[USO_EXPORT] Text-only PDF exported successfully")}}catch(e){console.error("[USO] PDF export error:",e),console.error("[USO] Error stack:",e.stack);let t="Неизвестная ошибка";e.message&&(t=e.message),t.includes("jspdf")||t.includes("jsPDF")?t="Не удалось загрузить библиотеку jsPDF. Проверьте подключение к интернету.":t.includes("html2canvas")?t="Не удалось загрузить библиотеку html2canvas. Проверьте подключение к интернету.":t.includes("pdf-lib")&&(t="Не удалось загрузить библиотеку pdf-lib для объединения. Проверьте наличие файла vendor/pdf-lib.min.js"),alert("Ошибка при создании PDF:\n\n"+t)}finally{setTimeout(()=>{i&&i.parentNode&&document.body.removeChild(i)},500)}},buildPDFHtml:h,buildPDFBlob:p,buildPDFFromImages:f,mergePDFs:O,exportAsFiles:async function(t,n,o=[]){r.log("[USO_EXPORT] exportAsFiles called with",o.length,"images");const i=document.createElement("div");i.id="uso-export-loader",i.innerHTML='\n      <div style="position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:99999;display:flex;align-items:center;justify-content:center;">\n        <div style="background:#fff;padding:24px;border-radius:8px;min-width:350px;">\n          <div style="font-size:16px;margin-bottom:12px;text-align:center;">Экспорт файлов...</div>\n          <div style="width:100%;height:6px;background:#e5e5e5;border-radius:3px;overflow:hidden;margin-bottom:8px;">\n            <div id="uso-export-progress" style="width:0%;height:100%;background:#2271b1;transition:width 0.3s;"></div>\n          </div>\n          <div id="uso-export-status" style="font-size:12px;color:#666;text-align:center;">Подготовка...</div>\n          <div id="uso-export-percent" style="font-size:14px;font-weight:bold;color:#2271b1;text-align:center;margin-top:8px;">0%</div>\n        </div>\n      </div>\n    ',document.body.appendChild(i);const a=document.getElementById("uso-export-progress"),l=document.getElementById("uso-export-status"),d=document.getElementById("uso-export-percent");function s(e,t){a.style.width=e+"%",d.textContent=Math.round(e)+"%",l.textContent=t,r.log("[USO_EXPORT] Progress:",Math.round(e)+"%","-",t)}try{s(0,"Подготовка текстового отчета..."),await new Promise(e=>setTimeout(e,100));!function(e,t){if(!e)return void console.error("[USO_EXPORT] Empty content for file:",t);r.log("[USO_EXPORT] downloadTextFile:",t,"size:",Math.round(e.length/1024),"KB");const n=new Blob(["\ufeff"+e],{type:"text/plain;charset=utf-8"}),o=URL.createObjectURL(n),i=document.createElement("a");i.href=o,i.download=t,i.style.display="none",document.body.appendChild(i),setTimeout(()=>{i.click(),r.log("[USO_EXPORT] File clicked:",t),setTimeout(()=>{document.body.removeChild(i),URL.revokeObjectURL(o),r.log("[USO_EXPORT] Cleanup done for:",t)},500)},100)}(x(t),n+".txt"),r.log("[USO_EXPORT] TXT exported"),await new Promise(e=>setTimeout(e,1e3)),s(5,"Создание отчета в формате PNG..."),await new Promise(e=>setTimeout(e,200));const i=await T(t),a=await v(i,4e3);r.log("[USO_EXPORT] Summary pages created:",a.length);let l=5;const d=30/(a.length||1);for(let e=0;e<a.length;e++){const t=a[e],o=a.length>1?`${n}_summary_${t.pageNum}.png`:`${n}_summary.png`;r.log("[USO_EXPORT] Converting summary page",t.pageNum,"to blob...");const i=await w(t.dataUrl);i&&i.size>0?(b(i,o),r.log("[USO_EXPORT] Summary PNG page",t.pageNum,"exported, size:",Math.round(i.size/1024),"KB")):console.warn("[USO_EXPORT] Summary page",t.pageNum,"blob is empty or null"),l+=d,s(l,`Экспорт отчета (${t.pageNum}/${a.length})...`),await new Promise(e=>setTimeout(e,1200))}let c=35;if(o&&o.length>0){s(35,"Подготовка снимков..."),await new Promise(e=>setTimeout(e,200)),r.log("[USO_EXPORT] Starting image export, total:",o.length);const t=e.USO_CANVAS;for(let e=0;e<o.length;e++)try{r.log("[USO_EXPORT] Processing image",e+1,"of",o.length);let i=null;if(t&&"function"==typeof t.renderImageWithMarkersToDataUrl?(r.log("[USO_EXPORT] Rendering image",e+1,"with markers..."),i=await t.renderImageWithMarkersToDataUrl(e)):(console.warn("[USO_EXPORT] CANVAS.renderImageWithMarkersToDataUrl not available, using original image"),i=o[e].imageUrl),!i){console.warn("[USO_EXPORT] Image",e+1,"has no imageUrl"),c+=65/o.length,s(c,`Экспорт снимков (${e+1}/${o.length})...`);continue}r.log("[USO_EXPORT] Converting image",e+1,"to blob...");const a=await w(i);if(a&&a.size>0){const t=`${n}_snimok_${e+1}.png`;r.log("[USO_EXPORT] Downloading snimok",e+1,":",t,"size:",Math.round(a.size/1024),"KB"),b(a,t),r.log("[USO_EXPORT] Snimok",e+1,"download initiated")}else console.warn("[USO_EXPORT] Blob is null or empty for image",e+1);c+=65/o.length,s(c,`Экспорт снимков (${e+1}/${o.length})...`),e<o.length-1?(r.log("[USO_EXPORT] Showing confirmation modal for image",e+1),await E(e+1,o.length)):(r.log("[USO_EXPORT] Last image, waiting..."),await new Promise(e=>setTimeout(e,1500)))}catch(t){console.error("[USO_EXPORT] Error exporting image",e+1,":",t),c+=65/o.length,s(c,`Ошибка при экспорте снимка ${e+1}`)}}else r.log("[USO_EXPORT] No images to export"),s(100,"Снимки отсутствуют");s(100,"Готово!"),r.log("[USO_EXPORT] All files exported successfully"),await new Promise(e=>setTimeout(e,500))}catch(e){console.error("[USO_EXPORT] Export error:",e),console.error("[USO_EXPORT] Error stack:",e.stack);let t="Неизвестная ошибка";e.message&&(t=e.message),t.includes("html2canvas")?t="Не удалось загрузить библиотеку для рендеринга. Проверьте подключение к интернету.":t.includes("canvas")?t="Ошибка рендеринга. Попробуйте упростить содержимое отчёта.":(t.includes("memory")||t.includes("heap"))&&(t="Недостаточно памяти. Попробуйте закрыть другие вкладки браузера."),alert("Ошибка при экспорте:\n\n"+t)}finally{setTimeout(()=>{i&&i.parentNode&&document.body.removeChild(i)},500)}},buildSummaryHtml:T,splitPngIntoPages:v,htmlToText:P,buildTextReport:x,getAllImagesWithMarkers:async function(){r.log("[USO_EXPORT] getAllImagesWithMarkers started");const t=e.USO_CANVAS;if(!t||"function"!=typeof t.getAllImages)return console.error("[USO_EXPORT] CANVAS.getAllImages not available"),[];try{const e=t.getAllImages();r.log("[USO_EXPORT] Got",e.length,"images");const n=[],o=t.getCurrentImageIndex?t.getCurrentImageIndex():0;for(let o=0;o<e.length;o++)try{r.log("[USO_EXPORT] Processing image",o+1,"of",e.length),t.switchImage&&(t.switchImage(o),await new Promise(e=>setTimeout(e,150)));const i=await y(o);i?(n.push({index:o,imageUrl:i,description:e[o].description||`Снимок ${o+1}`}),r.log("[USO_EXPORT] Image",o+1,"processed successfully")):console.warn("[USO_EXPORT] Failed to render image",o+1,"with markers")}catch(e){console.error("[USO_EXPORT] Error processing image",o+1,":",e);continue}return t.switchImage&&(t.switchImage(o),await new Promise(e=>setTimeout(e,100))),r.log("[USO_EXPORT] getAllImagesWithMarkers completed, got",n.length,"images"),n}catch(e){return console.error("[USO_EXPORT] getAllImagesWithMarkers error:",e),[]}},renderImageWithMarkersToDataUrl:y},r.log("[USO_EXPORT] Module loaded")}(window,jQuery);